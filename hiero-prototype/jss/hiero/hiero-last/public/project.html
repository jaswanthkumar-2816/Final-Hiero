<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project - Hiero</title>
  <script src="authCheck.js"></script>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="theme.css">
  <script src="theme.js"></script>
  <style>
    body {
      background: #0a0a0a;
      color: #12ef12;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    .project-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 16px 32px 16px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .user-stats {
      background: #18191c;
      border: 2px solid #12ef12;
      border-radius: 16px;
      box-shadow: 0 0 24px #12ef1233;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .user-stats h3 {
      color: #12ef12;
      margin: 0 0 15px 0;
      text-shadow: 0 0 10px #12ef12;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-item {
      background: #0a0a0a;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #12ef12;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #12ef12;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #fff;
      margin-top: 5px;
    }

    .project-title {
      font-size: 2.2rem;
      font-weight: 900;
      color: #12ef12;
      letter-spacing: 1px;
      margin-bottom: 8px;
      text-align: center;
    }

    .project-desc {
      color: #fff;
      font-size: 1.2rem;
      margin-bottom: 18px;
      text-align: center;
    }

    .project-completion {
      background: #18191c;
      border-radius: 16px;
      box-shadow: 0 0 24px #12ef1233;
      padding: 24px;
      margin: 20px auto;
      max-width: 600px;
      text-align: center;
    }

    .difficulty-selector {
      margin: 20px 0;
    }

    .difficulty-selector label {
      color: #12ef12;
      font-weight: 600;
      margin-right: 10px;
    }

    .difficulty-selector select {
      background: #0a0a0a;
      color: #12ef12;
      border: 2px solid #12ef12;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 1rem;
    }

    .complete-btn {
      background: linear-gradient(45deg, #12ef12, #0a9c0a);
      color: #0a0a0a;
      border: none;
      border-radius: 12px;
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 20px #12ef1233;
      margin-top: 15px;
    }

    .complete-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px #12ef12;
    }

    .complete-btn:disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .completion-status {
      margin: 15px 0;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
    }

    .completed {
      background: rgba(18, 239, 18, 0.2);
      color: #12ef12;
      border: 1px solid #12ef12;
    }

    .not-completed {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid #666;
    }

    .resources-section {
      background: #18191c;
      border-radius: 16px;
      box-shadow: 0 0 24px #12ef1233;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: flex-start;
      max-width: 600px;
      margin: 0 auto;
    }

    .resources-title {
      color: #12ef12;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .resource-link {
      color: #b0ffb0;
      font-size: 1.1rem;
      text-decoration: none;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: color 0.2s;
    }

    .resource-link:hover {
      color: #12ef12;
      text-decoration: underline;
    }

    .chatbot-section {
      background: #18191c;
      border-radius: 16px;
      box-shadow: 0 0 24px #12ef1233;
      padding: 24px;
      margin-top: 32px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      flex-direction: column;
      min-height: 220px;
    }

    .section-title {
      color: #12ef12;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
    }

    .chatbot-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
      color: #fff;
      font-size: 1rem;
      background: #101010;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #232c23;
      min-height: 80px;
    }

    .chatbot-input {
      display: flex;
      gap: 8px;
    }

    .chatbot-input input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.5px solid #12ef12;
      background: #101010;
      color: #fff;
      font-size: 1rem;
      outline: none;
    }

    .chatbot-input button {
      background: #12ef12;
      color: #101010;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      padding: 8px 18px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }

    .chatbot-input button:hover {
      background: #0a0a0a;
      color: #12ef12;
      border: 1.5px solid #12ef12;
    }

    @media (max-width: 600px) {
      .project-container {
        padding: 8px;
      }

      .resources-section,
      .chatbot-section {
        padding: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
    <i class="fas fa-sun"></i>
  </div>
  <div class="project-container" id="project-root">
    <!-- Project content will be rendered here by JS -->
  </div>
  <script>
    // Backend API configuration
    const API_BASE_URL = 'http://localhost:5005/api';
    const CHAT_API_URL = 'http://localhost:5005/api/ask';

    // Global variables
    let userStats = { totalPoints: 0, level: 1, badges: [], completedProjects: [] };

    // Project data mapping
    const projectData = {
      'Build a React App': {
        desc: 'Learn how to create and deploy a React app from scratch. This project will guide you through the basics of React, component structure, state management, and deployment.',
        difficulty: 'medium',
        resources: [
          { label: '‚ñ∂Ô∏è YouTube Tutorial', url: 'https://www.youtube.com/watch?v=bMknfKXIFA8' },
          { label: 'üíª GitHub Repo', url: 'https://github.com/facebook/react' },
          { label: 'üìÑ Official Documentation', url: 'https://react.dev/' }
        ]
      },
      'Deploy with Docker': {
        desc: 'Containerize and deploy your application using Docker. Learn Docker basics, image creation, and deployment strategies.',
        difficulty: 'hard',
        resources: [
          { label: '‚ñ∂Ô∏è YouTube Tutorial', url: 'https://www.youtube.com/watch?v=3c-iBn73dDE' },
          { label: 'üíª Example Repo', url: 'https://github.com/docker/getting-started' },
          { label: 'üìÑ Docker Docs', url: 'https://docs.docker.com/get-started/' }
        ]
      },
      'Create a GraphQL API': {
        desc: 'Build a GraphQL API from scratch. Learn schema design, resolvers, and how to connect your API to a database.',
        difficulty: 'hard',
        resources: [
          { label: '‚ñ∂Ô∏è YouTube Tutorial', url: 'https://www.youtube.com/watch?v=ed8SzALpx1Q' },
          { label: 'üíª Example Repo', url: 'https://github.com/howtographql/howtographql' },
          { label: 'üìÑ GraphQL Docs', url: 'https://graphql.org/learn/' }
        ]
      },
      'Build a Simple Portfolio': {
        desc: 'Create a responsive portfolio website to showcase your projects and skills. Learn HTML, CSS, and basic JavaScript.',
        difficulty: 'easy',
        resources: [
          { label: '‚ñ∂Ô∏è YouTube Tutorial', url: 'https://www.youtube.com/watch?v=xV7S8BhIeBo' },
          { label: 'üíª Example Repo', url: 'https://github.com/microsoft/Web-Dev-For-Beginners' },
          { label: 'üìÑ MDN Web Docs', url: 'https://developer.mozilla.org/en-US/docs/Learn' }
        ]
      },
      'Create a REST API': {
        desc: 'Build a RESTful API using Node.js and Express. Learn about routing, middleware, database integration, and API best practices.',
        difficulty: 'medium',
        resources: [
          { label: '‚ñ∂Ô∏è YouTube Tutorial', url: 'https://www.youtube.com/watch?v=fgTGADljAeg' },
          { label: 'üíª Example Repo', url: 'https://github.com/expressjs/express' },
          { label: 'üìÑ Express.js Docs', url: 'https://expressjs.com/' }
        ]
      }
    };

    // Initialize the application
    async function initializeApp() {
      try {
        // Fetch user stats
        await fetchUserStats();

        // Get and render project
        const selectedProject = getSelectedProject();
        if (selectedProject && projectData[selectedProject]) {
          renderProject(selectedProject);
        } else {
          // Show the first project as default if nothing selected
          const firstProject = Object.keys(projectData)[0];
          renderProject(firstProject);
        }
      } catch (error) {
        console.error('Error initializing app:', error);
        showError('Failed to load project data. Please try again.');
      }
    }

    // Fetch user stats
    async function fetchUserStats() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5005/api/scoring/user-stats', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (response.ok) {
          const data = await response.json();
          userStats = data.stats;
          updateUserStatsDisplay();
        }
      } catch (error) {
        console.error('Error fetching user stats:', error);
      }
    }

    // Update user stats display
    function updateUserStatsDisplay() {
      const existingStats = document.getElementById('user-stats');
      if (existingStats) {
        existingStats.remove();
      }

      const statsDiv = document.createElement('div');
      statsDiv.id = 'user-stats';
      statsDiv.className = 'user-stats';
      statsDiv.innerHTML = `
        <h3>üèÜ Your Progress</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">${userStats.level}</div>
            <div class="stat-label">Level</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${userStats.totalPoints}</div>
            <div class="stat-label">Total Points</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${userStats.projectsCount || 0}</div>
            <div class="stat-label">Projects</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${userStats.badges.length}</div>
            <div class="stat-label">Badges</div>
          </div>
        </div>
      `;

      const container = document.getElementById('project-root');
      container.insertBefore(statsDiv, container.firstChild);
    }

    // Complete project
    async function completeProject(projectName, difficulty) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5005/api/scoring/project-complete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            projectName: projectName,
            difficulty: difficulty
          })
        });

        if (response.ok) {
          const data = await response.json();
          userStats.totalPoints = data.totalPoints;
          userStats.level = data.level;
          userStats.badges = data.badges;

          updateUserStatsDisplay();
          showAchievement(data.message, data.leveledUp);

          // Update completion status
          updateProjectCompletionStatus(projectName, true);

          // Refresh user stats
          await fetchUserStats();
        } else {
          const errorData = await response.json();
          showError(errorData.error || 'Failed to complete project');
        }
      } catch (error) {
        console.error('Error completing project:', error);
        showError('Failed to complete project. Please try again.');
      }
    }

    // Check if project is completed
    function isProjectCompleted(projectName) {
      return userStats.completedProjects.some(p => p.projectName === projectName);
    }

    // Update project completion status
    function updateProjectCompletionStatus(projectName, isCompleted) {
      const statusDiv = document.getElementById('completion-status');
      const completeBtn = document.getElementById('complete-project-btn');

      if (statusDiv) {
        if (isCompleted) {
          statusDiv.className = 'completion-status completed';
          statusDiv.innerHTML = '‚úÖ Project Completed!';
          if (completeBtn) {
            completeBtn.disabled = true;
            completeBtn.textContent = 'Already Completed';
          }
        } else {
          statusDiv.className = 'completion-status not-completed';
          statusDiv.innerHTML = 'üìã Ready to complete this project?';
        }
      }
    }

    // Show achievement notification
    function showAchievement(message, leveledUp = false) {
      const achievementDiv = document.createElement('div');
      achievementDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(45deg, #12ef12, #0a9c0a);
        color: #0a0a0a;
        padding: 20px 30px;
        border-radius: 16px;
        font-weight: bold;
        font-size: 18px;
        z-index: 1000;
        box-shadow: 0 0 30px #12ef12;
        animation: fadeInUp 0.5s ease-out;
        text-align: center;
        max-width: 400px;
      `;

      let content = `üéâ ${message}`;
      if (leveledUp) content += `<br>üöÄ LEVEL UP!`;

      achievementDiv.innerHTML = content;
      document.body.appendChild(achievementDiv);

      setTimeout(() => {
        achievementDiv.remove();
      }, 3000);
    }

    // Show error notification
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ff4444;
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 0 20px #ff4444;
      `;
      errorDiv.textContent = message;
      document.body.appendChild(errorDiv);

      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Get project from query string or localStorage
    function getSelectedProject() {
      const params = new URLSearchParams(window.location.search);
      let project = params.get('project');
      if (!project) {
        project = localStorage.getItem('selectedProject');
      }
      return project;
    }

    function renderProject(projectName) {
      const root = document.getElementById('project-root');
      root.innerHTML = '';
      const data = projectData[projectName];
      if (!data) {
        root.innerHTML = `<div style='color:#fff;text-align:center;font-size:1.3rem;margin-top:2em;'>Project not found.<br><a href="result.html" style="color:#12ef12;text-decoration:underline;">Back to Results</a></div>`;
        return;
      }

      // Title
      const title = document.createElement('div');
      title.className = 'project-title';
      title.textContent = projectName;
      root.appendChild(title);

      // Description
      const desc = document.createElement('div');
      desc.className = 'project-desc';
      desc.textContent = data.desc;
      root.appendChild(desc);

      // Project completion section
      const completionSection = document.createElement('div');
      completionSection.className = 'project-completion';
      const isCompleted = isProjectCompleted(projectName);

      completionSection.innerHTML = `
        <h3 style="color: #12ef12; margin: 0 0 15px 0;">üìä Project Completion</h3>
        <div id="completion-status" class="completion-status ${isCompleted ? 'completed' : 'not-completed'}">
          ${isCompleted ? '‚úÖ Project Completed!' : 'üìã Ready to complete this project?'}
        </div>
        <div class="difficulty-selector">
          <label for="difficulty">Difficulty Level:</label>
          <select id="difficulty" ${isCompleted ? 'disabled' : ''}>
            <option value="easy" ${data.difficulty === 'easy' ? 'selected' : ''}>Easy (25 points)</option>
            <option value="medium" ${data.difficulty === 'medium' ? 'selected' : ''}>Medium (50 points)</option>
            <option value="hard" ${data.difficulty === 'hard' ? 'selected' : ''}>Hard (100 points)</option>
          </select>
        </div>
        <button id="complete-project-btn" class="complete-btn" ${isCompleted ? 'disabled' : ''}>
          ${isCompleted ? 'Already Completed' : 'Mark as Completed'}
        </button>
      `;
      root.appendChild(completionSection);

      // Resources
      const resourcesSection = document.createElement('div');
      resourcesSection.className = 'resources-section';
      resourcesSection.innerHTML = '<div class="resources-title">üìö Learning Resources</div>';
      data.resources.forEach(resource => {
        const a = document.createElement('a');
        a.className = 'resource-link';
        a.href = resource.url;
        a.target = '_blank';
        a.textContent = resource.label;
        resourcesSection.appendChild(a);
      });
      root.appendChild(resourcesSection);

      // Chatbot
      const chatbotSection = document.createElement('div');
      chatbotSection.className = 'chatbot-section';
      chatbotSection.innerHTML = `
        <div class="section-title">ü§ñ Orbit Assistant</div>
        <div class="chatbot-messages" id="chatbot-messages">
          <div><strong>Orbit:</strong> Hi! I'm Orbit. Ask me any questions about this project. I'm here to help you succeed!</div>
        </div>
        <div class="chatbot-input">
          <input type="text" id="chatbot-input" placeholder="Ask about the project..." />
          <button id="chatbot-send">Send</button>
        </div>
      `;
      root.appendChild(chatbotSection);

      // Add event listeners
      setupEventListeners(projectName);
    }

    function setupEventListeners(projectName) {
      // Project completion button
      const completeBtn = document.getElementById('complete-project-btn');
      if (completeBtn && !completeBtn.disabled) {
        completeBtn.addEventListener('click', () => {
          const difficulty = document.getElementById('difficulty').value;
          if (confirm(`Are you sure you want to mark "${projectName}" as completed with ${difficulty} difficulty?`)) {
            completeProject(projectName, difficulty);
          }
        });
      }

      // Chatbot functionality
      const sendBtn = document.getElementById('chatbot-send');
      const chatInput = document.getElementById('chatbot-input');

      if (sendBtn) {
        sendBtn.addEventListener('click', sendChatMessage);
      }

      if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendChatMessage();
          }
        });
      }
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatbot-input');
      const message = input.value.trim();
      if (!message) return;

      const messages = document.getElementById('chatbot-messages');
      messages.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
      input.value = '';

      // Show loading state
      const loadingMsg = `<div><strong>Orbit:</strong> Thinking...</div>`;
      messages.innerHTML += loadingMsg;
      messages.scrollTop = messages.scrollHeight;

      try {
        // Call backend chatbot API
        const response = await fetch(CHAT_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            question: message,
            context: 'project'
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // Remove loading message and add AI response
        messages.innerHTML = messages.innerHTML.replace(loadingMsg, '');
        messages.innerHTML += `<div><strong>Orbit:</strong> ${data.answer}</div>`;
      } catch (error) {
        console.error('Chatbot error:', error);
        // Remove loading message and add error response
        messages.innerHTML = messages.innerHTML.replace(loadingMsg, '');
        messages.innerHTML += `<div><strong>Orbit:</strong> Sorry, I'm having trouble connecting right now. Please try again later.</div>`;
      }

      messages.scrollTop = messages.scrollHeight;
    }

    // CSS Animation keyframes
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px) translate(-50%, -50%);
        }
        to {
          opacity: 1;
          transform: translateY(0) translate(-50%, -50%);
        }
      }
    `;
    document.head.appendChild(style);

    // Initialize the application
    initializeApp();
  </script>
</body>

</html>