<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hiero Resume Builder</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: #0b0a0a;
      line-height: 1.6;
      background-color: #020202;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 15% 15%, rgba(42, 224, 35, 0.12) 0%, transparent 50%),
        radial-gradient(circle at 85% 85%, rgba(42, 224, 35, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(20, 20, 20, 0) 0%, rgba(0, 0, 0, 0.8) 100%),
        linear-gradient(135deg, #050a05 0%, #0f2410 100%);
      z-index: -1;
      pointer-events: none;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Template Selection Styles */
    .template-selection {
      background: rgb(3, 2, 2);
      border-radius: 32px;
      padding: 60px;
      margin-bottom: 40px;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(45, 196, 44, 0.15);
    }

    .template-categories {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .category-btn {
      padding: 10px 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.03);
      color: #aaa;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 13px;
      letter-spacing: 0.5px;
      backdrop-filter: blur(5px);
    }

    .category-btn.active {
      background: #2ae023;
      color: #000;
      border-color: #2ae023;
      font-weight: 700;
      box-shadow: 0 0 20px rgba(42, 224, 35, 0.3);
    }

    .category-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      transform: translateY(-2px);
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* Responsive Header Adjustments */
    @media (max-width: 768px) {
      .header {
        padding: 80px 20px 20px;
        /* Space for absolute nav */
      }

      .header-nav {
        left: 50%;
        transform: translateX(-50%);
        top: 20px;
        width: 100%;
        justify-content: center;
        right: auto;
      }

      .header h1 {
        font-size: 2.2rem;
      }
    }

    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .template-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(45, 196, 44, 0.2);
      border-radius: 20px;
      padding: 30px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: block;
    }

    .template-card:hover {
      border-color: #2ae023;
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(42, 224, 35, 0.2);
    }

    .template-card.premium {
      border-color: #ffd700;
      background: rgba(255, 215, 0, 0.03);
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.05);
    }

    .template-card.premium:hover {
      border-color: #ffd700;
      box-shadow: 0 15px 40px rgba(255, 215, 0, 0.25);
      background: rgba(255, 215, 0, 0.08);
    }

    .premium-badge {
      animation: pulsePremium 2s infinite ease-in-out;
      position: absolute;
      top: 15px;
      right: 15px;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      z-index: 10;
      letter-spacing: normal;
      border: none;
    }

    @keyframes pulsePremium {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
      }

      70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
      }

      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
      }
    }

    .template-preview {
      width: 100%;
      height: 280px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2ae023;
      font-size: 3rem;
      border: 1px solid rgba(45, 196, 44, 0.2);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .template-preview:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: #2ae023;
    }

    .template-card.premium .template-preview {
      background: rgba(255, 255, 255, 0.1);
    }

    .template-preview i {
      color: inherit;
      transition: none;
    }

    .template-card.premium .template-preview i {
      color: #ffd700;
    }

    .preview-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: none;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .template-preview:hover .preview-overlay {
      opacity: 1;
    }

    .preview-btn {
      background: rgba(42, 224, 35, 0.2);
      color: #2ae023;
      border: 2px solid #2ae023;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      transform: none;
    }

    .template-preview:hover .preview-btn {
      transform: none;
    }

    .preview-btn:hover {
      background: #2ae023;
      color: #000;
      transform: none;
    }

    .template-info {
      display: block;
    }

    .template-info h3 {
      color: #2ae023;
      font-size: 1.2rem;
      margin-bottom: 10px;
      font-weight: 700;
      letter-spacing: normal;
    }

    .template-card.premium .template-info h3 {
      color: #2ae023;
    }

    /* Override for premium card title if desired, but request says "previous design" */

    .template-info p {
      color: #ccc;
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .template-tags {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tag {
      background: rgba(42, 224, 35, 0.2);
      color: #2ae023;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: none;
      letter-spacing: normal;
      border: none;
    }

    .tag.premium {
      background: rgba(255, 215, 0, 0.2);
      color: #ffd700;
      border: none;
    }

    .start-building-btn {
      width: 100%;
      background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
    }

    .template-card.premium .start-building-btn {
      background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
      color: #000;
      border: none;
    }

    .start-building-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(42, 224, 35, 0.3);
      background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
      color: #000;
      border: none;
    }

    .template-card.premium .start-building-btn:hover {
      background: linear-gradient(135deg, #ffd700 0%, #daa520 100%);
      color: #000;
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
    }

    /* Hide form initially */
    .main-layout {
      display: none;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      align-items: start;
    }

    .left-pane,
    .right-pane {
      background: rgb(3, 2, 2);
      border-radius: 24px;
      padding: 35px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(45, 196, 44, 0.15);
    }

    .bottom-actions {
      display: none;
      gap: 20px;
      justify-content: center;
      margin-top: 40px;
    }

    .btn {
      padding: 18px 36px;
      border: none;
      border-radius: 16px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      transition: all .35s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #05b41c 0%, #06c719 100%);
      color: white;
      box-shadow: 0 8px 25px rgba(5, 180, 28, .4);
    }

    .btn-primary:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 35px rgba(7, 210, 7, .6);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, .12);
      color: #ddd;
      border: 2px solid rgba(226, 232, 240, .3);
    }

    .btn-secondary:hover {
      background: rgba(1, 6, 11, .8);
      border-color: #0fdc2a;
      color: #0fdc2a;
      transform: translateY(-4px);
    }

    /* Modal styles for template preview */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 30px;
      border-bottom: 1px solid #eee;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      line-height: 1;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: #f5f5f5;
      color: #333;
    }

    .modal-preview {
      padding: 40px;
      display: flex;
      justify-content: center;
      background: #f8f9fa;
      min-height: 400px;
      align-items: center;
    }

    .modal-footer {
      padding: 20px 30px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }

    .modal-use-btn {
      background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .modal-use-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(42, 224, 35, 0.3);
    }

    /* Header Styling */
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 80px 40px 40px;
      position: relative;
      background: rgba(5, 5, 5, 0.6);
      border-radius: 30px;
      border: 1px solid rgba(42, 224, 35, 0.1);
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05),
        0 0 100px rgba(42, 224, 35, 0.05);
      backdrop-filter: blur(10px);
    }

    .header h1 {
      font-size: 4.2rem;
      background: linear-gradient(135deg, #2ae023 0%, #00ff88 50%, #2ae023 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 900;
      letter-spacing: -2px;
      margin-bottom: 16px;
      filter: drop-shadow(0 0 30px rgba(42, 224, 35, 0.3));
      animation: titleGlow 3s ease-in-out infinite;
    }

    @keyframes titleGlow {

      0%,
      100% {
        filter: drop-shadow(0 0 30px rgba(42, 224, 35, 0.3));
      }

      50% {
        filter: drop-shadow(0 0 50px rgba(42, 224, 35, 0.5));
      }
    }

    .header p {
      font-size: 1.15rem;
      color: #b0b0b0;
      font-weight: 400;
      max-width: 560px;
      margin: 0 auto;
      letter-spacing: 0.3px;
      line-height: 1.6;
    }

    /* Navigation Buttons */
    .header-nav {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 12px;
      z-index: 20;
    }

    .header-nav button {
      background: rgba(10, 10, 10, 0.4);
      color: #ccc;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 8px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(8px);
    }

    .header-nav button:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.2);
    }

    .header-nav button.logout-btn {
      border-color: rgba(255, 107, 107, 0.3);
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.05);
    }

    .header-nav button.logout-btn:hover {
      background: #ff6b6b;
      color: white;
      border-color: #ff6b6b;
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
    }

    /* Step Indicator */
    .step-indicator {
      text-align: center;
      margin-bottom: 40px;
      position: relative;
      display: flex;
      justify-content: center;
    }

    .step-text {
      background: rgba(42, 224, 35, 0.1);
      color: #2ae023;
      padding: 10px 30px;
      border-radius: 50px;
      font-weight: 700;
      font-size: 1rem;
      border: 1px solid rgba(42, 224, 35, 0.2);
      letter-spacing: 0.5px;
      text-transform: uppercase;
      box-shadow: 0 0 20px rgba(42, 224, 35, 0.1);
      backdrop-filter: blur(5px);
    }

    .form-section {
      margin-bottom: 50px;
      position: relative;
      transition: all .4s ease;
    }

    .form-section.skipped {
      opacity: 0.4;
      /* removed pointer-events:none to keep Show link clickable */
      max-height: 60px;
      overflow: hidden;
    }

    .form-section.skipped .form-content {
      display: none;
    }

    .section-title {
      font-size: 2rem;
      color: #04ab07ee;
      margin-bottom: 30px;
      padding-bottom: 16px;
      border-bottom: 4px solid #0d8705;
      display: flex;
      align-items: center;
      gap: 16px;
      font-weight: 700;
      position: relative;
      flex-wrap: wrap;
    }

    .section-title::before {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 80px;
      height: 4px;
      background: #2ae023;
      border-radius: 2px;
    }

    .section-icon {
      color: #2ae023;
      font-size: 1.8rem;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(42, 224, 35, .15);
      border-radius: 12px;
      border: 1px solid rgba(42, 224, 35, .3);
    }

    .skip-link {
      font-size: 0.85rem;
      color: #75ea66;
      cursor: pointer;
      font-weight: 600;
      text-decoration: underline;
      text-underline-offset: 3px;
      opacity: 0.8;
      margin-left: 8px;
    }

    .skip-link:hover {
      color: #2ae023;
      opacity: 1;
    }

    .field-skip {
      font-size: 0.75rem;
      color: #75ea66;
      cursor: pointer;
      margin-left: 8px;
      font-weight: 500;
      text-decoration: underline;
      opacity: 0.7;
    }

    .field-skip:hover {
      opacity: 1;
      color: #2ae023;
    }

    .form-group {
      margin-bottom: 26px;
      position: relative;
    }

    .form-group.skipped {
      opacity: 0.4;
      /* removed pointer-events:none to allow clicking Show */
    }

    .form-group.skipped input,
    .form-group.skipped textarea {
      display: none;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* Photo Upload Section */
    .photo-upload-section {
      background: rgba(42, 224, 35, 0.05);
      border: 2px dashed rgba(42, 224, 35, 0.3);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 35px;
    }

    .photo-upload-container {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 30px;
      align-items: start;
    }

    .photo-preview-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .photo-preview {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.08);
      border: 3px solid rgba(42, 224, 35, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    .photo-preview:hover {
      border-color: #2ae023;
      box-shadow: 0 0 30px rgba(42, 224, 35, 0.2);
      transform: scale(1.05);
    }

    .photo-preview i {
      font-size: 50px;
      color: rgba(42, 224, 35, 0.6);
    }

    .photo-preview.has-image i,
    .photo-preview.has-image .photo-placeholder-text {
      display: none;
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
    }

    .photo-placeholder-text {
      color: #aaa;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }

    .photo-upload-btn {
      padding: 12px 28px;
      background: linear-gradient(135deg, #2ae023 0%, #1aa018 100%);
      color: #000;
      border: none;
      border-radius: 50px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      box-shadow: 0 4px 15px rgba(42, 224, 35, 0.3);
    }

    .photo-upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(42, 224, 35, 0.5);
    }

    .ai-magic-btn {
      padding: 12px 28px;
      background: linear-gradient(135deg, #0f0f0f 0%, #222 100%);
      color: #2ae023;
      border: 1px solid #2ae023;
      border-radius: 50px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(42, 224, 35, 0.2);
    }

    .ai-magic-btn:hover {
      transform: translateY(-3px) scale(1.02);
      background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
      box-shadow: 0 0 30px rgba(42, 224, 35, 0.4);
      color: #fff;
    }

    .ai-magic-btn .btn-shine {
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(42, 224, 35, 0.2), transparent);
      transform: skewX(-25deg);
      transition: 0.5s;
    }

    .ai-magic-btn:hover .btn-shine {
      animation: shine 1.5s infinite;
    }

    @keyframes shine {
      100% {
        left: 200%;
      }
    }

    .ai-magic-btn i {
      animation: pulseSparkle 2s infinite;
    }

    @keyframes pulseSparkle {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
        text-shadow: 0 0 5px #2ae023;
      }

      50% {
        transform: scale(1.2);
        opacity: 0.8;
        text-shadow: 0 0 15px #2ae023;
      }
    }

    .photo-upload-info {
      color: #ccc;
    }

    .photo-upload-info p {
      margin-bottom: 12px;
      color: #2ae023;
      font-size: 14px;
    }

    .photo-upload-info ul {
      list-style: none;
      padding: 0;
      margin: 0 0 15px 0;
    }

    .photo-upload-info li {
      padding: 6px 0;
      font-size: 13px;
      color: #aaa;
      position: relative;
      padding-left: 20px;
    }

    .photo-upload-info li:before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: #2ae023;
      font-weight: bold;
    }

    .photo-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 15px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
    }

    .photo-status.success {
      background: rgba(42, 224, 35, 0.15);
      color: #2ae023;
      border: 1px solid rgba(42, 224, 35, 0.3);
    }

    .photo-status.error {
      background: rgba(255, 107, 107, 0.15);
      color: #ff6b6b;
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .photo-upload-container {
        grid-template-columns: 1fr;
        gap: 20px;
        text-align: center;
      }

      .photo-preview-wrapper {
        margin: 0 auto;
      }

      .photo-upload-info {
        text-align: left;
      }
    }

    /* Two-Column Layout for Custom Details & References */
    .two-column-sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 35px;
    }

    .two-column-sections .form-section {
      margin-bottom: 0;
    }

    /* Mobile: Stack vertically */
    @media (max-width: 1024px) {
      .two-column-sections {
        grid-template-columns: 1fr;
        gap: 25px;
      }
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #0fdc2a;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .required {
      color: #e53e3e;
    }

    input:not([type="checkbox"]),
    textarea {
      width: 100%;
      padding: 17px 18px;
      border: 2px solid rgba(226, 232, 240, .25);
      border-radius: 16px;
      font-size: 16px;
      background: rgba(255, 255, 255, .08);
      color: #fff;
      backdrop-filter: blur(5px);
      transition: all .3s ease;
    }

    input:not([type="checkbox"]):focus,
    textarea:focus {
      outline: none;
      border-color: #12ca12;
      box-shadow: 0 0 0 4px rgba(18, 202, 18, .2), 0 8px 25px rgba(18, 202, 18, .15);
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .12);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    /* Checkbox styling */
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #2ae023;
      flex-shrink: 0;
    }

    /* Currently working here checkbox container */
    .checkbox-container {
      margin-top: 5px;
      margin-bottom: 15px;
    }

    .checkbox-container label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #0fdc2a;
      cursor: pointer;
      margin-bottom: 0;
    }

    .experience-item,
    .education-item {
      background: rgba(248, 249, 250, .1);
      padding: 28px;
      border-radius: 18px;
      margin-bottom: 20px;
      border-left: 6px solid #75ea66;
      border: 1px solid rgba(117, 234, 102, .25);
      transition: all .35s ease;
    }

    .experience-item:hover,
    .education-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(117, 234, 102, .2);
    }

    .reference-item,
    .custom-detail-item {
      background: rgba(248, 249, 250, .1);
      padding: 28px;
      border-radius: 18px;
      margin-bottom: 20px;
      border-left: 6px solid #2ae023;
      border: 1px solid rgba(42, 224, 35, .25);
      transition: all .35s ease;
    }

    .reference-item:hover,
    .custom-detail-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(42, 224, 35, .2);
    }

    .project-item {
      background: rgba(248, 249, 250, .1);
      padding: 28px;
      border-radius: 18px;
      margin-bottom: 20px;
      border-left: 6px solid #2ae023;
      border: 1px solid rgba(42, 224, 35, .25);
      transition: all .35s ease;
      position: relative;
    }

    .project-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(42, 224, 35, .2);
    }

    .add-more-btn {
      background: rgba(226, 232, 240, .15);
      color: #bbb;
      border: 2px dashed rgba(203, 213, 224, .5);
      padding: 18px;
      border-radius: 16px;
      cursor: pointer;
      transition: all .35s ease;
      margin: 20px 0;
      font-weight: 600;
      font-size: 15px;
      backdrop-filter: blur(5px);
    }

    .add-more-btn:hover {
      background: rgba(117, 234, 102, .15);
      border-color: #75ea66;
      color: #75ea66;
      transform: translateY(-2px);
    }

    .remove-btn {
      background: rgba(254, 215, 215, .25);
      color: #e53e3e;
      border: none;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
      float: right;
      font-weight: 600;
      transition: all .3s ease;
      backdrop-filter: blur(5px);
    }

    .remove-btn:hover {
      background: #fca5a5;
      transform: scale(1.05);
    }

    @media (max-width:768px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .header {
        padding: 60px 20px 30px;
      }

      .header h1 {
        font-size: 2.3rem;
      }

      .section-title {
        font-size: 1.8rem;
      }

      .header-nav {
        top: 10px;
        right: 10px;
        left: 10px;
        justify-content: space-between;
        gap: 8px;
      }

      .header-nav button {
        font-size: 11px;
        padding: 8px 12px;
        flex: 1;
        min-width: 0;
      }

      #backToTemplatesBtn {
        position: static !important;
        transform: none !important;
        margin-bottom: 15px;
        width: 100%;
      }

      .step-indicator {
        padding: 20px 10px !important;
      }

      /* Mobile-optimized form inputs */
      input,
      textarea {
        padding: 14px 16px;
        font-size: 16px;
        /* Prevents zoom on iOS */
        -webkit-appearance: none;
        appearance: none;
        border-radius: 12px;
      }

      textarea {
        min-height: 100px;
      }

      /* Better mobile spacing for form sections */
      .form-section {
        margin-bottom: 35px;
      }

      .section-title {
        font-size: 1.6rem;
        flex-wrap: wrap;
        gap: 10px;
      }

      .section-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
      }

      /* Mobile template grid */
      .templates-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .template-card {
        padding: 18px;
      }

      .template-categories {
        flex-wrap: wrap;
        gap: 10px;
      }

      .category-btn {
        padding: 10px 18px;
        font-size: 13px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-nav">
        <button onclick="window.location.href='index.html'">
          <i class="fas fa-home"></i> Home
        </button>
        <button onclick="logout()" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
      <h1>Hiero Resume Builder</h1>
      <p>Create your professional resume in simple steps</p>
    </div>

    <!-- Template Selection Section -->
    <div class="template-selection" id="templateSelection">
      <div class="step-indicator" style="margin-bottom: 40px;">
        <div class="step-text">Step 1: Choose Your Template</div>
      </div>

      <div class="template-categories">
        <button class="category-btn active" data-category="all">All Templates</button>
        <button class="category-btn" data-category="modern">Modern</button>
        <button class="category-btn" data-category="analytics">Analytics</button>
        <button class="category-btn" data-category="professional">Professional</button>
        <button class="category-btn" data-category="creative">Creative</button>
        <button class="category-btn" data-category="premium">Premium</button>
        <button class="category-btn" id="shuffleBtn"
          style="background: linear-gradient(45deg, #2ae023, #00ff00); color: #000; border: none; font-weight: 700;">
          <i class="fas fa-random"></i> Shuffle
        </button>
      </div>

      <div class="templates-grid" id="templatesGrid"
        style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); max-width: 1200px; margin: 0 auto;">
        <!-- Hiero Pro Template (formerly Rishi) -->
        <div class="template-card" data-category="modern" data-template="rishi" data-type="free">
          <div class="template-preview" onclick="previewTemplate('rishi')">
            <i class="fas fa-laptop-code"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Modern</h3>
            <p>Professional modern template with clean design and excellent readability. Perfect for all industries and
              career levels.</p>
            <div class="template-tags">
              <span class="tag">Modern</span>
              <span class="tag">Professional</span>
              <span class="tag">ATS-Friendly</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('rishi')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>




        <!-- Hiero Monethon Template -->
        <div class="template-card" data-category="premium" data-template="hiero-monethon" data-type="premium">
          <div class="premium-badge">NEW</div>
          <div class="template-preview" onclick="previewTemplate('hiero-monethon')">
            <i class="fas fa-file-invoice"></i>

            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Monethon</h3>
            <p>Premium professional layout with orange header accents and a dark navy sidebar. Perfectly balanced for
              high-impact roles.</p>
            <div class="template-tags">
              <span class="tag">Premium</span>
              <span class="tag">Two Column</span>
              <span class="tag">Corporate</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-monethon')"
              style="background: linear-gradient(135deg, #F2B66D 0%, #d4954a 100%);">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Nova Template -->
        <div class="template-card" data-category="premium" data-template="hiero-nova" data-type="premium">
          <div class="premium-badge">PREMIUM</div>
          <div class="template-preview" onclick="previewTemplate('hiero-nova')">
            <i class="fas fa-shield" style="color: #2ae023;"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Legion</h3>

            <p>A sophisticated monochrome design with a bold shield profile and a strong vertical badge. Perfect for
              modern professionals seeking a high-contrast look.</p>
            <div class="template-tags">
              <span class="tag">Modern</span>
              <span class="tag">Monochrome</span>
              <span class="tag">Badge</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-nova')">

              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>


        <!-- Priya Analytics Single-Column Template (matches Priya Sharma PDF) -->
        <div class="template-card" data-category="analytics" data-template="priya-analytics" data-type="free">
          <div class="template-preview" onclick="previewTemplate('priya-analytics')">
            <i class="fas fa-chart-line"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Analytics</h3>
            <p>Single-column layout with a grey top bar and bold section headings. Ideal for data-driven professionals.
            </p>
            <div class="template-tags">
              <span class="tag">Analytics</span>
              <span class="tag">Single Column</span>
              <span class="tag">Data Science</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('priya-analytics')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Executive Template -->
        <div class="template-card" data-category="professional" data-template="hiero-executive" data-type="free">
          <div class="template-preview" onclick="previewTemplate('hiero-executive')">
            <i class="fas fa-user-tie"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Executive</h3>
            <p>A minimalist minimalist design with labeled sections on the left, perfect for experienced professionals.
            </p>
            <div class="template-tags">
              <span class="tag">Minimalist</span>
              <span class="tag">Timeline</span>
              <span class="tag">Executive</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-executive')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Academic Template (Template 4) -->
        <div class="template-card" data-category="professional" data-template="template4" data-type="free">
          <div class="template-preview" onclick="previewTemplate('template4')">
            <i class="fas fa-university"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Academic</h3>
            <p>High-fidelity technical layout with centered headers and split subsections for maximum ATS readability.
            </p>
            <div class="template-tags">
              <span class="tag">Academic</span>
              <span class="tag">Technical</span>
              <span class="tag">Bestseller</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('template4')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>



        <!-- Hiero Minimal (Timeline) Template -->
        <div class="template-card" data-category="minimal" data-template="hiero-timeline" data-type="free">
          <div class="template-preview" onclick="previewTemplate('hiero-timeline')">
            <i class="fas fa-stream"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Minimal</h3>
            <p>Clean minimalist design with maximum white space. Emphasizes content with subtle sophistication.</p>
            <div class="template-tags">
              <span class="tag">Timeline</span>
              <span class="tag">Minimalist</span>
              <span class="tag">Corporate</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-timeline')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Tech Template (Template 8) -->
        <div class="template-card" data-category="creative" data-template="hiero-tech" data-type="free">
          <div class="template-preview" onclick="previewTemplate('hiero-tech')">
            <i class="fas fa-code"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Tech</h3>
            <p>Developer-focused template with code-style aesthetics. Optimized for software engineers and programmers.
            </p>
            <div class="template-tags">
              <span class="tag">Tech</span>
              <span class="tag">Developer</span>
              <span class="tag">Coding</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-tech')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Classic Template (Template 6) -->
        <div class="template-card" data-category="professional" data-template="hiero-classic" data-type="free">
          <div class="template-preview" onclick="previewTemplate('hiero-classic')">
            <i class="fas fa-briefcase"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Classic</h3>
            <p>Traditional professional resume with timeless design. Perfect for conventional industries.</p>
            <div class="template-tags">
              <span class="tag">Classic</span>
              <span class="tag">Corporate</span>
              <span class="tag">Traditional</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-classic')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Studio Template (Template 5) -->
        <div class="template-card" data-category="professional" data-template="hiero-studio" data-type="free">
          <div class="template-preview" onclick="previewTemplate('hiero-studio')">
            <i class="fas fa-columns"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Studio</h3>
            <p>Distinctive Right Sidebar layout with a bold timeline. Perfect for showcasing a modern professional
              profile.</p>
            <div class="template-tags">
              <span class="tag">Sidebar</span>
              <span class="tag">Modern</span>
              <span class="tag">Creative</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-studio')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Vision Template (Template 11) -->
        <div class="template-card" data-category="creative" data-template="hiero-vision" data-type="free">
          <div class="template-preview" onclick="previewTemplate('hiero-vision')">
            <i class="fas fa-eye"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Vision</h3>
            <p>Creative layout with visual storytelling approach. Perfect for designers and marketers.</p>
            <div class="template-tags">
              <span class="tag">Creative</span>
              <span class="tag">Visual</span>
              <span class="tag">Design</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-vision')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>



        <!-- Hiero Elite Template (Template 10) -->
        <div class="template-card premium" data-category="premium" data-template="hiero-elite" data-type="premium">
          <div class="premium-badge">Premium</div>
          <div class="template-preview" onclick="previewTemplate('hiero-elite')">
            <i class="fas fa-crown"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Elite</h3>
            <p>Premium executive template with luxury design elements. Ideal for C-level executives and senior
              management.</p>
            <div class="template-tags">
              <span class="tag premium">Premium</span>
              <span class="tag premium">Executive</span>
              <span class="tag premium">Luxury</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-elite')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>



        <!-- Hiero Premium Template (Template 13) -->
        <div class="template-card premium" data-category="premium" data-template="hiero-premium" data-type="premium">
          <div class="premium-badge">Premium</div>
          <div class="template-preview" onclick="previewTemplate('hiero-premium')">
            <i class="fas fa-gem"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Premium</h3>
            <p>High-end professional design with sophisticated styling. Features elegant typography and premium
              aesthetics.</p>
            <div class="template-tags">
              <span class="tag premium">Premium</span>
              <span class="tag premium">Elegant</span>
              <span class="tag premium">Refined</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-premium')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Prestige Template (Template 14) -->
        <div class="template-card premium" data-category="premium" data-template="hiero-prestige" data-type="premium">
          <div class="premium-badge">Premium</div>
          <div class="template-preview" onclick="previewTemplate('hiero-prestige')">
            <i class="fas fa-star"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Prestige</h3>
            <p>Distinguished design for top-tier professionals. Combines classic elegance with modern sophistication.
            </p>
            <div class="template-tags">
              <span class="tag premium">Prestige</span>
              <span class="tag premium">Distinguished</span>
              <span class="tag premium">Elite</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-prestige')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Signature Template -->
        <div class="template-card premium" data-category="premium" data-template="hiero-signature" data-type="premium">
          <div class="premium-badge">Premium</div>
          <div class="template-preview" onclick="previewTemplate('hiero-signature')">
            <i class="fas fa-signature"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Signature</h3>
            <p>Modern minimalist A4 portrait with a bold two-column split layout. Features a grayscale aesthetic with
              bold orange accents and a vertical timeline.</p>
            <div class="template-tags">
              <span class="tag premium">Minimalist</span>
              <span class="tag premium">Split Layout</span>
              <span class="tag premium">Modern</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-signature')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Retail Template -->
        <div class="template-card" data-category="professional" data-template="hiero-retail" data-type="free">
          <div class="template-preview" onclick="previewTemplate('hiero-retail')">
            <i class="fas fa-store"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Retail Timeline</h3>
            <p>Clean formatting with clear timeline layout. Ideal for retail professionals and customer-facing roles.
            </p>
            <div class="template-tags">
              <span class="tag">Timeline</span>
              <span class="tag">Retail</span>
              <span class="tag">Professional</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-retail')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Essence Template -->
        <div class="template-card premium" data-category="premium" data-template="hiero-essence" data-type="premium">
          <div class="premium-badge">Premium</div>
          <div class="template-preview" onclick="previewTemplate('hiero-essence')">
            <i class="fas fa-columns"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Essence</h3>
            <p>Modern corporate design featuring a sleek dark sidebar with professional orange accents.</p>
            <div class="template-tags">
              <span class="tag premium">Two-Column</span>
              <span class="tag premium">Corporate</span>
              <span class="tag premium">Premium</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-essence')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Velocity -->
        <div class="template-card premium" data-category="premium" data-template="hiero-velocity" data-type="premium">
          <div class="premium-badge">Premium</div>
          <div class="template-preview" onclick="previewTemplate('hiero-velocity')">
            <i class="fas fa-bolt"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Velocity</h3>
            <p>Designed for fast-paced growth and startup agility. Clean lines and energetic spacing for movers.</p>
            <div class="template-tags">
              <span class="tag premium">Startup</span>
              <span class="tag premium">Agile</span>
              <span class="tag premium">Fast</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-velocity')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>


      </div>
    </div>


    <!-- Form Section (Initially Hidden) -->
    <div class="step-indicator" id="formStepIndicator" style="display: none;">
      <div class="step-text">Step 2: Fill Your Information</div>
    </div>

    <div class="main-layout">
      <!-- LEFT PANE -->
      <div class="left-pane">
        <form id="resumeForm">
          <!-- Personal Info -->
          <div class="form-section" id="section-personal">
            <h2 class="section-title">
              <i class="fas fa-user section-icon"></i> Personal Information
            </h2>
            <div class="form-content">
              <!-- Photo Upload Section -->
              <div class="form-group photo-upload-section">
                <label>
                  <i class="fas fa-camera"></i> Profile Photo
                  <span class="field-skip" onclick="skipField('profilePhoto')">Skip</span>
                </label>
                <div class="photo-upload-container">
                  <div class="photo-preview-wrapper">
                    <div class="photo-preview" id="photoPreview">
                      <i class="fas fa-user"></i>
                      <span class="photo-placeholder-text">Upload Photo</span>
                    </div>
                    <input type="file" id="profilePhoto" accept="image/jpeg,image/png,image/jpg" style="display: none;"
                      onchange="handlePhotoUpload(event)">
                    <div class="photo-controls"
                      style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">
                      <button type="button" class="photo-upload-btn"
                        onclick="document.getElementById('profilePhoto').click()">
                        <i class="fas fa-upload"></i> Choose Photo
                      </button>
                      <div style="margin: 5px 0; text-align: center; color: #444; font-size: 11px; font-weight: bold;">
                        OR</div>
                      <button type="button" class="ai-magic-btn"
                        onclick="window.location.href='ai-photo-formalizer.html'"
                        style="justify-content: center; width: 100%; border: 1px solid #2ae023;">
                        <span class="btn-shine"></span>
                        <i class="fas fa-wand-magic-sparkles"></i> âœ¨ Generate Executive Photo
                      </button>
                      <p style="font-size: 11px; color: #2ae023; text-align: center; margin-top: 5px; opacity: 0.8;">
                        <i class="fas fa-crown"></i> Hiero Executive AI (Premium)
                      </p>
                    </div>
                  </div>
                  <div class="photo-upload-info">
                    <p><i class="fas fa-info-circle"></i> <strong>Photo Required:</strong></p>
                    <ul>
                      <li>Format: JPG or PNG</li>
                      <li>Recommended: Square headshot</li>
                    </ul>
                    <div id="aiPhotoBadge"
                      style="display: none; margin-top: 10px; background: rgba(42, 224, 35, 0.1); border: 1px solid #2ae023; padding: 10px; border-radius: 8px; font-size: 11px; color: #2ae023;">
                      <i class="fas fa-check-circle"></i> <strong>AI POWERED:</strong> Your photo can be automatically
                      converted to a professional executive headshot.
                    </div>
                    <span class="photo-status" id="photoStatus"></span>
                  </div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="fullName">Full Name <span class="required">*</span></label>
                  <input type="text" id="fullName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                  <label for="headline">Professional Title</label>
                  <input type="text" id="headline" placeholder="e.g. Senior Software Engineer">
                </div>
              </div>

              <!-- Added Headline Field -->
              <div class="form-group" id="group-headline">
                <label for="headline">Professional Headline</label>
                <input type="text" id="headline" placeholder="e.g. Creative Director / Software Engineer">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="email">Email <span class="required">*</span></label>
                  <input type="email" id="email" required placeholder="john.doe@example.com"
                    title="Please enter a valid email address (e.g., john@example.com)">
                  <small style="color: #666; font-size: 12px;">Examples: john@gmail.com, jane.doe@company.org</small>
                </div>
                <div class="form-group">
                  <label for="phone">Phone <span class="required">*</span></label>
                  <input type="tel" id="phone" required placeholder="+1 555-123-4567" pattern="[\+]?[\d\s\-\(\)\.]+"
                    title="Please enter a valid phone number (numbers, spaces, dashes, parentheses, and + allowed)">
                  <small style="color: #666; font-size: 12px;">Examples: +1 555-123-4567, (555) 123-4567,
                    555.123.4567</small>
                </div>
              </div>

              <!-- Optional: Address -->
              <div class="form-group" id="group-address">
                <label>
                  Address
                  <span class="field-skip" onclick="skipField('address')">Skip</span>
                </label>
                <textarea id="address" placeholder="Your complete address"></textarea>
              </div>

              <div class="form-row">
                <!-- Optional: LinkedIn -->
                <div class="form-group" id="group-linkedin">
                  <label>
                    LinkedIn
                    <span class="field-skip" onclick="skipField('linkedin')">Skip</span>
                  </label>
                  <input type="url" id="linkedin" placeholder="https://linkedin.com/in/yourprofile">
                </div>
                <!-- Optional: Website -->
                <div class="form-group" id="group-website">
                  <label>
                    Portfolio
                    <span class="field-skip" onclick="skipField('website')">Skip</span>
                  </label>
                  <input type="url" id="website" placeholder="https://yourwebsite.com">
                </div>
              </div>
            </div>
          </div>

          <!-- Professional Summary -->
          <div class="form-section" id="section-summary">
            <h2 class="section-title">
              <i class="fas fa-user-tie section-icon"></i> Professional Summary
              <span class="skip-link" onclick="toggleSection('summary')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" rows="4" placeholder="Brief professional overview..."></textarea>
              </div>
            </div>
          </div>

          <!-- Work Experience -->
          <div class="form-section" id="section-experience">
            <h2 class="section-title">
              <i class="fas fa-briefcase section-icon"></i> Work Experience
              <span class="skip-link" onclick="toggleSection('experience')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="experienceContainer">
                <div class="experience-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="jobTitle1">Job Title</label>
                      <input type="text" id="jobTitle1" name="jobTitle[]" placeholder="Software Engineer">
                    </div>
                    <div class="form-group">
                      <label for="company1">Company</label>
                      <input type="text" id="company1" name="company[]" placeholder="Company Name">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="startDate1">Start Date</label>
                      <input type="month" id="startDate1" name="startDate[]">
                    </div>
                    <div class="form-group">
                      <label for="endDate1">End Date</label>
                      <input type="month" id="endDate1" name="endDate[]">
                    </div>
                  </div>
                  <div class="checkbox-container">
                    <label>
                      <input type="checkbox" id="current1" onchange="toggleWorking(this)"> Currently working here
                    </label>
                  </div>
                  <div class="form-group">
                    <label for="jobDescription1">Description</label>
                    <textarea id="jobDescription1" name="jobDescription[]" rows="4"
                      placeholder="Key responsibilities..."></textarea>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addExperience()">Add Another Experience</button>
            </div>
          </div>

          <!-- Internship Experience (NEW) -->
          <div class="form-section" id="section-internships">
            <h2 class="section-title">
              <i class="fas fa-microchip section-icon"></i> Internship Experience
              <span class="skip-link" onclick="toggleSection('internships')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="internshipsContainer">
                <div class="internship-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Intern Role</label>
                      <input type="text" name="internRole[]" placeholder="Software Intern">
                    </div>
                    <div class="form-group">
                      <label>Organization</label>
                      <input type="text" name="internOrg[]" placeholder="Tech Solutions">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Start Date</label>
                      <input type="month" name="internStart[]">
                    </div>
                    <div class="form-group">
                      <label>End Date</label>
                      <input type="month" name="internEnd[]">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Description</label>
                    <textarea name="internDesc[]" rows="4" placeholder="Key contributions..."></textarea>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addInternship()">Add Another Internship</button>
            </div>
          </div>


          <!-- Education -->
          <div class="form-section" id="section-education">
            <h2 class="section-title">
              <i class="fas fa-graduation-cap section-icon"></i> Education
              <span class="skip-link" onclick="toggleSection('education')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="educationContainer">
                <div class="education-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="degree1">Degree</label>
                      <input type="text" id="degree1" name="degree[]" placeholder="Bachelor of Science">
                    </div>
                    <div class="form-group">
                      <label for="school1">School</label>
                      <input type="text" id="school1" name="school[]" placeholder="University Name">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="gradYear1">Year</label>
                      <input type="number" id="gradYear1" name="gradYear[]" min="1950" max="2030" placeholder="2024">
                    </div>
                    <div class="form-group">
                      <label for="gpa1">GPA</label>
                      <input type="text" id="gpa1" name="gpa[]" placeholder="3.8/4.0">
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addEducation()">Add Another Education</button>
            </div>
          </div>
        </form>
      </div>

      <!-- RIGHT PANE -->
      <div class="right-pane">
        <div id="resumeFormPart2">

          <!-- Skills -->
          <div class="form-section" id="section-skills">
            <h2 class="section-title">
              <i class="fas fa-tools section-icon"></i> Skills
              <span class="skip-link" onclick="toggleSection('skills')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div class="form-group" id="group-skills">
                <label for="technicalSkills">Technical Skills</label>
                <textarea id="technicalSkills" rows="3" placeholder="JavaScript, Python, React..."></textarea>
              </div>
              <div class="form-group" id="group-soft-skills">
                <label for="softSkills">Soft Skills</label>
                <textarea id="softSkills" rows="3" placeholder="Leadership, Communication..."></textarea>
              </div>
            </div>
          </div>

          <!-- Additional Details (Certifications & Languages) -->
          <div class="form-section" id="section-additional-details">
            <h2 class="section-title">
              <i class="fas fa-plus-circle section-icon"></i> Additional Details
              <span class="skip-link" onclick="toggleSection('additional-details')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div class="form-group" id="group-certifications">
                <label>
                  Certifications
                  <span class="field-skip" onclick="skipField('certifications')">Skip</span>
                </label>
                <textarea id="certifications" rows="3" placeholder="AWS, Google Cloud..."></textarea>
              </div>
              <div class="form-group" id="group-languages">
                <label>
                  Languages
                  <span class="field-skip" onclick="skipField('languages')">Skip</span>
                </label>
                <textarea id="languages" rows="2" placeholder="English (Native)..."></textarea>
              </div>
            </div>
          </div>

          <!-- Projects Section -->
          <div class="form-section" id="section-projects">
            <h2 class="section-title">
              <i class="fas fa-code section-icon"></i> Projects
              <span class="skip-link" onclick="toggleSection('projects')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="projectsContainer">
                <div class="project-item">
                  <button type="button" class="remove-btn" aria-label="Remove entry"
                    onclick="this.parentElement.remove()">Remove</button>
                  <div class="form-group">
                    <label>Project Name <span class="required">*</span></label>
                    <input type="text" name="projectName[]" placeholder="E-commerce Platform" required>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Technologies Used</label>
                      <input type="text" name="projectTech[]" placeholder="React, Node.js, MongoDB">
                    </div>
                    <div class="form-group">
                      <label>Duration/Year</label>
                      <input type="text" name="projectDuration[]" placeholder="6 months or 2023">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Project Description</label>
                    <textarea name="projectDescription[]" rows="4"
                      placeholder="Describe what the project does, key features, and your role..."></textarea>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>GitHub/Deployment Link (Optional)</label>
                      <input type="url" name="projectLink[]" placeholder="https://github.com/username/project">
                    </div>
                    <div class="form-group">
                      <label>Key Achievement/Metrics (Optional)</label>
                      <input type="text" name="projectAchievement[]"
                        placeholder="10K+ users, 40% performance improvement">
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addProject()">
                <i class="fas fa-plus"></i> Add Another Project
              </button>
              <p style="color: #2ae023; font-size: 0.85rem; margin-top: 15px; opacity: 0.8;">
                <i class="fas fa-lightbulb"></i> Tip: Include 2-4 key projects that showcase your skills. Focus on
                impact and technologies used.
              </p>
            </div>
          </div>

          <!-- Additional Information Section -->
          <div class="form-section" id="section-additional">
            <h2 class="section-title">
              <i class="fas fa-plus-circle section-icon"></i> Additional Information
              <span class="skip-link" onclick="toggleSection('additional')">Skip this section</span>
            </h2>
            <div class="form-group" id="group-achievements">
              <label>
                Achievements
                <span class="field-skip" onclick="skipField('achievements')">Skip</span>
              </label>
              <textarea id="achievements" rows="3" placeholder="Awards, hackathons..."></textarea>
            </div>
            <div class="form-group" id="group-hobbies">
              <label>
                Hobbies
                <span class="field-skip" onclick="skipField('hobbies')">Skip</span>
              </label>
              <textarea id="hobbies" rows="2" placeholder="Photography, hiking..."></textarea>
            </div>
            <div class="form-group" id="group-extraCurricular">
              <label>
                Extra-Curricular Activities
                <span class="field-skip" onclick="skipField('extraCurricular')">Skip</span>
              </label>
              <textarea id="extraCurricular" rows="2" placeholder="Clubs, sports, volunteering..."></textarea>
            </div>
            <div class="form-group">
              <label for="additionalInfo">Other Details (AI Summary)</label>
              <textarea id="additionalInfo" rows="4" placeholder="Additional details from LLM..."></textarea>
            </div>
          </div>
        </div>

        <!-- Two-Column Layout: Custom Details (Left) & References (Right) -->
        <div class="two-column-sections">
          <!-- Custom Details (Left Column) -->
          <div class="form-section" id="section-custom">
            <h2 class="section-title">
              <i class="fas fa-edit section-icon"></i> Custom Details
              <span class="skip-link" onclick="toggleSection('custom')">Skip this section</span>
            </h2>
            <div class="form-content">
              <p style="color: #2ae023; font-size: 14px; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> Add any additional sections you need (e.g., Publications, Volunteer
                Work, Awards, etc.)
              </p>
              <div id="customDetailsContainer">
                <div class="custom-detail-item">
                  <div class="form-group" id="customSectionTitleWrapper">
                    <label for="customSectionTitle">Custom Section Title</label>
                    <input type="text" id="customSectionTitle" placeholder="e.g., Publications">
                  </div>
                  <div class="form-group">
                    <label for="customHeading1">Item Heading</label>
                    <input type="text" id="customHeading1" name="customHeading[]" placeholder="e.g., Research Paper A">
                  </div>
                  <div class="form-group">
                    <label for="customContent1">Content</label>
                    <textarea id="customContent1" name="customContent[]" rows="4"
                      placeholder="Describe the details..."></textarea>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addCustomDetail()">Add Another Custom Item</button>

              <div style="margin-top: 20px; border-top: 1px dashed rgba(42,224,35,0.2); padding-top: 20px;">
                <div class="form-group">
                  <label for="customSectionContent">Direct Custom Content (from AI)</label>
                  <textarea id="customSectionContent" rows="6" placeholder="Spilled custom content..."></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- References (Right Column) -->
          <div class="form-section" id="section-references">
            <h2 class="section-title">
              <i class="fas fa-users section-icon"></i> References
              <span class="skip-link" onclick="toggleSection('references')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="referencesContainer">
                <div class="reference-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="refName1">Reference Name</label>
                      <input type="text" id="refName1" name="refName[]" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                      <label for="refTitle1">Title/Position</label>
                      <input type="text" id="refTitle1" name="refTitle[]" placeholder="Senior Manager">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="refCompany1">Company</label>
                      <input type="text" id="refCompany1" name="refCompany[]" placeholder="Company Name">
                    </div>
                    <div class="form-group">
                      <label for="refPhone1">Phone</label>
                      <input type="tel" id="refPhone1" name="refPhone[]" placeholder="(555) 123-4567"
                        pattern="[\+]?[\d\s\-\(\)\.]+\" title="Please enter a valid phone number">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="refEmail1">Email</label>
                    <input type="email" id="refEmail1" name="refEmail[]" placeholder="reference@company.com"
                      title="Please enter a valid email address">
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addReference()">Add Another Reference</button>
            </div>
          </div>
        </div>

        <!-- End of Two-Column Layout -->

      </div>
    </div>
  </div>

  <!-- Bottom Buttons -->
  <div class="bottom-actions">
    <button type="button" class="btn" style="background: #ffa500; color: white;" onclick="fillSampleData()">
      <i class="fas fa-magic"></i> Fill Sample Data
    </button>
    <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
    <button type="button" class="btn btn-primary" onclick="generateResume()">Generate Resume</button>
  </div>

  <!-- Results -->
  <div id="resultsSection"
    style="display:none; margin-top:40px; text-align:center; padding: 40px; background: rgba(0,0,0,0.4); border-radius: 20px; border: 1px solid rgba(42,224,35,0.2);">
    <h2 style="color:#2ae023; font-size:2.4rem; margin-bottom:20px; font-weight: 700;">Resume Tailored Successfully!
    </h2>
    <p style="color: #cbd5e1; margin-bottom: 40px; font-size: 1.1rem;">Your professional ATS-friendly resume is ready.
      Select your preferred format below.</p>

    <div style="display:flex; gap:25px; justify-content:center; flex-wrap:wrap;">
      <div class="download-card"
        style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); width: 220px; transition: all 0.3s;"
        onmouseover="this.style.borderColor='#2ae023'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)'">
        <i class="fas fa-file-pdf" style="font-size: 3rem; color: #ef4444; margin-bottom: 20px;"></i>
        <h4 style="color: white; margin-bottom: 20px;">Standard PDF</h4>
        <button class="btn btn-primary" onclick="downloadResume()" style="width: 100%;">Download</button>
      </div>

      <div class="download-card"
        style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); width: 220px; transition: all 0.3s;"
        onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)'">
        <i class="fas fa-file-word" style="font-size: 3rem; color: #3b82f6; margin-bottom: 20px;"></i>
        <h4 style="color: white; margin-bottom: 20px;">Microsoft Word</h4>
        <button id="downloadDocxBtn" class="btn btn-primary" onclick="downloadDocx()"
          style="width: 100%; background: #3b82f6; border-color: #3b82f6;">Download Word</button>
      </div>

      <div class="download-card"
        style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); width: 220px; transition: all 0.3s;"
        onmouseover="this.style.borderColor='#2ae023'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)'">
        <i class="fas fa-eye" style="font-size: 3rem; color: #2ae023; margin-bottom: 20px;"></i>
        <h4 style="color: white; margin-bottom: 20px;">Live Preview</h4>
        <button class="btn btn-secondary" onclick="previewResume()" style="width: 100%;">View PDF</button>
      </div>
    </div>

    <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 30px;">
      <button class="btn btn-secondary" onclick="editResume()" style="opacity: 0.7;">
        <i class="fas fa-edit"></i> Edit Details
      </button>
    </div>
  </div>

  </div>

  <script>
    // Version: 2024-12-02-v4 - Complete fillFormWithImportedData function fix
    // Last updated: 2024-12-02 20:45
    // CACHE BUSTER: If you see broken code, hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)

    console.log('ðŸ”¥ Resume Builder v4 Loaded - 2024-12-02 20:45');
    console.log('âœ… fillFormWithImportedData function: COMPLETE AND WORKING');

    // Global state
    let selectedTemplate = null;

    // ========== BACKEND CONFIGURATION ==========
    // Point to the integrated Gateway's Resume API
    const BACKEND_URL = window.location.origin + '/api/resume';

    console.log('ðŸŒ Backend URL:', BACKEND_URL);
    console.log('ðŸ”§ Mode: Using Integrated Gateway');

    // Add quick backend health ping (non-blocking, silent failure)
    // Only run if page is loaded via http/https (not file://)
    (async () => {
      // Skip health check if opened via file:// protocol (CORS will fail)
      if (window.location.protocol === 'file:') {
        console.log('â„¹ï¸ Skipping health check (file:// protocol)');
        return;
      }

      try {
        const backendUrl = BACKEND_URL;
        console.log('ðŸ” Checking backend health at:', backendUrl + '/health');

        const r = await fetch(backendUrl + '/health', {
          cache: 'no-store',
          method: 'GET',
          mode: 'cors',
          headers: {
            'Accept': 'application/json'
          }
        });

        if (r.ok) {
          const data = await r.json();
          console.log('âœ… Backend health check passed:', backendUrl, data);
        } else {
          console.warn('âš ï¸ Health endpoint returned:', r.status, 'for', backendUrl);
        }
      } catch (e) {
        // Silent failure - don't show error if backend is not accessible yet
        // This is just a health check, not critical for functionality
        // Common reasons: CORS, network error, server not running
        console.debug('â„¹ï¸ Backend health check skipped (non-critical):', e.message);
      }
    })();

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear authentication
        localStorage.removeItem('token');
        localStorage.removeItem('user');

        // Clear any resume builder data
        localStorage.removeItem('selectedTemplate');

        // Redirect to login
        window.location.href = '/dashboard/login.html';
      }
    }

    // Check authentication on page load
    function checkAuthentication() {
      const token = localStorage.getItem('token') || localStorage.getItem('jwtToken');
      const user = localStorage.getItem('user');

      if (!token || !user) {
        // Not logged in - redirect to login
        alert('Please login to access the resume builder');
        window.location.href = '/dashboard/login.html';
        return false;
      }
      return true;
    }

    // Initialize page - always start at Step 1 (template selection)
    function initializePage() {
      // Always show template selection first
      document.getElementById('templateSelection').style.display = 'block';
      document.getElementById('formStepIndicator').style.display = 'none';
      document.querySelector('.main-layout').style.display = 'none';
      document.querySelector('.bottom-actions').style.display = 'none';

      // Remove the back button if it exists
      const existingBackBtn = document.getElementById('backToTemplatesBtn');
      if (existingBackBtn) {
        existingBackBtn.remove();
      }

      // Clear any previous template selection when returning to Step 1
      // (User can select a different template)
      selectedTemplate = null;

      // Reset category to 'all' and shuffle for a dynamic experience
      const allBtn = document.querySelector('.category-btn[data-category="all"]');
      if (allBtn) {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        allBtn.classList.add('active');
        const cards = document.querySelectorAll('.template-card');
        cards.forEach(card => card.style.display = 'block');
      }

      if (typeof shuffleTemplates === 'function') {
        shuffleTemplates();
      }

      console.log('Page initialized - showing Step 1 (template selection)');

      // Ensure history state is set to Step 1
      if (history.state === null || history.state.step !== 1) {
        history.replaceState({ step: 1 }, '', '');
      }
    }

    // Template selection functionality
    document.addEventListener('DOMContentLoaded', function () {
      // Check if user is logged in
      if (!checkAuthentication()) {
        return; // Stop execution if not authenticated
      }

      // Initialize page to Step 1
      initializePage();

      // ==================== BROWSER BACK BUTTON HANDLING ====================
      // Push initial state to prevent direct back to index.html
      history.pushState({ step: 1 }, '', '');

      // Handle browser back/forward button
      window.addEventListener('popstate', function (event) {
        // Prevent going back to index.html
        event.preventDefault();

        // Check which step we're currently on
        const formVisible = document.querySelector('.main-layout').style.display !== 'none';
        const templateVisible = document.getElementById('templateSelection').style.display !== 'none';

        if (formVisible) {
          // User is on Step 2 (form), go back to Step 1 (template selection)
          console.log('Browser back button pressed - returning to Step 1');
          initializePage();

          // Push state again to maintain control
          history.pushState({ step: 1 }, '', '');
        } else {
          // User is on Step 1, prevent going back to index.html
          console.log('Already on Step 1 - preventing further back navigation');

          // Ask user for confirmation before leaving
          const confirmLeave = confirm('Do you want to leave the resume builder? Your progress will be saved.');
          if (confirmLeave) {
            // Clear localStorage if needed and redirect to dashboard/index
            window.location.href = 'index.html';
          } else {
            // Stay on current page
            history.pushState({ step: 1 }, '', '');
          }
        }
      });

      // Prevent accidental back navigation from touch gestures (mobile/trackpad)
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;

      document.addEventListener('touchstart', function (e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      document.addEventListener('touchend', function (e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleGesture();
      }, { passive: true });

      function handleGesture() {
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;

        // Detect horizontal swipe (typical back gesture)
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
          // Right swipe detected (potential back gesture)
          if (diffX > 0) {
            // Check if we should allow this
            const formVisible = document.querySelector('.main-layout').style.display !== 'none';
            if (formVisible) {
              // On Step 2, swipe should go to Step 1
              console.log('Swipe detected on Step 2 - returning to Step 1');
              initializePage();
              history.pushState({ step: 1 }, '', '');
            }
          }
        }
      }

      // Prevent mouse-based back navigation (two-finger swipe on trackpad)
      let gestureStarted = false;

      document.addEventListener('gesturestart', function (e) {
        e.preventDefault();
        gestureStarted = true;
      });

      document.addEventListener('gesturechange', function (e) {
        if (gestureStarted) {
          e.preventDefault();
        }
      });

      document.addEventListener('gestureend', function (e) {
        e.preventDefault();
        gestureStarted = false;
      });

      // ==================== END BACK BUTTON HANDLING ====================

      // Category filtering
      document.querySelectorAll('.category-btn').forEach(btn => {
        if (btn.id === 'shuffleBtn') {
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            shuffleTemplates();
          });
          return;
        }

        btn.addEventListener('click', function () {
          // Update active category
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          // Filter templates
          const category = this.dataset.category;
          const cards = document.querySelectorAll('.template-card');

          cards.forEach(card => {
            if (category === 'all' || card.dataset.category === category) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        });
      });

      function shuffleTemplates() {
        const grid = document.getElementById('templatesGrid');
        const cards = Array.from(grid.children);

        // Fisher-Yates shuffle
        for (let i = cards.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          grid.appendChild(cards[j]);
        }

        console.log('ðŸŽ² Templates shuffled randomly');

        // Add a nice animation effect
        cards.forEach(card => {
          card.style.animation = 'none';
          card.offsetHeight; // trigger reflow
          card.style.animation = 'premiumGlow 0.5s ease-out';
        });
      }

      // Add the animation to CSS
      const style = document.createElement('style');
      style.textContent = `
        @keyframes premiumGlow {
          0% { transform: scale(0.95); opacity: 0.5; filter: brightness(1.5); }
          100% { transform: scale(1); opacity: 1; filter: brightness(1); }
        }
      `;
      document.head.appendChild(style);

      // Mix them up initially
      shuffleTemplates();

      // Load saved skip states
      ['summary', 'experience', 'education', 'skills', 'projects', 'additional'].forEach(sec => {
        if (localStorage.getItem('skip_section_' + sec) === 'true') {
          const el = document.getElementById('section-' + sec);
          const link = el?.querySelector('.skip-link');
          if (el && link) {
            el.classList.add('skipped');
            link.textContent = 'Show section';
          }
        }
      });

      ['address', 'linkedin', 'website', 'certifications', 'languages', 'projects', 'achievements', 'hobbies'].forEach(field => {
        if (localStorage.getItem('skip_field_' + field) === 'true') {
          const group = document.getElementById('group-' + field);
          const input = document.getElementById(field);
          const label = group?.querySelector('label');
          const skipSpan = label?.querySelector('.field-skip');

          if (group && input && skipSpan) {
            group.classList.add('skipped');
            skipSpan.textContent = 'Show';
            // Note: Field value will be restored when user clicks "Show" using the improved skipField function
          }
        } else {
          // Restore field value if not skipped
          const input = document.getElementById(field);
          const savedValue = localStorage.getItem('field_value_' + field);
          if (input && savedValue !== null) {
            input.value = savedValue;
          }
        }
      });
    });

    // Template preview functionality with fallback static preview
    async function previewTemplate(templateId) {
      // Template metadata
      const templateDetails = {
        'classic': {
          name: 'Classic Professional',
          description: 'Clean, traditional layout perfect for any industry',
          style: 'Traditional serif fonts, centered header, clean sections'
        },
        'minimal': {
          name: 'Minimal',
          description: 'Ultra-clean design with excellent readability',
          style: 'Minimalist design, sans-serif fonts, lots of whitespace'
        },
        'modern-pro': {
          name: 'Modern Professional',
          description: 'Contemporary design with subtle colors',
          style: 'Modern layout, accent colors, professional styling'
        },
        'tech-focus': {
          name: 'Tech Focus',
          description: 'Designed specifically for developers',
          style: 'Code-friendly layout, technical sections, modern fonts'
        },
        'creative-bold': {
          name: 'Creative Bold',
          description: 'Eye-catching design for creative professionals',
          style: 'Bold typography, creative layout, vibrant colors'
        },
        'portfolio-style': {
          name: 'Portfolio Style',
          description: 'Showcase your work with visual elements',
          style: 'Visual-first design, project showcase, modern layout'
        },
        'ats-optimized': {
          name: 'ATS Optimized',
          description: 'Designed to pass Applicant Tracking Systems',
          style: 'Simple structure, ATS-friendly format, clear sections'
        },
        'corporate-ats': {
          name: 'Corporate ATS',
          description: 'Professional corporate design that\'s ATS-compatible',
          style: 'Corporate styling, ATS-compatible, professional look'
        },
        'elegant-gradient': {
          name: 'Elegant Gradient',
          description: 'Beautiful gradient design with elegant typography',
          style: 'Gradient accents, elegant fonts, sophisticated design'
        },
        'minimalist-mono': {
          name: 'Minimalist Mono',
          description: 'Ultra-minimalist monochrome design',
          style: 'Black and white, minimal elements, clean typography'
        },
        'rishi': {
          name: 'Hiero Modern',
          description: 'Modern tech layout with purple gradient sidebar',
          style: 'Two-column design, purple gradient, blue accents, Inter font'
        },
        'priya': {
          name: 'Priya Elegant',
          description: 'Classic serif design with elegant typography and traditional layout',
          style: 'Georgia serif fonts, centered header, elegant spacing, academic style'
        },
        'priya-analytics': {
          name: 'Hiero Analytics',
          description: 'Single-column layout with a grey top bar and bold section headings. Ideal for data-driven professionals.',
          style: 'Single-column, grey top bar, bold section headings with horizontal rules, matching the Priya Sharma data analyst resume style'
        },
        'hiero-monethon': {
          name: 'Hiero Monethon',
          description: 'Premium layout with vibrant orange accents and a dominant navy sidebar.',
          style: 'Two-column, orange profile header, navy sidebar with progress skill bars'
        },
        'hiero-timeline': {
          name: 'Hiero Minimal',
          description: 'Elegant vertical timeline layout with a professional grayscale design. Ideal for clean, corporate presentation.',
          style: 'Vertical timeline, grayscale design, circular nodes, and professional alignment.'
        },

        'hiero-executive': {
          name: 'Hiero Executive',
          description: 'Premium corporate side-label layout inspired by Morgan Maxwell.',
          style: 'Left labels, clean headers, corporate type, and elegant delimiters.'
        },
        'hiero-studio': {
          name: 'Hiero Studio',
          description: 'Contemporary tech-focused side-label design for a modern professional look.',
          style: 'Side-by-side structure, bold titles, and balanced professional spacing.'
        },
        'hiero-onyx': {
          name: 'Hiero Onyx',
          description: 'Bold high-contrast side-label design for maximum professional impact.',
          style: 'Professional structure, high-contrast black accents, and premium spacing.'
        },
        'template4': {
          name: 'Hiero Academic',
          description: 'High-fidelity technical layout with centered headers and split subsections.',
          style: 'Times New Roman, centered header, academic split layout, and ATS-optimized structure.'
        },
        'hiero-classic': {
          name: 'Hiero Classic',
          description: 'Traditional professional resume with timeless design. Perfect for conventional industries.',
          style: 'Classic layout, professional fonts, standard sections.'
        },
        'hiero-minimal': {
          name: 'Hiero Minimal',
          description: 'Clean minimalist design with maximum white space. Emphasizes content with subtle sophistication.',
          style: 'Clean lines, lots of white space, modern typography.'
        },
        'hiero-tech': {
          name: 'Hiero Tech',
          description: 'Developer-focused template with code-style aesthetics. Optimized for software engineers.',
          style: 'Monospace fonts, tech-inspired layout, project-focused.'
        },
        'hiero-bold': {
          name: 'Hiero Bold',
          description: 'Eye-catching design with bold typography and strong visual hierarchy.',
          style: 'Bold fonts, high contrast, strong section headers.'
        },
        'hiero-elite': {
          name: 'Hiero Elite',
          description: 'Premium executive template with luxury design elements. Ideal for C-level executives.',
          style: 'Luxury aesthetics, gold accents, premium typography.'
        },
        'hiero-retail': {
          name: 'Hiero Retail Timeline',
          description: 'Clean formatting with clear timeline layout. Ideal for retail professionals.',
          style: 'Timeline structure, left profile, distinctive border.'
        },
        'hiero-vision': {
          name: 'Hiero Vision',
          description: 'Creative layout with visual storytelling approach. Perfect for designers and marketers.',
          style: 'Visual segments, creative spacing, storytelling layout.'
        },
        'hiero-compact': {
          name: 'Hiero Compact',
          description: 'Space-efficient design that fits more content in less space. Great for extensive history.',
          style: 'Tight spacing, multi-column sections, compact fonts.'
        },
        'hiero-premium': {
          name: 'Hiero Premium',
          description: 'High-end professional design with sophisticated styling. Features elegant typography.',
          style: 'Premium fonts, elegant layout, subtle sophisticated accents.'
        },
        'hiero-prestige': {
          name: 'Hiero Prestige',
          description: 'Distinguished design for top-tier professionals. Combines classic elegance with modern sophistication.',
          style: 'Elegant sans-serif hierarchy, dark charcoal sidebar, flat corporate design, vertical timeline layout.'
        },
        'hiero-signature': {
          name: 'Hiero Signature',
          description: 'Modern minimalist A4 portrait with a bold two-column split layout. Features a grayscale aesthetic with bold orange accents and a vertical timeline.',
          style: 'Two-column, orange accents, vertical section titles, grayscale profile photo.'
        },
        'hiero-essence': {
          name: 'Hiero Essence',
          description: 'Modern corporate design with a distinctive dark sidebar and orange accent bars. Perfect for a structured professional presentation.',
          style: 'Two-column layout, dark sidebar (#1F1F1F), orange accents (#F5A623), clean typography.'
        },
        'hiero-aurora': {
          name: 'Hiero Aurora',
          description: 'Modern gradient design with fluid layouts. Perfect for forward-thinking professionals.',
          style: 'Fluid gradients, soft shadows, modern sans-serif type.'
        },
        'hiero-zenith': {
          name: 'Hiero Zenith',
          description: 'Top-tier executive layout for industry leaders. Combines power with elegance.',
          style: 'Bold headers, spacious layout, authoritative typography.'
        },
        'hiero-nebula': {
          name: 'Hiero Nebula',
          description: 'Space-inspired technical layout for space-tech and high-end engineering.',
          style: 'Deep space accents, technical grids, futuristic feel.'
        },
        'hiero-quantum': {
          name: 'Hiero Quantum',
          description: 'Precision data-driven layout for scientists and analysts.',
          style: 'Mathematical precision, grid-based layout, analytical fonts.'
        },
        'hiero-velocity': {
          name: 'Hiero Velocity',
          description: 'Fast-paced professional design for high-growth startup environments.',
          style: 'Dynamic lines, energetic spacing, modern professional type.'
        },
        'hiero-prism': {
          name: 'Hiero Prism',
          description: 'Multi-faceted creative layout showcasing diverse skill sets.',
          style: 'Colorful accents, multi-pane layout, creative flair.'
        },
        'hiero-orbit': {
          name: 'Hiero Orbit',
          description: 'Modern layout with circular design elements for a unique professional brand.',
          style: 'Rounded corners, orbital layouts, soft professional colors.'
        },
        'hiero-titan': {
          name: 'Hiero Titan',
          description: 'Large, bold, and powerful layout for making a significant impact.',
          style: 'Oversized headers, strong borders, impactful hierarchy.'
        },
        'hiero-apollo': {
          name: 'Hiero Apollo',
          description: 'Academic excellence and research-focused layout for scholars.',
          style: 'Traditionalå­¦æœ¯ (academic) structure, refined serif type.'
        },
        'hiero-orion': {
          name: 'Hiero Orion',
          description: 'Stellar professional design for high-achievers across all fields.',
          style: 'Clean professional structure, stellar accents, premium feel.'
        },
        'hiero-nova': {
          name: 'Hiero Legion',
          description: 'A sophisticated monochrome design with a bold shield profile and a strong vertical badge.',
          style: 'Modern monochrome, high-contrast black accents, shield profile mask.'
        }

      };


      const template = templateDetails[templateId];
      if (!template) return;

      // Create modal with loading state
      const modal = document.createElement('div');
      modal.className = 'preview-modal-overlay';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: rgba(0,0,0,0.85); display: flex; align-items: center; 
        justify-content: center; z-index: 10000; padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: #111111; border: 1px solid #333; border-radius: 16px; max-width: 950px; width: 100%; 
                    max-height: 90vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 30px 60px rgba(0,0,0,0.8);">
          <div style="padding: 25px 30px; border-bottom: 1px solid #222; flex-shrink: 0; background: linear-gradient(to right, #111, #1a1a1a);">
            <button onclick="this.closest('.preview-modal-overlay').remove()" 
                    style="position: absolute; top: 20px; right: 20px; background: #222; 
                           border: none; font-size: 20px; cursor: pointer; color: #fff; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;"
                    onmouseover="this.style.background='#ff4d4d';"
                    onmouseout="this.style.background='#222';">Ã—</button>
            <h2 style="margin: 0 0 5px 0; color: #fff; font-size: 24px; font-weight: 700; letter-spacing: -0.5px;">${template.name}</h2>
            <p style="margin: 0; color: #888; font-size: 14px;">Premium Design â€¢ High Fidelity Preview</p>
          </div>
          <div id="preview-content" style="flex: 1; overflow-y: auto; padding: 40px; display: flex; justify-content: center; align-items: flex-start; background: #0a0a0a; min-height: 500px; scrollbar-width: thin; scrollbar-color: #333 #0a0a0a;">
            <div style="text-align: center; color: #888; padding: 80px 20px;">
              <div class="spinner-container" style="margin-bottom: 20px;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 48px; color: #2ae023;"></i>
              </div>
              <p style="font-size: 16px; font-weight: 500;">Crafting your professional preview...</p>
            </div>
          </div>
          <div style="padding: 25px 30px; background: #161616; border-top: 1px solid #222; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;">
            <div style="color: #666; font-size: 13px;">Selected: <span style="color: #2ae023;">${template.name}</span></div>
            <button onclick="startBuilding('${templateId}'); this.closest('.preview-modal-overlay').remove();" 
                    style="background: linear-gradient(135deg, #2ae023 0%, #1a9e16 100%); color: white; border: none; padding: 14px 40px; 
                           border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(42,224,35,0.4);"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(42,224,35,0.5)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(42,224,35,0.4)';">
              Start Building with This Template
            </button>
          </div>
        </div>
`;


      modal.addEventListener('click', function (e) {
        if (e.target === modal) modal.remove();
      });

      document.body.appendChild(modal);

      // Try to fetch preview from backend, with fallback to static preview
      let previewLoaded = false;

      try {
        console.log('ðŸ” Fetching preview for template:', templateId);

        // Sample data tailored for different templates
        let sampleData = {
          template: templateId,
          personalInfo: {
            fullName: 'John Doe',
            email: 'john.doe@example.com',
            phone: '(555) 123-4567'
          },
          address: 'San Francisco, CA',
          linkedin: 'linkedin.com/in/johndoe',
          summary: 'Results-driven professional with 5+ years of experience in software development and team leadership. Proven track record of delivering scalable solutions and improving system performance.',
          experience: [
            {
              jobTitle: 'Senior Software Engineer',
              company: 'Tech Innovations Inc.',
              startDate: '2022-01',
              endDate: 'Present',
              description: 'â€¢ Led development of microservices architecture serving 1M+ users\nâ€¢ Improved system performance by 40% through optimization\nâ€¢ Mentored team of 5 junior developers'
            },
            {
              jobTitle: 'Software Engineer',
              company: 'StartupXYZ',
              startDate: '2020-06',
              endDate: '2021-12',
              description: 'â€¢ Developed full-stack web applications using React and Node.js\nâ€¢ Implemented RESTful APIs and database optimization\nâ€¢ Collaborated with cross-functional teams in Agile environment'
            }
          ],
          education: [
            {
              degree: 'Bachelor of Science in Computer Science',
              school: 'University of Technology',
              gradYear: '2020',
              gpa: '3.8/4.0'
            }
          ],
          technicalSkills: 'JavaScript, React, Node.js, Python, AWS, Docker, MongoDB, PostgreSQL, Git, CI/CD (Jenkins, GitHub Actions), RESTful APIs, GraphQL, Microservices Architecture',
          softSkills: 'Leadership, Communication, Problem-solving, Team collaboration, Project management',
          projects: 'E-commerce Platform: Built full-stack application with 10K+ users\nTask Management App: Developed mobile-responsive SaaS product',
          certifications: 'AWS Certified Solutions Architect, Google Cloud Professional'
        };

        // Customize sample data for Morgan Maxwell style templates
        if (templateId === 'hiero-executive' || templateId === 'hiero-studio' || templateId === 'hiero-onyx') {
          sampleData = {
            template: templateId,
            personalInfo: {
              fullName: 'Morgan Maxwell',
              email: 'hello@reallygreatsite.com',
              phone: '+123 456 7890',
              website: 'reallygreatsite.com'
            },
            address: '123 Anywhere ST, Any city ST 12345',
            summary: 'Recent graduate in Statistics with strong analytical and problem-solving skills. Proficient in using analytical software and data visualization tools. Experienced in cleaning, analyzing, and interpreting large datasets through academic projects and internships. Meticulous, passionate about applying data-driven insights to support business decisions.',
            experience: [
              {
                jobTitle: 'Civil Engineering Intern',
                company: 'Larana Company, Any city',
                startDate: 'Feb 2023',
                endDate: 'Jul 2023',
                description: 'Assisted in preparing technical drawings using Fauget software CAD.\nSupported project site supervision and reported daily construction progress.\nHelped estimate material quantities and costs for residential projects.\nCollaborated with engineers to review design compliance with safety standards.'
              }
            ],
            education: [
              {
                degree: 'Bachelor of Statistics',
                school: 'Fauget University',
                gradYear: '2020 - 2024'
              },
              {
                degree: 'Borcelle School',
                school: 'Larana City',
                gradYear: '2017 - 2019'
              }
            ],
            technicalSkills: 'Proficient in using engineering and design software.\nAble to create technical drawings and structural calculations.\nSkilled in preparing cost estimates and material requirements.\nPossesses basic knowledge of project management.\nAble to analyze field data to support technical decisions.\nAccustomed to preparing technical reports systematically.'
          };
        }
        // Customize sample data for Priya template (elegant academic style)
        else if (templateId === 'priya') {
          sampleData = {
            template: 'priya',
            personalInfo: {
              fullName: 'Priya Sharma',
              rollNo: '191401001',
              program: 'Computer Science',
              course: 'B.Tech',
              institute: 'Indian Institute of Information Technology, Vadodara',
              phone: '+91-9876543210',
              email: 'priya.sharma@iitvadodara.ac.in',
              officialEmail: '191401001@iitvadodara.ac.in',
              github: 'github.com/priyasharma',
              linkedin: 'linkedin.com/in/priyasharma',
              languages: 'C, C++, Python, Java, JavaScript',
              developerTools: 'Git, VS Code, IntelliJ IDEA, Eclipse',
              frameworks: 'React, Node.js, Django, Spring Boot',
              cloudDatabases: 'AWS, Firebase, MySQL, MongoDB',
              softSkills: 'Communication, Leadership, Problem-solving, Teamwork'
            },
            education: [
              {
                institute: 'Indian Institute of Information Technology, Vadodara',
                degree: 'B.Tech in Computer Science',
                details: 'CGPA: 8.5/10.0',
                dates: '2019 - 2023'
              },
              {
                institute: 'Delhi Public School',
                degree: 'All India Senior School Certificate Examination',
                details: 'Percentage: 92%',
                dates: '2019'
              },
              {
                institute: 'Delhi Public School',
                degree: 'All India Secondary School Examination',
                details: 'Percentage: 94%',
                dates: '2017'
              }
            ],
            experience: [
              {
                company: 'TechCorp Solutions',
                role: 'Full Stack Developer Intern',
                location: 'Bangalore',
                dates: 'May 2022 - July 2022',
                points: ['Developed responsive web applications using React and Node.js', 'Optimized database queries improving performance by 30%', 'Collaborated with team to deliver client requirements']
              }
            ],
            projects: [
              {
                title: 'AI-Powered Study Assistant',
                description: 'Developed a machine learning based study assistant',
                technologies: 'Python, TensorFlow, React, MongoDB',
                dates: '2022-2023'
              },
              {
                title: 'E-Commerce Platform',
                description: 'Built a full-stack e-commerce solution',
                technologies: 'React, Node.js, Express, MongoDB',
                dates: '2021-2022'
              }
            ],
            achievements: [
              'Winner of Inter-College Hackathon 2022',
              'Published research paper on AI in peer-reviewed journal',
              'Awarded Best Project in Software Engineering course'
            ],
            extraCurricular: [
              'President of Coding Club',
              'Volunteer at Local Tech Community Center',
              'Active participant in competitive programming'
            ],
            softSkills: [
              'Self-motivated and eager to learn new technologies',
              'Strong problem-solving and analytical skills',
              'Excellent collaboration and communication abilities'
            ]
          };
        }

        // Add timeout to fetch request (increased for ngrok)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
          console.warn('â±ï¸ Preview request timeout after 90 seconds');
        }, 90000); // 90 seconds for ngrok

        const response = await fetch(`${BACKEND_URL}/preview-resume`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/pdf'
          },
          body: JSON.stringify(sampleData),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const blob = await response.blob();
        const previewUrl = URL.createObjectURL(blob);

        console.log('âœ… Preview blob created for:', templateId);

        // Update preview content with iframe
        const previewContent = modal.querySelector('#preview-content');

        // Clear loading state
        previewContent.innerHTML = '';

        // Mobile detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
          // On mobile, iframes can be tricky, but HTML usually works well
          const mobileMsg = document.createElement('div');
          mobileMsg.style.cssText = 'text-align: center; padding: 40px 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px dashed #2ae023; margin: 20px 0;';
          mobileMsg.innerHTML = `
            <i class="fas fa-mobile-alt" style="font-size: 48px; color: #2ae023; margin-bottom: 20px; display: block;"></i>
            <p style="color: #2c3e50; margin-bottom: 25px; font-size: 16px;">Preview work best in a dedicated tab on some mobile devices.</p>
            <a href="${previewUrl}" target="_blank" class="btn btn-primary" style="display:inline-flex; width: auto; padding: 12px 24px; background: #2ae023; color: white; text-decoration: none; border-radius: 8px;">
              <i class="fas fa-external-link-alt"></i> Open Preview
            </a>
          `;
          previewContent.appendChild(mobileMsg);
        } else {
          // Create iframe element for desktop
          const iframe = document.createElement('iframe');
          iframe.style.cssText = 'width: 100%; height: 650px; border: none; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); background: white;';
          iframe.src = previewUrl;
          previewContent.appendChild(iframe);

          // Add a fallback link below the iframe just in case
          const fallback = document.createElement('div');
          fallback.style.cssText = 'text-align: right; margin-top: 10px; font-size: 13px;';
          fallback.innerHTML = `<a href="${previewUrl}" target="_blank" style="color: #2ae023; text-decoration: underline;">Open in new tab if not loading</a>`;
          previewContent.appendChild(fallback);
        }

        previewLoaded = true;

        // Cleanup URL when modal is closed
        const originalRemove = modal.remove;
        modal.remove = function () {
          URL.revokeObjectURL(previewUrl);
          originalRemove.call(this);
        };

      } catch (error) {
        console.error('âŒ Error fetching preview:', error, 'URL:', BACKEND_URL + '/preview-resume');

        const previewContent = modal.querySelector('#preview-content');

        // Check error type
        const isTimeout = error.name === 'AbortError';
        const isNetworkError = isTimeout || error.message.includes('fetch') || error.message.includes('Failed to fetch');

        // Show fallback static preview
        previewContent.innerHTML = `
          <div style="width: 100%; max-width: 700px; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 20px rgba(0,0,0,0.1);">
            <div style="text-align: center; margin-bottom: 30px;">
              <div style="display: inline-block; padding: 12px 24px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                <p style="margin: 0; color: #856404; font-size: 14px; font-weight: 500;">
                  <i class="fas fa-info-circle"></i> ${isTimeout ? 'Request timed out - server took too long to respond' : isNetworkError ? 'Backend server not responding' : 'Preview temporarily unavailable'}
                </p>
              </div>
              <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 22px;">${template.name}</h3>
              <p style="margin: 0 0 20px 0; color: #7f8c8d; font-size: 14px;">${template.style}</p>
            </div>
            
            <div style="border: 2px dashed #e0e0e0; border-radius: 8px; padding: 30px; background: #fafafa;">
              <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2ae023;">
                <h1 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 28px;">Your Name Here</h1>
                <p style="margin: 0; color: #7f8c8d; font-size: 14px;">email@example.com | (555) 123-4567 | Location</p>
              </div>
              
              <div style="margin-bottom: 20px;">
                <h2 style="margin: 0 0 10px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Professional Summary</h2>
                <p style="margin: 0; color: #555; line-height: 1.6; font-size: 14px;">
                  Your professional summary will appear here with your key qualifications, years of experience, and main areas of expertise.
                </p>
              </div>
              
              <div style="margin-bottom: 20px;">
                <h2 style="margin: 0 0 15px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Work Experience</h2>
                <div style="margin-bottom: 15px;">
                  <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">Job Title</h3>
                  <p style="margin: 0 0 5px 0; color: #7f8c8d; font-size: 14px;">Company Name | 2020 - Present</p>
                  <p style="margin: 0; color: #555; font-size: 14px; line-height: 1.5;">
                    â€¢ Your key responsibilities and achievements<br>
                    â€¢ Measurable results and impacts<br>
                    â€¢ Technologies and skills used
                  </p>
                </div>
              </div>
              
              <div style="margin-bottom: 20px;">
                <h2 style="margin: 0 0 15px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Education</h2>
                <div>
                  <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">Degree Name</h3>
                  <p style="margin: 0; color: #7f8c8d; font-size: 14px;">University Name | Graduation Year</p>
                </div>
              </div>
              
              <div>
                <h2 style="margin: 0 0 10px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Skills</h2>
                <p style="margin: 0; color: #555; font-size: 14px; line-height: 1.6;">
                  Your technical and soft skills will be displayed here in a clean, organized format.
                </p>
              </div>
            </div>
            
            ${isNetworkError ? `
            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #2ae023;">
              <p style="margin: 0 0 8px 0; color: #2c5e2e; font-size: 13px; font-weight: 600;">
                ðŸ’¡ To see the actual template preview:
              </p>
              <p style="margin: 0; color: #2c5e2e; font-size: 12px; line-height: 1.5;">
                Make sure the backend server is running. You can still select this template to continue building your resume.
              </p>
            </div>
            ` : ''}
          </div>
        `;
      }
    }

    // Note: Template preview is now fetched from backend via /preview-resume API
    // The previewTemplate() function above handles fetching and rendering

    // ========== Auto-fill imported resume data into form ==========
    function fillFormWithImportedData(data) {
      console.log("ðŸŽ¯ Filling form with imported data:", data);

      // Personal Info
      document.getElementById("fullName").value = data.personalInfo?.fullName || "";
      document.getElementById("email").value = data.personalInfo?.email || "";
      document.getElementById("phone").value = data.personalInfo?.phone || "";
      document.getElementById("address").value = data.personalInfo?.address || "";
      document.getElementById("linkedin").value = data.personalInfo?.linkedin || "";
      document.getElementById("website").value = data.personalInfo?.website || "";

      // Summary
      document.getElementById("summary").value = data.summary || "";

      // Experience
      const expSection = document.getElementById("section-experience");
      if (data.experience && data.experience.length > 0 && expSection && expSection.classList.contains('skipped')) {
        toggleSection('experience');
      }
      const expContainer = document.getElementById("experienceContainer");
      expContainer.innerHTML = "";
      (data.experience || []).forEach((exp, i) => {

        addExperience();
        document.getElementsByName("jobTitle[]")[i].value = exp.jobTitle || "";
        document.getElementsByName("company[]")[i].value = exp.company || "";

        // Handle Start Date
        const startDateInput = document.getElementsByName("startDate[]")[i];
        if (exp.startDate) {
          // Attempt to normalize date for type="month" (YYYY-MM)
          const date = exp.startDate.match(/\d{4}-\d{2}/) ? exp.startDate : "";
          startDateInput.value = date;
        }

        // Handle End Date & Checkbox
        const endDateInput = document.getElementsByName("endDate[]")[i];
        const currentCheckbox = document.getElementById(`current${i + 1}`);
        if (exp.endDate && (exp.endDate.toLowerCase().includes('present') || exp.endDate.toLowerCase().includes('current'))) {
          if (currentCheckbox) {
            currentCheckbox.checked = true;
            toggleWorking(currentCheckbox); // Trigger UI change
          }
          endDateInput.value = "";
        } else if (exp.endDate) {
          const date = exp.endDate.match(/\d{4}-\d{2}/) ? exp.endDate : "";
          endDateInput.value = date;
        }

        document.getElementsByName("jobDescription[]")[i].value = exp.description || "";
      });

      // Education
      const eduSection = document.getElementById("section-education");
      if (data.education && data.education.length > 0 && eduSection && eduSection.classList.contains('skipped')) {
        toggleSection('education');
      }
      const eduContainer = document.getElementById("educationContainer");
      eduContainer.innerHTML = "";
      (data.education || []).forEach((edu, i) => {

        addEducation();
        document.getElementsByName("degree[]")[i].value = edu.degree || "";
        document.getElementsByName("school[]")[i].value = edu.school || "";
        document.getElementsByName("gradYear[]")[i].value = edu.gradYear || "";
        document.getElementsByName("gpa[]")[i].value = edu.gpa || "";
      });

      // Skills
      document.getElementById("technicalSkills").value = data.technicalSkills || "";
      document.getElementById("softSkills").value = data.softSkills || "";

      // Projects
      const projSection = document.getElementById("section-projects");
      if (data.projects && data.projects.length > 0 && projSection && projSection.classList.contains('skipped')) {
        toggleSection('projects');
      }
      const projContainer = document.getElementById("projectsContainer");
      projContainer.innerHTML = "";
      (data.projects || []).forEach((project, i) => {

        addProject();
        document.getElementsByName("projectName[]")[i].value = project.name || "";
        document.getElementsByName("projectTech[]")[i].value = project.tech || "";
        document.getElementsByName("projectDuration[]")[i].value = project.duration || "";
        document.getElementsByName("projectDescription[]")[i].value = project.description || "";
        document.getElementsByName("projectLink[]")[i].value = project.link || "";
        document.getElementsByName("projectAchievement[]")[i].value = project.achievement || "";
      });

      // Additional Information
      document.getElementById("certifications").value = (data.certifications || []).join(", ");
      document.getElementById("languages").value = (data.languages || []).join(", ");
      document.getElementById("achievements").value = data.achievements || "";
      document.getElementById("hobbies").value = data.hobbies || "";

      console.log("âœ”ï¸ Auto-fill completed successfully");
    }

    // Start building with selected template
    function startBuilding(templateId) {
      selectedTemplate = templateId;

      // Save selected template to localStorage (for PDF generation)
      localStorage.setItem('selectedTemplate', templateId);

      console.log('âœ… Template selected:', templateId);

      // Show import resume modal first
      showImportResumeModal();
    }

    // Helper function to get template display name
    function getTemplateName(templateId) {
      const names = {
        'classic': 'Classic Professional',
        'minimal': 'Minimal',
        'modern-pro': 'Modern Professional',
        'tech-focus': 'Tech Focus',
        'creative-bold': 'Creative Bold',
        'portfolio-style': 'Portfolio Style',
        'ats-optimized': 'ATS Optimized',
        'corporate-ats': 'Corporate ATS',
        'elegant-gradient': 'Elegant Gradient',
        'minimalist-mono': 'Minimalist Mono',
        'rishi': 'Hiero Modern',
        'priya': 'Priya Elegant',
        'priya-analytics': 'Hiero Analytics (Single Column)',
        'hiero-studio': 'Hiero Studio',
        'template4': 'Hiero Academic',
        'hiero-monethon': 'Hiero Monethon',
        'hiero-essence': 'Hiero Essence'

      };
      return names[templateId] || 'Selected';
    }

    // Show modal asking if user has an old resume
    function showImportResumeModal() {
      const modal = document.createElement('div');
      modal.id = 'importResumeModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      `;

      modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(42,224,35,0.3);">
          <h2 style="margin: 0 0 20px 0; color: #2ae023; font-size: 24px; text-align: center;">
            <i class="fas fa-file-upload"></i> Do you have an old resume?
          </h2>
          <p style="color: #bbb; text-align: center; margin-bottom: 25px; line-height: 1.6;">
            Upload your existing resume and we'll auto-fill the form for you!<br>
            <span style="font-size: 14px; color: #888;">Supports PDF, DOCX, and images</span>
          </p>
          
          <div style="margin-bottom: 25px;">
            <label style="color: #2ae023; font-size: 14px; display: block; margin-bottom: 10px; font-weight: 600;">Optional: Paste Job Description for matching</label>
            <textarea id="importJobDescription" placeholder="Paste the JD here to see how well you match..." style="width: 100%; height: 80px; background: rgba(0,0,0,0.3); border: 1px solid rgba(42,224,35,0.2); border-radius: 10px; color: #fff; padding: 12px; font-size: 14px; outline: none; resize: none;"></textarea>
          </div>
          
          <div style="display: flex; gap: 15px; flex-direction: column;">
            <label for="resumeFileInput" style="background: linear-gradient(135deg, #2ae023 0%, #06a529 100%); color: #fff; padding: 18px; border-radius: 12px; cursor: pointer; text-align: center; font-weight: 700; transition: all 0.3s ease; border: none; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
              <i class="fas fa-upload"></i> Yes, Upload My Resume
            </label>
            <input type="file" id="resumeFileInput" accept=".pdf,.doc,.docx,image/*" style="display: none;">
            
            <button id="proceedWithoutImportBtn" style="background: rgba(255,255,255,0.05); color: #fff; padding: 15px; border-radius: 12px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); font-weight: 600; transition: all 0.3s ease; font-size: 14px;">
              <i class="fas fa-edit"></i> No, I'll Fill It Manually
            </button>
          </div>
          
          <div id="uploadStatus" style="margin-top: 20px; padding: 15px; border-radius: 10px; display: none; text-align: center;"></div>
        </div>
      `;

      document.body.appendChild(modal);

      // Close modal when clicking the backdrop (outside the content box)
      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          console.log('ðŸ”µ Backdrop clicked, closing modal...');
          closeImportModal();
        }
      });

      // Handle "No, I'll Fill It Manually" button click
      document.getElementById('proceedWithoutImportBtn').addEventListener('click', function (e) {
        console.log('ðŸŸ¢ "No, I\'ll Fill It Manually" button clicked');
        e.preventDefault();
        e.stopPropagation();
        proceedToFormWithoutImport();
      });

      // Handle ESC key to close modal
      const escHandler = function (e) {
        if (e.key === 'Escape') {
          console.log('ðŸ”µ ESC pressed, closing modal...');
          closeImportModal();
          document.removeEventListener('keydown', escHandler);
        }
      };
      document.addEventListener('keydown', escHandler);

      // Handle file upload
      document.getElementById('resumeFileInput').addEventListener('change', async function (e) {
        e.preventDefault();
        e.stopPropagation();
        const file = e.target.files[0];
        if (!file) return;

        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'rgba(42,224,35,0.1)';
        statusDiv.style.color = '#2ae023';
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing your resume...';

        try {
          const formData = new FormData();
          formData.append('resume', file);
          const jd = document.getElementById('importJobDescription')?.value || '';
          if (jd) formData.append('jobDescription', jd);


          // Use LOCAL backend for import to get "Perfect Extraction" logic
          // The production backend doesn't have the new AI logic yet.
          const IMPORT_URL = `${BACKEND_URL}/import`;
          console.log('ðŸš€ Importing resume via:', IMPORT_URL);

          const token = localStorage.getItem('token') || localStorage.getItem('jwtToken');
          const response = await fetch(IMPORT_URL, {
            method: 'POST',
            headers: {
              'Authorization': token ? `Bearer ${token}` : ''
            },
            body: formData
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Upload failed');
          }

          const result = await response.json();

          if (result.success && result.data) {
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Resume imported successfully!';

            // Store the imported data and analysis
            localStorage.setItem('importedResumeData', JSON.stringify(result.data));
            if (result.analysis) localStorage.setItem('resumeAnalysis', JSON.stringify(result.analysis));

            // Close modal and show form after a short delay
            setTimeout(() => {
              closeImportModal();
              proceedToForm();

              // Fill form after a short delay to ensure form fields are created
              setTimeout(() => {
                const importedData = JSON.parse(localStorage.getItem('importedResumeData'));
                const analysisData = JSON.parse(localStorage.getItem('resumeAnalysis'));

                if (importedData) {
                  fillFormWithImportedData(importedData);
                  localStorage.removeItem('importedResumeData');

                  if (analysisData) {
                    showAnalysisPopup(analysisData);
                    localStorage.removeItem('resumeAnalysis');
                  }
                }
              }, 500);
            }, 1000);
          } else {
            throw new Error('Invalid response from server');
          }
        } catch (error) {
          console.error('Import error:', error);
          statusDiv.style.background = 'rgba(239,68,68,0.1)';
          statusDiv.style.color = '#ef4444';

          // Show detailed error message with helpful tips
          let errorMessage = error.message;

          // Check if it's a text extraction error
          if (errorMessage.includes('Unable to extract text') || errorMessage.includes('Could not extract text')) {
            statusDiv.innerHTML = `
              <div style="text-align: left;">
                <div style="margin-bottom: 10px;">
                  <i class="fas fa-exclamation-circle"></i> <strong>Cannot read this resume file</strong>
                </div>
                <div style="font-size: 13px; line-height: 1.5; margin-bottom: 15px;">
                  This resume may be:
                  <ul style="margin: 5px 0 0 20px; padding: 0;">
                    <li>A scanned image PDF (no selectable text)</li>
                    <li>Password-protected or corrupted</li>
                    <li>In an unsupported format</li>
                  </ul>
                </div>
                <button onclick="proceedToFormWithoutImport()" style="
                  background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-weight: 600;
                  width: 100%;
                  font-size: 14px;
                ">
                  <i class="fas fa-edit"></i> Fill Form Manually Instead
                </button>
              </div>
            `;
          } else {
            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMessage}`;
          }
        }
      });
    }

    // Close import modal
    function closeImportModal() {
      console.log('ðŸ”µ Attempting to close import modal...');
      const modal = document.getElementById('importResumeModal');
      if (modal) {
        console.log('âœ… Modal found, removing...');
        modal.remove();
        console.log('âœ… Modal removed successfully');
      } else {
        console.warn('âš ï¸ Modal not found with id "importResumeModal"');
      }
    }

    // Proceed to form without importing
    function proceedToFormWithoutImport() {
      console.log('ðŸ”µ proceedToFormWithoutImport called');
      try {
        closeImportModal();
        console.log('ðŸ”µ Modal closed, proceeding to form...');
        proceedToForm();
      } catch (error) {
        console.error('âŒ Error in proceedToFormWithoutImport:', error);
        alert('Error: ' + error.message);
      }
    }

    // Show ATS Analysis & Match Score Popup
    function showAnalysisPopup(analysis) {
      const popup = document.createElement('div');
      popup.id = 'analysisPopup';
      popup.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 350px;
        background: #1a1a2e;
        border: 2px solid #2ae023;
        border-radius: 20px;
        padding: 25px;
        z-index: 9999;
        box-shadow: 0 15px 50px rgba(0,0,0,0.5);
        color: white;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(150%);
      `;

      const scoreColor = analysis.score > 70 ? '#2ae023' : analysis.score > 40 ? '#ffa500' : '#ef4444';
      const matchHtml = analysis.matchingScore !== undefined ? `
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: 14px; opacity: 0.8;">JD Match Score</span>
            <span style="font-weight: 800; color: #3b82f6;">${analysis.matchingScore}%</span>
          </div>
          <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
            <div style="width: ${analysis.matchingScore}%; height: 100%; background: #3b82f6;"></div>
          </div>
        </div>
      ` : '';

      const suggestionsHtml = analysis.suggestions.slice(0, 3).map(s => `
        <li style="font-size: 12px; margin-bottom: 8px; color: #cbd5e1; list-style: none; display: flex; gap: 8px;">
          <i class="fas fa-lightbulb" style="color: #ffd700; font-size: 10px; margin-top: 3px;"></i>
          <span>${s}</span>
        </li>
      `).join('');

      popup.innerHTML = `
        <div style="position: relative;">
          <button onclick="this.closest('#analysisPopup').remove()" style="position: absolute; top: -15px; right: -15px; background: #ef4444; color: white; border: none; width: 24px; height: 24px; border-radius: 12px; cursor: pointer; font-size: 12px;"><i class="fas fa-times"></i></button>
          
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; margin-bottom: 5px;">ATS Strength Score</div>
            <div style="font-size: 42px; font-weight: 800; color: ${scoreColor};">${analysis.score}%</div>
          </div>

          ${matchHtml}

          <div style="margin-top: 20px;">
            <div style="font-size: 13px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
               <i class="fas fa-chart-line" style="color: #2ae023;"></i> Success Suggestions
            </div>
            <ul style="padding: 0; margin: 0;">
              ${suggestionsHtml}
            </ul>
          </div>

          <button onclick="this.closest('#analysisPopup').remove()" style="width: 100%; margin-top: 20px; background: rgba(42,224,35,0.1); border: 1px solid #2ae023; color: #2ae023; padding: 10px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 13px;">Got it, let's refine!</button>
        </div>
      `;

      document.body.appendChild(popup);
      setTimeout(() => popup.style.transform = 'translateY(0)', 100);
    }

    // Show the form (Step 2)
    function proceedToForm() {
      console.log('ðŸ”µ Moving from Step 1 â†’ Step 2');
      console.log('ðŸ”µ Selected template:', selectedTemplate);

      try {
        // Check if template is selected
        if (!selectedTemplate) {
          // Try to recover from localStorage
          selectedTemplate = localStorage.getItem('selectedTemplate');
          console.log('ðŸ”„ Recovered template from localStorage:', selectedTemplate);
        }

        if (!selectedTemplate) {
          console.error('âŒ No template selected!');
          alert('Please select a template first');
          // Fallback: show template selection
          document.getElementById('templateSelection').style.display = 'block';
          return;
        }

        // Hide template selection (Step 1)
        const templateSelection = document.getElementById('templateSelection');
        if (templateSelection) {
          templateSelection.style.display = 'none';
          console.log('âœ… Template selection hidden');
        } else {
          console.error('âŒ templateSelection element not found');
        }

        // Show form step indicator and form (Step 2)
        const formStepIndicator = document.getElementById('formStepIndicator');
        if (formStepIndicator) {
          formStepIndicator.style.display = 'block';
          console.log('âœ… Form step indicator shown');
        } else {
          console.error('âŒ formStepIndicator element not found');
        }

        const mainLayout = document.querySelector('.main-layout');
        if (mainLayout) {
          mainLayout.style.display = 'grid';
          console.log('âœ… Main layout shown');
        } else {
          console.error('âŒ main-layout element not found');
        }

        const bottomActions = document.querySelector('.bottom-actions');
        if (bottomActions) {
          bottomActions.style.display = 'flex';
          console.log('âœ… Bottom actions shown');
        } else {
          console.error('âŒ bottom-actions element not found');
        }

        // Initialize photo if previously uploaded
        initPhotoFromStorage();

        // Update step indicator with template info
        const templateName = getTemplateName(selectedTemplate);
        console.log('âœ… Template name:', templateName);

        const stepText = document.querySelector('#formStepIndicator .step-text');
        if (stepText) {
          stepText.textContent = `Step 2: Fill Your Information (Using ${templateName} template)`;
          console.log('âœ… Step text updated');
        } else {
          console.error('âŒ step-text element not found');
        }

        // Add a back button to return to Step 1
        addBackToTemplatesButton();
        console.log('âœ… Back button added');

        // Push history state for Step 2 (enables proper back button behavior)
        history.pushState({ step: 2, template: selectedTemplate }, '', '');
        console.log('âœ… History state pushed');

        // Scroll to form
        setTimeout(() => {
          const mainLayoutScroll = document.querySelector('.main-layout');
          if (mainLayoutScroll) {
            mainLayoutScroll.scrollIntoView({ behavior: 'smooth' });
            console.log('âœ… Scrolled to form');
          }
        }, 100);

        console.log('âœ…âœ…âœ… proceedToForm completed successfully!');

      } catch (error) {
        console.error('âŒ Error in proceedToForm:', error);
        alert('Error proceeding to form: ' + error.message);
      }
    }

    // Fill form with imported resume data (Auto-fill) â€” v2025-12-02
    function fillFormWithImportedData(data) {
      try {
        console.log("ðŸŽ¯ Filling form with imported data", data);

        // Preserve selected template before clearing form
        const preservedTemplate = selectedTemplate || localStorage.getItem('selectedTemplate');

        clearForm(true); // Clear existing without prompt to prevent duplicates

        // Restore template
        if (preservedTemplate) {
          selectedTemplate = preservedTemplate;
          localStorage.setItem('selectedTemplate', preservedTemplate);
          console.log("âœ… Fixed: Preserved template during import:", selectedTemplate);
        }

        const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ""; };

        // 1. Personal Information
        setVal("fullName", data.personalInfo?.fullName);
        setVal("email", data.personalInfo?.email);
        setVal("phone", data.personalInfo?.phone);

        if (data.personalInfo?.address) {
          data.personalInfo.address = data.personalInfo.address.replace(/^(Contact|Address)[\s\n]*/gi, '').trim();
        }
        if (data.summary) {
          data.summary = data.summary.replace(/^(RETAIL PROFESSIONAL)[\s\n]*/gi, '').trim();
        }
        if (data.personalInfo?.website && !data.personalInfo.website.startsWith('http') && data.personalInfo.website.length > 3) {
          data.personalInfo.website = 'https://' + data.personalInfo.website;
        }
        setVal("address", data.personalInfo?.address);
        setVal("linkedin", data.personalInfo?.linkedin);
        setVal("website", data.personalInfo?.website);

        // 2. Summary & Skills
        setVal("summary", data.summary);

        let techSkills = data.technicalSkills || "";
        if (!techSkills && data.skills) {
          techSkills = Array.isArray(data.skills) ? data.skills.join(", ") : data.skills;
        }
        setVal("technicalSkills", techSkills);
        setVal("softSkills", data.softSkills);

        // 3. Additional Information Fields
        const certs = Array.isArray(data.certifications) ? data.certifications.join(", ") : (data.certifications || "");
        const langs = Array.isArray(data.languages) ? data.languages.join(", ") : (data.languages || "");
        setVal("certifications", certs);
        setVal("languages", langs);
        setVal("achievements", data.achievements);
        setVal("hobbies", data.hobbies);

        const extras = Array.isArray(data.extraCurricular) ? data.extraCurricular.join("\n") : (data.extraCurricular || "");
        setVal("extraCurricular", extras);

        // 4. Experience (Dynamic)
        const expContainer = document.getElementById("experienceContainer");
        if (expContainer) {
          expContainer.innerHTML = "";
          const experiences = Array.isArray(data.experience) ? data.experience : [];
          experiences.forEach((exp, i) => {
            addExperience();
            const jobs = document.querySelectorAll("[name='jobTitle[]']");
            const companies = document.querySelectorAll("[name='company[]']");
            const starts = document.querySelectorAll("[name='startDate[]']");
            const ends = document.querySelectorAll("[name='endDate[]']");
            const descs = document.querySelectorAll("[name='jobDescription[]']");
            if (jobs[i]) jobs[i].value = exp.jobTitle || "";
            if (companies[i]) companies[i].value = exp.company || "";
            if (starts[i]) starts[i].value = exp.startDate || "";

            if (ends[i]) {
              const isPresent = exp.endDate === 'Present' || !exp.endDate;
              if (isPresent) {
                const checkbox = expContainer.querySelectorAll('.experience-item')[i].querySelector('input[type="checkbox"]');
                if (checkbox) {
                  checkbox.checked = true;
                  toggleWorking(checkbox);
                }
              } else {
                ends[i].value = exp.endDate || "";
              }
            }

            if (descs[i]) descs[i].value = (exp.description || exp.responsibilities || "");
          });
        }

        // 5. Education (Dynamic)
        const eduContainer = document.getElementById("educationContainer");
        if (eduContainer) {
          eduContainer.innerHTML = "";
          const education = Array.isArray(data.education) ? data.education : [];
          education.forEach((edu, i) => {
            addEducation();
            const degrees = document.querySelectorAll("[name='degree[]']");
            const schools = document.querySelectorAll("[name='school[]']");
            const years = document.querySelectorAll("[name='gradYear[]']");
            const gpas = document.querySelectorAll("[name='gpa[]']");
            if (degrees[i]) degrees[i].value = edu.degree || "";
            if (schools[i]) schools[i].value = edu.school || "";
            if (years[i]) years[i].value = edu.gradYear || "";
            if (gpas[i]) gpas[i].value = edu.gpa || "";
          });
        }

        // 5b. Internships (Dynamic)
        const internContainer = document.getElementById("internshipsContainer");
        if (internContainer) {
          internContainer.innerHTML = "";
          const internships = Array.isArray(data.internships) ? data.internships : [];
          if (internships.length > 0) {
            const section = document.getElementById('section-internships');
            if (section && section.classList.contains('skipped')) toggleSection('internships');
          }
          internships.forEach((intern, i) => {
            addInternship();
            const roles = document.querySelectorAll("[name='internRole[]']");
            const orgs = document.querySelectorAll("[name='internOrg[]']");
            const starts = document.querySelectorAll("[name='internStart[]']");
            const ends = document.querySelectorAll("[name='internEnd[]']");
            const descs = document.querySelectorAll("[name='internDesc[]']");
            if (roles[i]) roles[i].value = intern.jobTitle || intern.role || "";
            if (orgs[i]) orgs[i].value = intern.company || intern.org || "";
            if (starts[i]) starts[i].value = intern.startDate || intern.start || "";
            if (ends[i]) ends[i].value = intern.endDate || intern.end || "";
            if (descs[i]) descs[i].value = intern.description || intern.desc || "";
          });
        }


        // 6. Custom/Additional (Fallback System)
        if (data.customSectionContent) {
          const customArea = document.getElementById("customSectionContent");
          if (customArea) {
            customArea.value = data.customSectionContent;
            // Ensure section is visible
            const customSection = document.getElementById("section-custom");
            if (customSection && customSection.style.display === 'none') {
              toggleSection('custom');
            }
          }
        }

        // 6. Projects (Dynamic)
        const projContainer = document.getElementById("projectsContainer");
        if (projContainer) {
          projContainer.innerHTML = "";
          const projects = Array.isArray(data.projects) ? data.projects : [];
          projects.forEach((project, i) => {
            addProject();
            const names = document.getElementsByName("projectName[]");
            const techs = document.getElementsByName("projectTech[]");
            const durations = document.getElementsByName("projectDuration[]");
            const descs = document.getElementsByName("projectDescription[]");
            const links = document.getElementsByName("projectLink[]");
            const achs = document.getElementsByName("projectAchievement[]");
            if (names[i]) names[i].value = project.name || "";
            if (techs[i]) techs[i].value = project.tech || project.technologies || "";
            if (durations[i]) durations[i].value = project.duration || "";
            if (descs[i]) descs[i].value = project.description || "";
            if (links[i]) links[i].value = project.link || "";
            if (achs[i]) achs[i].value = project.achievement || "";
          });
        }

        // 7. References (Dynamic)
        if (Array.isArray(data.references) && data.references.length) {
          const refContainer = document.getElementById('referencesContainer');
          if (refContainer) {
            refContainer.innerHTML = '';
            data.references.forEach((ref, i) => {
              addReference();
              const names = document.getElementsByName('refName[]');
              const titles = document.getElementsByName('refTitle[]');
              const companies = document.getElementsByName('refCompany[]');
              const phones = document.getElementsByName('refPhone[]');
              const emails = document.getElementsByName('refEmail[]');
              if (names[i]) names[i].value = ref.name || '';
              if (titles[i]) titles[i].value = ref.title || '';
              if (companies[i]) companies[i].value = ref.company || '';
              if (phones[i]) phones[i].value = ref.phone || '';
              if (emails[i]) emails[i].value = ref.email || '';
            });
          }
        }

        // 8. Custom Details (Dynamic)
        if (Array.isArray(data.customDetails) && data.customDetails.length) {
          const customContainer = document.getElementById('customDetailsContainer');
          if (customContainer) {
            customContainer.innerHTML = '';
            data.customDetails.forEach((detail, i) => {
              addCustomDetail();
              const headings = document.getElementsByName('customHeading[]');
              const contents = document.getElementsByName('customContent[]');
              if (headings[i]) headings[i].value = detail.heading || '';
              if (contents[i]) contents[i].value = detail.content || '';
            });
          }
        }

        // 9. Custom Sections from LLM (Dynamic)
        if (data.customSections && Array.isArray(data.customSections) && data.customSections.length > 0) {
          const first = data.customSections[0];
          setVal('customSectionTitle', first.title || 'Custom Section');
          setVal('customSectionContent', Array.isArray(first.items) ? first.items.join('\nâ€¢ ') : (first.items || ''));

          if (data.customSections.length > 1) {
            const others = data.customSections.slice(1).map(s => `${s.title}:\n${Array.isArray(s.items) ? s.items.join(', ') : s.items}`).join('\n\n');
            const additional = document.getElementById('additionalInfo');
            if (additional) additional.value = (additional.value ? additional.value + '\n\n' : '') + others;
          }
        }

        // 10. Auto-skip/show Logic

        // Sections
        const sectionsToCheck = [
          { key: 'summary', id: 'section-summary' },
          { key: 'experience', id: 'section-experience' },
          { key: 'education', id: 'section-education' },
          { key: 'projects', id: 'section-projects' },
          { key: 'skills', id: 'section-skills', checkKey: 'technicalSkills' },
          { key: 'additionalDetails', id: 'section-additional-details', checkKey: 'certifications' },
          { key: 'additional', id: 'section-additional', checkKey: 'achievements' },
          { key: 'references', id: 'section-references' },
          { key: 'customDetails', id: 'section-custom' }
        ];

        sectionsToCheck.forEach(sec => {
          const checkKey = sec.checkKey || sec.key;
          const val = data[checkKey];
          const isEmpty = !val || (Array.isArray(val) && val.length === 0) || (typeof val === 'string' && !val.trim());

          const el = document.getElementById(sec.id);
          if (el) {
            const link = el.querySelector('.skip-link');
            if (isEmpty) {
              if (!el.classList.contains('skipped') && link) link.click();
            } else {
              if (el.classList.contains('skipped') && link) link.click();
            }
          }
        });

        // Individual Fields
        const fieldsToCheck = [
          { key: 'address', groupId: 'group-address', parent: 'personalInfo' },
          { key: 'linkedin', groupId: 'group-linkedin', parent: 'personalInfo' },
          { key: 'website', groupId: 'group-website', parent: 'personalInfo' },
          { key: 'certifications', groupId: 'group-certifications' },
          { key: 'languages', groupId: 'group-languages' },
          { key: 'achievements', groupId: 'group-achievements' },
          { key: 'hobbies', groupId: 'group-hobbies' },
          { key: 'extraCurricular', groupId: 'group-extraCurricular' }
        ];

        fieldsToCheck.forEach(field => {
          const val = field.parent ? data[field.parent]?.[field.key] : data[field.key];
          const isEmpty = !val || (typeof val === 'string' && !val.trim());
          const group = document.getElementById(field.groupId);
          if (group) {
            const skipSpan = group.querySelector('.field-skip');
            if (isEmpty) {
              if (!group.classList.contains('skipped') && skipSpan) skipField(field.key);
            } else {
              if (group.classList.contains('skipped') && skipSpan) skipField(field.key);
            }
          }
        });

        console.log("âœ”ï¸ Auto-fill completed successfully");
        alert('âœ… Imported resume data has been filled into the form. Review and generate your resume.');

        // 11. Final UI Update
        const templateSelection = document.getElementById('templateSelection');
        const formStepIndicator = document.getElementById('formStepIndicator');
        const mainLayout = document.querySelector('.main-layout');
        const bottomActions = document.querySelector('.bottom-actions');

        if (templateSelection) templateSelection.style.display = 'none';
        if (formStepIndicator) formStepIndicator.style.display = 'block';
        if (mainLayout) mainLayout.style.display = 'grid';
        if (bottomActions) bottomActions.style.display = 'flex';

        history.pushState({ step: 2, template: localStorage.getItem('selectedTemplate') }, '', '');
        localStorage.setItem('resumeData', JSON.stringify(data));

      } catch (err) {
        console.error('âŒ Error in fillFormWithImportedData:', err);
        alert('âŒ Failed to auto-fill form: ' + err.message);
      }
    }

    // Add back button to return to template selection
    function addBackToTemplatesButton() {
      // Check if button already exists
      if (document.getElementById('backToTemplatesBtn')) return;

      const stepIndicator = document.getElementById('formStepIndicator');
      const backBtn = document.createElement('button');
      backBtn.id = 'backToTemplatesBtn';
      backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Change Template';
      backBtn.style.cssText = `
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(42, 224, 35, 0.1);
        color: #2ae023;
        border: 1px solid rgba(42, 224, 35, 0.4);
        padding: 8px 16px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(4px);
      `;
      backBtn.setAttribute('aria-label', 'Return to template selection');
      backBtn.onclick = () => {
        // Return to Step 1
        initializePage();
      };
      backBtn.onmouseenter = () => {
        backBtn.style.background = '#2ae023';
        backBtn.style.color = '#000';
      };
      backBtn.onmouseleave = () => {
        backBtn.style.background = 'rgba(45,196,44,0.2)';
        backBtn.style.color = '#2ae023';
      };

      stepIndicator.appendChild(backBtn);
    }

    // ----------  SECTION SKIP / SHOW  ----------
    function toggleSection(section) {
      const el = document.getElementById('section-' + section);
      if (!el) return;
      const link = el.querySelector('.skip-link');
      if (!link) return;

      const willBeSkipped = !el.classList.contains('skipped');
      el.classList.toggle('skipped', willBeSkipped);
      link.textContent = willBeSkipped ? 'Show section' : 'Skip this section';
      localStorage.setItem('skip_section_' + section, willBeSkipped);
    }


    // ----------  PHOTO UPLOAD HANDLER  ----------
    let uploadedPhotoData = null; // Store photo as base64

    function initPhotoFromStorage() {
      const storedPhoto = localStorage.getItem('profilePhoto');
      if (storedPhoto) {
        uploadedPhotoData = storedPhoto;
        const photoPreview = document.getElementById('photoPreview');
        if (photoPreview) {
          photoPreview.classList.add('has-image');
          const existingImg = photoPreview.querySelector('img');
          if (existingImg) {
            existingImg.src = storedPhoto;
          } else {
            const img = document.createElement('img');
            img.src = storedPhoto;
            photoPreview.appendChild(img);
          }
        }

        // Show AI Button & description (unless it's already an AI photo)
        if (localStorage.getItem('ai_photo_formalized') === 'true') {
          const badge = document.getElementById('aiPhotoBadge');
          if (badge) {
            badge.style.display = 'block';
            badge.innerHTML = '<i class="fas fa-crown"></i> <strong>EXECUTIVE PHOTO:</strong> Your AI Formalized photo is active.';
            badge.style.background = 'rgba(255, 215, 0, 0.1)';
            badge.style.borderColor = '#ffd700';
            badge.style.color = '#ffd700';
          }
        } else {
          const aiBtn = document.getElementById('aiFormalizeBtn');
          if (aiBtn) aiBtn.style.display = 'flex';
          const aiDesc = document.getElementById('aiPhotoDesc');
          if (aiDesc) aiDesc.style.display = 'block';
        }
      }
    }

    function handlePhotoUpload(event) {
      const file = event.target.files[0];
      const photoPreview = document.getElementById('photoPreview');
      const photoStatus = document.getElementById('photoStatus');

      // Clear previous status
      photoStatus.textContent = '';
      photoStatus.className = 'photo-status';

      if (!file) return;

      // Validate file type
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
      if (!validTypes.includes(file.type)) {
        photoStatus.textContent = 'âŒ Invalid format. Please upload JPG or PNG only.';
        photoStatus.classList.add('error');
        event.target.value = ''; // Clear the input
        return;
      }

      // Validate file size (minimum 50KB)
      const minSize = 50 * 1024; // 50KB in bytes
      if (file.size < minSize) {
        photoStatus.textContent = `âŒ Photo too small. Minimum ${Math.round(minSize / 1024)}KB required.`;
        photoStatus.classList.add('error');
        event.target.value = '';
        return;
      }

      // Maximum size check (5MB)
      const maxSize = 5 * 1024 * 1024; // 5MB
      if (file.size > maxSize) {
        photoStatus.textContent = 'âŒ Photo too large. Maximum 5MB allowed.';
        photoStatus.classList.add('error');
        event.target.value = '';
        return;
      }

      // Read and display photo
      const reader = new FileReader();

      reader.onload = function (e) {
        // Store photo data
        uploadedPhotoData = e.target.result;

        // Display preview
        photoPreview.classList.add('has-image');
        const existingImg = photoPreview.querySelector('img');
        if (existingImg) {
          existingImg.src = e.target.result;
        } else {
          const img = document.createElement('img');
          img.src = e.target.result;
          photoPreview.appendChild(img);
        }

        // Show success message
        const fileSizeKB = Math.round(file.size / 1024);
        photoStatus.textContent = `âœ“ Photo uploaded successfully (${fileSizeKB}KB)`;
        photoStatus.classList.add('success');

        // Show AI Button and Badge
        document.getElementById('aiFormalizeBtn').style.display = 'flex';
        document.getElementById('aiPhotoBadge').style.display = 'block';

        // Save to localStorage
        localStorage.setItem('profilePhoto', uploadedPhotoData);
      };

      reader.onerror = function () {
        photoStatus.textContent = 'âŒ Failed to load photo. Please try again.';
        photoStatus.classList.add('error');
      };

      reader.readAsDataURL(file);
    }

    // ----------  FIELD SKIP / SHOW  ----------
    function skipField(field) {
      // Special handling for photo upload
      if (field === 'profilePhoto') {
        const photoSection = document.querySelector('.photo-upload-section');
        if (!photoSection) return;

        const label = photoSection.querySelector('label');
        const skipSpan = label?.querySelector('.field-skip');
        if (!skipSpan) return;

        const willBeSkipped = !photoSection.classList.contains('skipped');
        photoSection.classList.toggle('skipped', willBeSkipped);
        skipSpan.textContent = willBeSkipped ? 'Show' : 'Skip';

        localStorage.setItem('skip_field_profilePhoto', willBeSkipped);
        return;
      }

      // Normal field handling
      const group = document.getElementById('group-' + field);
      const input = document.getElementById(field);
      if (!group || !input) return;

      const label = group.querySelector('label');
      const skipSpan = label?.querySelector('.field-skip');
      if (!skipSpan) return;

      const willBeSkipped = !group.classList.contains('skipped');
      group.classList.toggle('skipped', willBeSkipped);
      skipSpan.textContent = willBeSkipped ? 'Show' : 'Skip';

      // ---- restore value when showing again ----
      if (!willBeSkipped) {
        const saved = localStorage.getItem('field_value_' + field);
        if (saved !== null) input.value = saved;
      } else {
        // save current value before hiding
        localStorage.setItem('field_value_' + field, input.value);
        input.value = '';
      }

      localStorage.setItem('skip_field_' + field, willBeSkipped);
    }

    // Toggle working here checkbox
    function toggleWorking(checkbox) {
      const parent = checkbox.closest('.experience-item') || checkbox.closest('.dynamic-item');
      if (!parent) return;
      const endDateInput = parent.querySelector('input[name="endDate[]"]');
      if (endDateInput) {
        if (checkbox.checked) {
          endDateInput.style.opacity = '0.5';
          endDateInput.style.pointerEvents = 'none';
          endDateInput.disabled = true;
          endDateInput.value = '';
          endDateInput.placeholder = 'Present';
        } else {
          endDateInput.style.opacity = '1';
          endDateInput.style.pointerEvents = 'auto';
          endDateInput.disabled = false;
          endDateInput.placeholder = '';
        }
      }
    }

    // Add Experience / Education
    let expCount = 1, eduCount = 1;
    function addExperience() {
      expCount++;
      const container = document.getElementById('experienceContainer');
      const div = document.createElement('div');
      div.className = 'experience-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" aria-label="Remove entry" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-row">
          <div class="form-group"><label>Job Title</label><input type="text" name="jobTitle[]" placeholder="Software Engineer"></div>
          <div class="form-group"><label>Company</label><input type="text" name="company[]" placeholder="Company Name"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Start Date</label><input type="month" name="startDate[]"></div>
          <div class="form-group"><label>End Date</label><input type="month" name="endDate[]"></div>
        </div>
        <div class="checkbox-container">
          <label>
            <input type="checkbox" onchange="toggleWorking(this)"> Currently working here
          </label>
        </div>
        <div class="form-group"><label>Description</label><textarea name="jobDescription[]" rows="4" placeholder="Key achievements..."></textarea></div>
      `;
      container.appendChild(div);
    }


    function addEducation() {
      eduCount++;
      const container = document.getElementById('educationContainer');
      const div = document.createElement('div');
      div.className = 'education-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" aria-label="Remove entry" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-row">
          <div class="form-group"><label>Degree</label><input type="text" name="degree[]" placeholder="Bachelor of Science"></div>
          <div class="form-group"><label>School</label><input type="text" name="school[]" placeholder="University Name"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Year</label><input type="number" name="gradYear[]" min="1950" max="2030" placeholder="2024"></div>
          <div class="form-group"><label>GPA</label><input type="text" name="gpa[]" placeholder="3.8/4.0"></div>
        </div>
      `;
      container.appendChild(div);
    }

    function addInternship() {
      const container = document.getElementById('internshipsContainer');
      const div = document.createElement('div');
      div.className = 'internship-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" aria-label="Remove entry" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-row">
          <div class="form-group"><label>Intern Role</label><input type="text" name="internRole[]" placeholder="Software Intern"></div>
          <div class="form-group"><label>Organization</label><input type="text" name="internOrg[]" placeholder="Tech Solutions"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Start Date</label><input type="month" name="internStart[]"></div>
          <div class="form-group"><label>End Date</label><input type="month" name="internEnd[]"></div>
        </div>
        <div class="form-group"><label>Description</label><textarea name="internDesc[]" rows="4" placeholder="Key contributions..."></textarea></div>
      `;
      container.appendChild(div);
    }


    // Add Reference
    let refCount = 1;
    function addReference() {
      refCount++;
      const container = document.getElementById('referencesContainer');
      const div = document.createElement('div');
      div.className = 'reference-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" aria-label="Remove entry" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-row">
          <div class="form-group"><label>Reference Name</label><input type="text" name="refName[]" placeholder="John Smith"></div>
          <div class="form-group"><label>Title/Position</label><input type="text" name="refTitle[]" placeholder="Senior Manager"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Company</label><input type="text" name="refCompany[]" placeholder="Company Name"></div>
          <div class="form-group"><label>Phone</label><input type="tel" name="refPhone[]" placeholder="(555) 123-4567" pattern="[\+]?[\d\s\-\(\)\.]+" title="Please enter a valid phone number"></div>
        </div>
        <div class="form-group"><label>Email</label><input type="email" name="refEmail[]" placeholder="reference@company.com" title="Please enter a valid email address"></div>
      `;
      container.appendChild(div);
    }

    // Add Project
    let projectCount = 1;
    function addProject() {
      projectCount++;
      const container = document.getElementById('projectsContainer');
      const div = document.createElement('div');
      div.className = 'project-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" aria-label="Remove entry" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-group">
          <label>Project Name <span class="required">*</span></label>
          <input type="text" name="projectName[]" placeholder="E-commerce Platform" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Technologies Used</label>
            <input type="text" name="projectTech[]" placeholder="React, Node.js, MongoDB">
          </div>
          <div class="form-group">
            <label>Duration/Year</label>
            <input type="text" name="projectDuration[]" placeholder="6 months or 2023">
          </div>
        </div>
        <div class="form-group">
          <label>Project Description</label>
          <textarea name="projectDescription[]" rows="4" placeholder="Describe what the project does, key features, and your role..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>GitHub/Deployment Link (Optional)</label>
            <input type="url" name="projectLink[]" placeholder="https://github.com/username/project">
          </div>
          <div class="form-group">
            <label>Key Achievement/Metrics (Optional)</label>
            <input type="text" name="projectAchievement[]" placeholder="10K+ users, 40% performance improvement">
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    // Add Custom Detail
    let customCount = 1;
    function addCustomDetail() {
      customCount++;
      const container = document.getElementById('customDetailsContainer');
      const div = document.createElement('div');
      div.className = 'custom-detail-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" aria-label="Remove custom entry" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-group"><label>Item Heading</label><input type="text" name="customHeading[]" placeholder="e.g., Research Paper A"></div>
        <div class="form-group"><label>Content</label><textarea name="customContent[]" rows="4" placeholder="Describe the details..."></textarea></div>
      `;
      container.appendChild(div);
    }

    // Fill Sample Data - Comprehensive function to populate all form fields
    function fillSampleData() {
      try {
        if (!confirm('This will fill the form with sample data. Any existing data will be overwritten. Continue?')) {
          return;
        }

        console.log('ðŸ”„ Starting to fill sample data...');

        // Personal Information
        const fullNameEl = document.getElementById('fullName');
        const emailEl = document.getElementById('email');
        const phoneEl = document.getElementById('phone');

        if (!fullNameEl || !emailEl || !phoneEl) {
          console.error('âŒ Required form elements not found');
          alert('Error: Form elements not found. Please refresh the page and try again.');
          return;
        }

        fullNameEl.value = 'Rahul Mehta';
        emailEl.value = 'rahulmehta.ds@example.com';
        phoneEl.value = '+91 9876543210';

        const addressEl = document.getElementById('address');
        const linkedinEl = document.getElementById('linkedin');
        const websiteEl = document.getElementById('website');

        if (addressEl) addressEl.value = 'Bengaluru, India';
        if (linkedinEl) linkedinEl.value = 'linkedin.com/in/rahulmehta-ds';
        if (websiteEl) websiteEl.value = 'github.com/rahulmehta-ds';

        // Professional Summary
        const summaryEl = document.getElementById('summary');
        if (summaryEl) {
          summaryEl.value = 'Data Scientist with 2+ years of experience in predictive modeling, machine learning, and data analytics. Skilled in analyzing complex datasets, building end-to-end ML models, and communicating insights to business teams. Strong expertise in Python, statistics, A/B testing, and data visualization. Passionate about solving business problems using data-driven approaches.';
        }

        // Technical Skills
        const technicalSkillsEl = document.getElementById('technicalSkills');
        if (technicalSkillsEl) {
          technicalSkillsEl.value = 'Python, R, SQL, Regression, Classification, Clustering, Random Forest, XGBoost, Neural Networks, TensorFlow, PyTorch, scikit-learn, Pandas, NumPy, Matplotlib, Seaborn, Tableau, A/B Testing, Statistical Analysis, Hypothesis Testing, Data Mining, Data Visualization, Feature Engineering';
        }

        // Soft Skills
        const softSkillsEl = document.getElementById('softSkills');
        if (softSkillsEl) {
          softSkillsEl.value = 'Problem-solving, Communication, Analytical Thinking, Business Acumen, Data-driven Decision Making';
        }

        // Certifications
        const certificationsEl = document.getElementById('certifications');
        if (certificationsEl) {
          certificationsEl.value = 'IBM Data Science\nGoogle Data Analytics Professional Certificate\nTensorFlow Developer Certificate';
        }

        // Languages
        const languagesEl = document.getElementById('languages');
        if (languagesEl) {
          languagesEl.value = 'English, Hindi, Telugu';
        }

        // Projects - Use new structured format
        const projectsSection = document.getElementById('section-projects');
        if (projectsSection && projectsSection.classList.contains('skipped')) {
          toggleSection('projects');
        }

        setTimeout(() => {
          const projectsContainer = document.getElementById('projectsContainer');
          if (projectsContainer) {
            projectsContainer.innerHTML = '';

            const sampleProjects = [
              {
                name: 'Customer Churn Prediction Model',
                tech: 'Python, scikit-learn, Pandas, NumPy, Matplotlib',
                duration: '3 months',
                description: 'Built an end-to-end ML pipeline achieving 86% accuracy. Performed EDA, feature engineering, and hyperparameter tuning.',
                link: 'https://github.com/rahulmehta-ds/churn-prediction',
                achievement: '86% accuracy, improved customer retention by 18%'
              },
              {
                name: 'Fraud Detection System',
                tech: 'Python, scikit-learn, Clustering, Anomaly Detection',
                duration: '4 months',
                description: 'Implemented anomaly detection using clustering + supervised models. Reduced false positives by 12%.',
                link: 'https://github.com/rahulmehta-ds/fraud-detection',
                achievement: '12% reduction in false positives, improved detection accuracy'
              }
            ];

            sampleProjects.forEach((project, index) => {
              if (index > 0) addProject();

              setTimeout(() => {
                const allNames = document.querySelectorAll('input[name="projectName[]"]');
                const allTechs = document.querySelectorAll('input[name="projectTech[]"]');
                const allDurations = document.querySelectorAll('input[name="projectDuration[]"]');
                const allDescs = document.querySelectorAll('textarea[name="projectDescription[]"]');
                const allLinks = document.querySelectorAll('input[name="projectLink[]"]');
                const allAchievements = document.querySelectorAll('input[name="projectAchievement[]"]');

                if (allNames[index]) allNames[index].value = project.name;
                if (allTechs[index]) allTechs[index].value = project.tech;
                if (allDurations[index]) allDurations[index].value = project.duration;
                if (allDescs[index]) allDescs[index].value = project.description;
                if (allLinks[index]) allLinks[index].value = project.link;
                if (allAchievements[index]) allAchievements[index].value = project.achievement;
              }, 150 * index);
            });
          }
        }, 300);

        // Achievements
        const achievementsEl = document.getElementById('achievements');
        if (achievementsEl) {
          achievementsEl.value = 'Improved customer churn prediction by 18% through ML models\nIncreased conversion rate by 6.5% through A/B testing frameworks\nBuilt predictive dashboards analyzing 50M+ rows of data';
        }

        // Hobbies
        const hobbiesEl = document.getElementById('hobbies');
        if (hobbiesEl) {
          hobbiesEl.value = 'Contributing to open-source data science projects, Reading research papers on ML, Participating in Kaggle competitions';
        }

        // Clear existing experience and add comprehensive sample
        const expContainer = document.getElementById('experienceContainer');
        expContainer.innerHTML = '';

        const experiences = [
          {
            title: 'Data Scientist',
            company: 'TechNova Analytics',
            start: '2023-01',
            end: '',
            current: true,
            description: 'â€¢ Analyzed large datasets (50M+ rows) to identify trends and build predictive dashboards\nâ€¢ Developed machine learning models (classification & regression) improving customer churn prediction by 18%\nâ€¢ Performed feature engineering, model tuning, and evaluation using precision, recall, and ROC-AUC\nâ€¢ Implemented A/B testing frameworks to measure product improvements; increased conversion rate by 6.5%\nâ€¢ Built visualization dashboards using Matplotlib, Seaborn, and Tableau to support decision-making'
          },
          {
            title: 'Junior Data Analyst',
            company: 'DataWings Pvt Ltd',
            start: '2021-08',
            end: '2022-12',
            current: false,
            description: 'â€¢ Conducted exploratory data analysis (EDA) and identified business insights\nâ€¢ Automated data cleaning and transformation pipelines using Python and SQL\nâ€¢ Contributed to clustering models for customer segmentation'
          }
        ];

        experiences.forEach((exp, index) => {
          if (index > 0) addExperience();

          setTimeout(() => {
            const allTitles = document.querySelectorAll('input[name="jobTitle[]"]');
            const allCompanies = document.querySelectorAll('input[name="company[]"]');
            const allStarts = document.querySelectorAll('input[name="startDate[]"]');
            const allEnds = document.querySelectorAll('input[name="endDate[]"]');
            const allDescs = document.querySelectorAll('textarea[name="jobDescription[]"]');

            if (allTitles[index]) allTitles[index].value = exp.title;
            if (allCompanies[index]) allCompanies[index].value = exp.company;
            if (allStarts[index]) allStarts[index].value = exp.start;
            if (allEnds[index] && !exp.current) allEnds[index].value = exp.end;
            if (allDescs[index]) allDescs[index].value = exp.description;

            // Handle "currently working" checkbox
            if (exp.current && allEnds[index]) {
              const checkbox = allEnds[index].parentElement.querySelector('input[type="checkbox"]');
              if (checkbox) checkbox.checked = true;
            }
          }, 100 * index);
        });

        // Clear existing education and add comprehensive sample
        const eduContainer = document.getElementById('educationContainer');
        eduContainer.innerHTML = '';

        const education = [
          {
            degree: 'M.Sc. in Data Science',
            school: 'Christ University, Bengaluru',
            year: '2021',
            gpa: ''
          },
          {
            degree: 'B.Sc. in Computer Science',
            school: 'Osmania University, Hyderabad',
            year: '2019',
            gpa: ''
          }
        ];

        education.forEach((edu, index) => {
          if (index > 0) addEducation();

          setTimeout(() => {
            const allDegrees = document.querySelectorAll('input[name="degree[]"]');
            const allSchools = document.querySelectorAll('input[name="school[]"]');
            const allYears = document.querySelectorAll('input[name="gradYear[]"]');
            const allGPAs = document.querySelectorAll('input[name="gpa[]"]');

            if (allDegrees[index]) allDegrees[index].value = edu.degree;
            if (allSchools[index]) allSchools[index].value = edu.school;
            if (allYears[index]) allYears[index].value = edu.year;
            if (allGPAs[index]) allGPAs[index].value = edu.gpa;
          }, 100 * index);
        });

        // Fill Internship Sample Data
        const internSection = document.getElementById('section-internships');
        if (internSection && internSection.classList.contains('skipped')) {
          toggleSection('internships');
        }

        const internships = [
          {
            role: 'Product Management Intern',
            org: 'FinTech Solutions',
            start: '2021-05',
            end: '2021-07',
            desc: 'Assisted in product roadmap development and conducted competitor analysis.'
          }
        ];

        const internContainer = document.getElementById('internshipsContainer');
        if (internContainer) {
          internContainer.innerHTML = '';
          internships.forEach((intern, index) => {
            if (index > 0) addInternship();
            setTimeout(() => {
              const allRoles = document.querySelectorAll('input[name="internRole[]"]');
              const allOrgs = document.querySelectorAll('input[name="internOrg[]"]');
              const allStarts = document.querySelectorAll('input[name="internStart[]"]');
              const allEnds = document.querySelectorAll('input[name="internEnd[]"]');
              const allDescs = document.querySelectorAll('textarea[name="internDesc[]"]');

              if (allRoles[index]) allRoles[index].value = intern.role;
              if (allOrgs[index]) allOrgs[index].value = intern.org;
              if (allStarts[index]) allStarts[index].value = intern.start;
              if (allEnds[index]) allEnds[index].value = intern.end;
              if (allDescs[index]) allDescs[index].value = intern.desc;
            }, 100 * index);
          });
        }


        // Add references (un-skip the section first if it's skipped)
        const refSection = document.getElementById('section-references');
        if (refSection && refSection.classList.contains('skipped')) {
          toggleSection('references');
        }

        setTimeout(() => {
          const refContainer = document.getElementById('referencesContainer');
          refContainer.innerHTML = '';

          const references = [
            {
              name: 'Dr. Michael Rodriguez',
              title: 'Engineering Director',
              company: 'TechCorp Solutions',
              phone: '+1 (555) 234-5678',
              email: 'michael.rodriguez@techcorp.com'
            },
            {
              name: 'Sarah Johnson',
              title: 'Senior Product Manager',
              company: 'Digital Innovations Inc.',
              phone: '+1 (555) 345-6789',
              email: 'sarah.johnson@digitalinnovations.com'
            }
          ];

          references.forEach((ref, index) => {
            if (index > 0) addReference();

            setTimeout(() => {
              const allNames = document.querySelectorAll('input[name="refName[]"]');
              const allTitles = document.querySelectorAll('input[name="refTitle[]"]');
              const allCompanies = document.querySelectorAll('input[name="refCompany[]"]');
              const allPhones = document.querySelectorAll('input[name="refPhone[]"]');
              const allEmails = document.querySelectorAll('input[name="refEmail[]"]');

              if (allNames[index]) allNames[index].value = ref.name;
              if (allTitles[index]) allTitles[index].value = ref.title;
              if (allCompanies[index]) allCompanies[index].value = ref.company;
              if (allPhones[index]) allPhones[index].value = ref.phone;
              if (allEmails[index]) allEmails[index].value = ref.email;
            }, 100 * index);
          });
        }, 500);

        // Add custom details (un-skip the section first if it's skipped)
        const customSection = document.getElementById('section-custom');
        if (customSection && customSection.classList.contains('skipped')) {
          toggleSection('custom');
        }

        setTimeout(() => {
          const customContainer = document.getElementById('customDetailsContainer');
          customContainer.innerHTML = '';

          const customDetails = [
            {
              heading: 'Publications & Speaking',
              content: '"Building Scalable Microservices" - TechBlog Monthly, March 2023\n"The Future of Cloud Architecture" - CloudCon Conference, June 2023\nGuest lecturer at UC Berkeley on Modern Web Development (2022-Present)'
            },
            {
              heading: 'Volunteer Work',
              content: 'Code for Good - Teaching coding to underprivileged youth (2020-Present)\nTech Mentorship Program - Mentoring women in tech transitioning to software engineering\nOpen Source Community - Regular contributor and maintainer of popular JavaScript libraries'
            }
          ];

          customDetails.forEach((detail, index) => {
            if (index > 0) addCustomDetail();

            setTimeout(() => {
              const allHeadings = document.querySelectorAll('input[name="customHeading[]"]');
              const allContents = document.querySelectorAll('textarea[name="customContent[]"]');

              if (allHeadings[index]) allHeadings[index].value = detail.heading;
              if (allContents[index]) allContents[index].value = detail.content;
            }, 100 * index);
          });
        }, 700);

        // Show success message
        setTimeout(() => {
          console.log('âœ… Sample data filled successfully');
          alert('âœ… Sample data has been loaded successfully!\n\nYou can now preview or generate your resume with any template to see how it looks with comprehensive data.');

          // Scroll to top of form
          const mainLayout = document.querySelector('.main-layout');
          if (mainLayout) {
            mainLayout.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 2000);

      } catch (error) {
        console.error('âŒ Error filling sample data:', error);
        alert('âŒ Error filling sample data: ' + error.message + '\n\nPlease check the browser console for details.');
      }
    }

    // Generate Resume with backend integration and animated loading page
    // Generate Resume with in-page animated loading overlay (no popup!)
    async function generateResume() {
      // Validate required fields
      let valid = true;
      let errors = [];

      const fullName = document.getElementById('fullName');
      if (!fullName.value.trim()) {
        fullName.style.borderColor = '#e53e3e';
        errors.push('Full name is required');
        valid = false;
      } else {
        fullName.style.borderColor = 'rgba(226,232,240,.25)';
      }

      const email = document.getElementById('email');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email.value.trim()) {
        email.style.borderColor = '#e53e3e';
        errors.push('Email is required');
        valid = false;
      } else if (!emailRegex.test(email.value.trim())) {
        email.style.borderColor = '#e53e3e';
        errors.push('Please enter a valid email address');
        valid = false;
      } else {
        email.style.borderColor = 'rgba(226,232,240,.25)';
      }

      const phone = document.getElementById('phone');
      const phoneRegex = /^[\+]?[\d\s\-\(\)\.]+$/;
      if (!phone.value.trim()) {
        phone.style.borderColor = '#e53e3e';
        errors.push('Phone number is required');
        valid = false;
      } else if (!phoneRegex.test(phone.value.trim())) {
        phone.style.borderColor = '#e53e3e';
        errors.push('Please enter a valid phone number');
        valid = false;
      } else {
        phone.style.borderColor = 'rgba(226,232,240,.25)';
      }

      if (!valid) {
        alert('Please fix the following errors:\nâ€¢ ' + errors.join('\nâ€¢ '));
        return;
      }

      if (!selectedTemplate) {
        selectedTemplate = localStorage.getItem('selectedTemplate');
      }

      if (!selectedTemplate) {
        alert('Please select a template first. Redirecting...');
        document.querySelector('.main-layout').style.display = 'none';
        document.querySelector('.bottom-actions').style.display = 'none';
        document.getElementById('formStepIndicator').style.display = 'none';
        document.getElementById('templateSelection').style.display = 'block';
        return;
      }

      const data = collectFormData();
      data.template = selectedTemplate;
      localStorage.setItem('resumeData', JSON.stringify(data));

      console.log('ðŸš€ Starting resume generation with in-page animation:', data);
      console.log('Backend URL:', BACKEND_URL);

      // Show beautiful loading overlay in same window (no popup!)
      const overlay = document.createElement('div');
      overlay.id = 'generationOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:100000;background:linear-gradient(135deg,#000501 0%,#2cc42c 100%);display:flex;align-items:center;justify-content:center;color:white;font-family:Inter,system-ui,sans-serif;';

      const userName = data.personalInfo?.fullName || 'resume';
      const templateName = data.template;

      overlay.innerHTML = `
        <div style="text-align:center;padding:40px;max-width:600px;">
          <div class="logo-container" style="width:250px;height:250px;margin:0 auto 40px;position:relative;">
            <div class="logo" style="width:100%;height:100%;background:rgba(0,0,0,0.7);border-radius:20px;padding:30px;backdrop-filter:blur(10px);box-shadow:0 20px 60px rgba(0,0,0,0.5);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;">
              <img src="logohiero.png" alt="Hiero Logo" class="logo-img" style="width:100%;height:100%;object-fit:contain;filter:drop-shadow(0px 4px 20px rgba(42,224,35,0.5));position:relative;z-index:2;">
            </div>
          </div>
          <h1 style="font-size:36px;margin-bottom:20px;font-weight:700;">Generating Your Resume</h1>
          <div id="overlayStatus" style="font-size:20px;color:#2ae023;margin-bottom:12px;font-weight:500;">Preparing ${templateName} template...</div>
          <div id="overlaySubstatus" style="font-size:16px;opacity:0.8;margin-bottom:35px;">This will only take a moment</div>
          <div style="width:100%;height:10px;background:rgba(255,255,255,0.15);border-radius:12px;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);">
            <div id="overlayProgressBar" style="height:100%;background:linear-gradient(90deg,#2ae023,#1a8b17);width:0%;transition:width 0.4s ease;box-shadow:0 0 20px rgba(42,224,35,0.6);"></div>
          </div>
          <div style="margin-top:20px;font-size:14px;opacity:0.6;">
            <i class="fas fa-spinner fa-spin"></i> Processing...
          </div>
        </div>
        <style>
          .logo::before {
            content: "";
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 0%;
          background: linear-gradient(180deg, transparent 0%, rgba(42, 224, 35, 0.2) 100%);
          animation: fillLogo 3s ease-in-out infinite;
          z-index: 1;
          border-radius: 20px;
          }
          @keyframes fillLogo {
            0 % { height: 0 %; }
            50%  {height: 100%; }
          100% {height: 0%; }
          }
        </style>
      `;

      document.body.appendChild(overlay);

      try {
        // Update progress stages
        const statusEl = document.getElementById('overlayStatus');
        const substatusEl = document.getElementById('overlaySubstatus');
        const progressBar = document.getElementById('overlayProgressBar');

        statusEl.textContent = 'Contacting server...';
        substatusEl.textContent = `Sending ${templateName} template request`;
        progressBar.style.width = '20%';

        await new Promise(resolve => setTimeout(resolve, 300)); // Brief delay for UX

        // Add timeout for ngrok (increased to 120 seconds)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
          console.error('â±ï¸ Request timeout after 120 seconds');
          statusEl.textContent = 'âŒ Request Timeout';
          statusEl.style.color = '#ff6b6b';
          substatusEl.textContent = 'The server took too long to respond. Please try again or check your connection.';
          progressBar.style.background = 'linear-gradient(90deg, #ff6b6b, #c92a2a)';
        }, 120000); // 120 seconds for ngrok

        const downloadUrl = BACKEND_URL + '/download-resume';
        console.log('ðŸ“¡ Generating resume at:', downloadUrl);
        console.log('ðŸ“¦ Request data:', {
          template: data.template,
          name: data.personalInfo?.fullName,
          dataSize: JSON.stringify(data).length
        });

        // Test backend connectivity first
        try {
          const healthCheck = await fetch(BACKEND_URL + '/health', {
            method: 'GET',
            mode: 'cors',
            cache: 'no-store'
          });
          if (healthCheck.ok) {
            console.log('âœ… Backend health check passed before download');
          } else {
            console.warn('âš ï¸ Backend health check returned:', healthCheck.status);
          }
        } catch (healthError) {
          console.error('âŒ Backend health check failed:', healthError.message);
          console.error('   This might indicate the backend is not accessible');
          throw new Error(`Backend server not accessible at ${BACKEND_URL}. Please check if the server is running.`);
        }

        const token = localStorage.getItem('token') || localStorage.getItem('jwtToken');
        const response = await fetch(downloadUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/pdf',
            'Authorization': token ? `Bearer ${token}` : ''
          },
          body: JSON.stringify(data),
          signal: controller.signal,
          mode: 'cors',
          credentials: 'omit'
        });

        clearTimeout(timeoutId);

        progressBar.style.width = '50%';
        statusEl.textContent = 'Server processing...';
        substatusEl.textContent = 'Creating your PDF document';

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Server error:', errorText);
          throw new Error('Server error: ' + response.statusText);
        }

        // Check if response is actually PDF
        const contentType = response.headers.get('content-type');
        console.log('ðŸ“„ Response Content-Type:', contentType);

        if (!contentType || !contentType.includes('application/pdf')) {
          const text = await response.text();
          console.error('âŒ Response is not PDF! Content:', text.substring(0, 200));
          throw new Error('Server returned non-PDF response. Check console for details.');
        }

        const blob = await response.blob();
        console.log('âœ… PDF blob received, size:', blob.size, 'bytes');

        // Verify blob is actually PDF
        if (blob.size === 0) {
          throw new Error('Received empty PDF file');
        }

        // Check if blob type is correct
        if (!blob.type || !blob.type.includes('pdf')) {
          console.warn('âš ï¸ Blob type is not PDF:', blob.type);
          // Try to read first bytes to verify
          const firstBytes = await blob.slice(0, 4).text();
          console.log('First 4 bytes:', firstBytes);
          if (!firstBytes.includes('%PDF')) {
            throw new Error('File is not a valid PDF. Received: ' + blob.type);
          }
        }

        progressBar.style.width = '85%';
        statusEl.textContent = 'PDF ready!';
        substatusEl.textContent = 'Preparing download...';

        const fileName = `${userName.replace(/[^a-zA-Z0-9]/g, '_')}_${templateName}_resume.pdf`;
        // Download the file with proper error handling
        try {
          // Manual download disabled in generation - choice modal will handle it
          console.log('âœ… Generation successful - showing choice modal');
          // skip a.click()
        } catch (downloadError) {

          console.error('âŒ Download error:', downloadError);
          throw new Error('Failed to trigger download: ' + downloadError.message);
        }

        progressBar.style.width = '100%';
        statusEl.textContent = 'âœ… Analysis Complete!';
        statusEl.style.color = '#2ae023';
        substatusEl.textContent = 'Preparing your download options...';

        // Success animation then show results selection
        setTimeout(() => {
          overlay.style.opacity = '0';
          overlay.style.transition = 'opacity 0.5s ease';
          setTimeout(() => {
            overlay.remove();

            // Show results selection section
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) {
              resultsSection.style.display = 'block';
              resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            // Hide main form layout
            const mainLayout = document.querySelector('.main-layout');
            const bottomActions = document.querySelector('.bottom-actions');
            const stepIndicator = document.getElementById('formStepIndicator');

            if (mainLayout) mainLayout.style.display = 'none';
            if (bottomActions) bottomActions.style.display = 'none';
            if (stepIndicator) stepIndicator.style.display = 'none';
          }, 500);
        }, 1200);


      } catch (error) {
        console.error('âŒ Generation error:', error);
        console.error('âŒ Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack,
          backendUrl: BACKEND_URL,
          downloadUrl: BACKEND_URL + '/download-resume'
        });

        const statusEl = document.getElementById('overlayStatus');
        const substatusEl = document.getElementById('overlaySubstatus');
        const progressBar = document.getElementById('overlayProgressBar');

        statusEl.textContent = 'âŒ Generation Failed';
        statusEl.style.color = '#ff6b6b';
        progressBar.style.background = 'linear-gradient(90deg, #ff6b6b, #c92a2a)';

        if (error.name === 'AbortError') {
          substatusEl.textContent = 'âš ï¸ Request timed out - server took too long. This may be due to slow network or ngrok connection.';
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('ERR_CONNECTION_REFUSED')) {
          substatusEl.textContent = `âš ï¸ Cannot connect to backend at ${BACKEND_URL}. Check console for details.`;
          console.error('ðŸ” Connection troubleshooting:');
          console.error('   1. Is backend server running? Check: curl ' + BACKEND_URL + '/health');
          console.error('   2. Is CORS configured correctly?');
          console.error('   3. Is firewall blocking port 5003?');
          console.error('   4. If on another device, is BACKEND_URL correct?');
        } else if (error.message.includes('not accessible')) {
          substatusEl.textContent = error.message;
        } else {
          substatusEl.textContent = error.message || 'Unknown error occurred';
        }

        setTimeout(() => {
          overlay.remove();
          const errorMsg = error.name === 'AbortError'
            ? 'Request timed out. The server took too long to respond. This may be due to:\nâ€¢ Slow network connection\nâ€¢ ngrok tunnel issues\nâ€¢ Server overload\n\nPlease try again or check your connection.'
            : `Failed to generate resume: \n\n${error.message} \n\nPlease ensure the integrated gateway is running.`;
          alert('âŒ ' + errorMsg);
        }, 3000);
      }
    }

    function collectFormData() {
      const data = { personalInfo: {}, experience: [], education: [], references: [], customDetails: [] };

      // Personal
      data.personalInfo.fullName = document.getElementById('fullName').value;
      data.personalInfo.headline = document.getElementById('headline')?.value || '';
      data.personalInfo.email = document.getElementById('email').value;
      data.personalInfo.phone = document.getElementById('phone').value;

      // Profile photo (if uploaded and not skipped)
      const photoSection = document.querySelector('.photo-upload-section');
      if (photoSection && !photoSection.classList.contains('skipped') && uploadedPhotoData) {
        data.personalInfo.profilePhoto = uploadedPhotoData;
      }

      // Optional fields (only if not skipped and not empty)
      const optional = ['address', 'linkedin', 'website', 'summary', 'technicalSkills', 'softSkills', 'certifications', 'languages', 'achievements', 'hobbies', 'extraCurricular', 'additionalInfo'];
      optional.forEach(field => {
        // Find which group/section it belongs to
        let parentId = 'section-additional';
        if (field === 'summary') parentId = 'section-summary';
        if (field === 'technicalSkills' || field === 'softSkills') parentId = 'section-skills';
        if (field === 'certifications' || field === 'languages') parentId = 'section-additional-details';
        if (['address', 'linkedin', 'website'].includes(field)) parentId = 'group-' + field;
        if (field === 'achievements' || field === 'hobbies' || field === 'extraCurricular') parentId = 'group-' + field;

        const group = document.getElementById(parentId);
        const input = document.getElementById(field);
        if (group && !group.classList.contains('skipped') && input && input.value.trim()) {
          // Map 'technicalSkills' to 'skills' for backend compatibility
          if (field === 'technicalSkills') {
            data.skills = input.value.trim();
          } else {
            data[field] = input.value.trim();
          }
        }
      });

      // Projects (structured data)
      const projectsSection = document.getElementById('section-projects');
      if (projectsSection && !projectsSection.classList.contains('skipped')) {
        data.projects = [];
        document.querySelectorAll('input[name="projectName[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            const project = {
              name: el.value.trim(),
              technologies: document.querySelectorAll('input[name="projectTech[]"]')[i]?.value || '',
              duration: document.querySelectorAll('input[name="projectDuration[]"]')[i]?.value || '',
              description: document.querySelectorAll('textarea[name="projectDescription[]"]')[i]?.value || '',
              link: document.querySelectorAll('input[name="projectLink[]"]')[i]?.value || '',
              achievement: document.querySelectorAll('input[name="projectAchievement[]"]')[i]?.value || ''
            };
            data.projects.push(project);
          }
        });
        // If no structured projects, fall back to old textarea format
        if (data.projects.length === 0) {
          const oldProjectsInput = document.getElementById('projects');
          if (oldProjectsInput && oldProjectsInput.value.trim()) {
            data.projects = oldProjectsInput.value.trim();
          }
        }
      } else {
        // Fallback to old textarea if section is skipped
        const oldProjectsInput = document.getElementById('projects');
        if (oldProjectsInput && oldProjectsInput.value.trim()) {
          data.projects = oldProjectsInput.value.trim();
        }
      }

      const expSection = document.getElementById('section-experience');
      if (expSection && !expSection.classList.contains('skipped')) {
        const expItems = document.querySelectorAll('.experience-item');
        expItems.forEach((item, i) => {
          const jobTitle = item.querySelector('input[name="jobTitle[]"]')?.value || '';
          if (jobTitle.trim()) {
            const current = item.querySelector('input[type="checkbox"]')?.checked || false;
            data.experience.push({
              jobTitle: jobTitle,
              company: item.querySelector('input[name="company[]"]')?.value || '',
              startDate: item.querySelector('input[name="startDate[]"]')?.value || '',
              endDate: current ? 'Present' : (item.querySelector('input[name="endDate[]"]')?.value || ''),
              description: item.querySelector('textarea[name="jobDescription[]"]')?.value || ''
            });
          }
        });
      }

      // Education (only if not skipped)
      const eduSection = document.getElementById('section-education');
      if (eduSection && !eduSection.classList.contains('skipped')) {
        document.querySelectorAll('input[name="degree[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            data.education.push({
              degree: el.value,
              school: document.querySelectorAll('input[name="school[]"]')[i].value,
              gradYear: document.querySelectorAll('input[name="gradYear[]"]')[i].value,
              gpa: document.querySelectorAll('input[name="gpa[]"]')[i].value
            });
          }
        });
      }

      // 4. Internships (Structured Capture)
      data.internships = [];
      const internSection = document.getElementById('section-internships');
      if (internSection && !internSection.classList.contains('skipped')) {
        document.querySelectorAll('input[name="internRole[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            data.internships.push({
              jobTitle: el.value,
              company: document.querySelectorAll('input[name="internOrg[]"]')[i].value,
              startDate: document.querySelectorAll('input[name="internStart[]"]')[i].value,
              endDate: document.querySelectorAll('input[name="internEnd[]"]')[i].value,
              description: document.querySelectorAll('textarea[name="internDesc[]"]')[i].value
            });
          }
        });
      }


      // References (only if section is not skipped)
      const refSection = document.getElementById('section-references');
      if (refSection && !refSection.classList.contains('skipped')) {
        document.querySelectorAll('input[name="refName[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            data.references.push({
              name: el.value,
              title: document.querySelectorAll('input[name="refTitle[]"]')[i].value,
              company: document.querySelectorAll('input[name="refCompany[]"]')[i].value,
              phone: document.querySelectorAll('input[name="refPhone[]"]')[i].value,
              email: document.querySelectorAll('input[name="refEmail[]"]')[i].value
            });
          }
        });
      }

      // Custom Details (only if section is not skipped)
      const customSection = document.getElementById('section-custom');
      if (customSection && !customSection.classList.contains('skipped')) {
        data.customSectionTitle = document.getElementById('customSectionTitle')?.value || '';
        data.customSectionContent = document.getElementById('customSectionContent')?.value || '';

        document.querySelectorAll('input[name="customHeading[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            data.customDetails.push({
              heading: el.value,
              content: document.querySelectorAll('textarea[name="customContent[]"]')[i].value
            });
          }
        });
      }

      // Additional Info from LLM Summary
      const addInfo = document.getElementById('additionalInfo');
      if (addInfo && addInfo.value.trim()) {
        data.additionalInfo = addInfo.value.trim();
      }

      return data;
    }

    function clearForm(skipConfirm = false) {
      if (skipConfirm || confirm('This will clear all form data and return to template selection. Continue?')) {
        // Clear all inputs
        const inputs = document.querySelectorAll('input, textarea');
        inputs.forEach(input => {
          if (input.type === 'file') return;
          input.value = '';
          // Remove skipped class from parents
          const group = input.closest('.form-group');
          if (group) group.classList.remove('skipped');
          const section = input.closest('.form-section');
          if (section) section.classList.remove('skipped');
        });

        // Reset dynamic containers
        const dynamicContainers = ['experienceContainer', 'educationContainer', 'projectsContainer', 'referencesContainer', 'customDetailsContainer'];
        dynamicContainers.forEach(id => {
          const container = document.getElementById(id);
          if (container) container.innerHTML = '';
        });

        // Reset state - Only clear resume data, NOT auth token
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key !== 'token' && key !== 'jwtToken' && key !== 'user') {
            keysToRemove.push(key);
          }
        }
        keysToRemove.forEach(k => localStorage.removeItem(k));
        selectedTemplate = null;

        // UI Reset
        initializePage();
        console.log('ðŸ§¹ Form cleared successfully');
      }
    }

    function editResume() {
      document.getElementById('resultsSection').style.display = 'none';
      document.querySelector('.main-layout').style.display = 'grid';
      document.querySelector('.bottom-actions').style.display = 'flex';
    }

    // Download and Preview with backend integration
    async function downloadDocx() {
      const data = collectFormData();
      // Ensure template is set
      data.template = selectedTemplate || 'classic';

      try {
        const btn = document.getElementById('downloadDocxBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        btn.disabled = true;

        const token = localStorage.getItem('token') || localStorage.getItem('jwtToken');
        const response = await fetch(`${BACKEND_URL}/download-docx`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error('Failed to generate DOCX');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${data.personalInfo.fullName || 'resume'}_${data.template}.doc`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        btn.innerHTML = originalText;
        btn.disabled = false;
      } catch (error) {
        console.error('DOCX download error:', error);
        alert('Failed to download Word document. Please try again.');
        const btn = document.getElementById('downloadDocxBtn');
        if (btn) {
          btn.innerHTML = '<i class="fas fa-file-word"></i> Download Word';
          btn.disabled = false;
        }
      }
    }

    async function downloadResume() {
      const btn = event.target;
      const originalText = btn.innerHTML;

      // Show more informative loading message
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF... (this may take 5-10 seconds)';
      btn.disabled = true;

      try {
        const data = JSON.parse(localStorage.getItem('resumeData') || '{}');

        // Ensure template is included
        if (!data.template) {
          data.template = selectedTemplate || localStorage.getItem('selectedTemplate') || 'classic';
        }

        const token = localStorage.getItem('token') || localStorage.getItem('jwtToken');
        console.log('ðŸ“¡ POST', `${BACKEND_URL}/download-resume`);
        const response = await fetch(`${BACKEND_URL}/download-resume`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/pdf',
            'Authorization': token ? `Bearer ${token}` : ''
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ Server error:', errorText);
          throw new Error(`Download failed: ${response.status} ${response.statusText}`);
        }

        // Check content type
        const contentType = response.headers.get('content-type');
        console.log('ðŸ“„ Response Content-Type:', contentType);

        if (!contentType || !contentType.includes('application/pdf')) {
          const text = await response.text();
          console.error('âŒ Response is not PDF!', text.substring(0, 200));
          throw new Error('Server returned non-PDF response');
        }

        const blob = await response.blob();
        console.log('âœ… PDF blob received, size:', blob.size, 'bytes, type:', blob.type);

        if (blob.size === 0) {
          throw new Error('Received empty PDF file');
        }

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${data.personalInfo?.fullName || 'resume'}_${data.template}_resume.pdf`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();

        setTimeout(() => {
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        }, 100);

      } catch (error) {
        console.error('Download error full:', error);
        alert(`Failed to download resume: ${error.message}. Please try again.`);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    async function previewResume() {
      // 1. Open blank window immediately to satisfy mobile popup blockers
      // This must happen synchronously in the click event
      const previewWindow = window.open('', '_blank');

      if (!previewWindow) {
        alert('Popup blocked! Please allow popups to see your resume preview.');
        return;
      }

      previewWindow.document.write(`
        <html>
          <head>
            <title>Hiero - Generating Preview</title>
            <style>
              body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #000; color: #fff; margin:0; }
              .spinner { border: 4px solid rgba(42, 224, 35, 0.1); border-left-color: #2ae023; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
              @keyframes spin { to { transform: rotate(360deg); } }
            </style>
          </head>
          <body>
            <div class="spinner"></div>
            <h3>Generating your premium preview...</h3>
            <p style="color: #888; font-size: 14px;">This will take just a moment.</p>
          </body>
        </html>
      `);

      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Preview...';
      btn.disabled = true;

      try {
        const data = collectFormData();
        data.template = selectedTemplate || localStorage.getItem('selectedTemplate') || 'classic';

        console.log('Previewing resume with template:', data.template);

        const response = await fetch(`${BACKEND_URL}/preview-resume`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Preview failed' }));
          previewWindow.close();
          throw new Error(errorData.error || 'Preview failed');
        }

        const blob = await response.blob();

        // Final fallback for empty response
        if (blob.size < 100) {
          previewWindow.close();
          throw new Error('Server returned an invalid PDF.');
        }

        const url = window.URL.createObjectURL(blob);

        // 2. Redirect the already opened window to the blob URL
        previewWindow.location.href = url;

        // Clean up memory after a delay
        setTimeout(() => window.URL.revokeObjectURL(url), 10000);

      } catch (error) {
        if (previewWindow) previewWindow.close();
        console.error('Preview error:', error);
        alert(`Failed to preview resume: ${error.message}. Please try again.`);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
  </script>
</body>

</html>