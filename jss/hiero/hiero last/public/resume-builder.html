<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hiero Resume Builder</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #000501 0%, #2cc42c 100%);
      min-height: 100vh;
      color: #0b0a0a;
      line-height: 1.6;
    }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    
    /* Template Selection Styles */
    .template-selection {
      background: rgb(3,2,2);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      border: 1px solid rgba(45,196,44,0.15);
    }
    
    .template-categories {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    
    .category-btn {
      padding: 12px 24px;
      border: 2px solid rgba(45,196,44,0.3);
      background: transparent;
      color: #2ae023;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .category-btn.active {
      background: #2ae023;
      color: #000;
      border-color: #2ae023;
    }
    
    .category-btn:hover {
      background: rgba(42,224,35,0.1);
      border-color: #2ae023;
    }
    
    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .template-card {
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(45,196,44,0.2);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .template-card:hover {
      border-color: #2ae023;
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(42,224,35,0.2);
    }
    
    .template-card.premium {
      border-color: #ffd700;
    }
    
    .template-card.premium:hover {
      border-color: #ffd700;
      box-shadow: 0 15px 40px rgba(255,215,0,0.2);
    }
    
    .premium-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .template-preview {
      width: 100%;
      height: 200px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2ae023;
      font-size: 3rem;
      border: 1px solid rgba(45,196,44,0.2);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .template-preview:hover {
      background: rgba(255,255,255,0.15);
      border-color: #2ae023;
    }
    
    .preview-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .template-preview:hover .preview-overlay {
      opacity: 1;
    }
    
    .preview-btn {
      background: rgba(42,224,35,0.2);
      color: #2ae023;
      border: 2px solid #2ae023;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .preview-btn:hover {
      background: #2ae023;
      color: #000;
    }
    
    .template-info h3 {
      color: #2ae023;
      font-size: 1.2rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .template-info p {
      color: #ccc;
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 15px;
    }
    
    .template-tags {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tag {
      background: rgba(42,224,35,0.2);
      color: #2ae023;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .start-building-btn {
      width: 100%;
      background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .start-building-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(42,224,35,0.3);
    }
    
    /* Hide form initially */
    .main-layout { display:none; grid-template-columns:1fr 1fr; gap:30px; align-items:start; }
    .left-pane, .right-pane {
      background: rgb(3,2,2);
      border-radius:24px;
      padding:35px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.05);
      border:1px solid rgba(45,196,44,0.15);
    }
    .bottom-actions { display:none; gap:20px; justify-content:center; margin-top:40px; }
    .btn { padding:18px 36px; border:none; border-radius:16px; font-size:17px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:12px; transition:all .35s ease; }
    .btn-primary { background:linear-gradient(135deg,#05b41c 0%,#06c719 100%); color:white; box-shadow:0 8px 25px rgba(5,180,28,.4); }
    .btn-primary:hover { transform:translateY(-4px); box-shadow:0 15px 35px rgba(7,210,7,.6); }
    .btn-secondary { background:rgba(255,255,255,.12); color:#ddd; border:2px solid rgba(226,232,240,.3); }
    .btn-secondary:hover { background:rgba(1,6,11,.8); border-color:#0fdc2a; color:#0fdc2a; transform:translateY(-4px); }

    /* Modal styles for template preview */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 30px;
      border-bottom: 1px solid #eee;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      line-height: 1;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: #f5f5f5;
      color: #333;
    }

    .modal-preview {
      padding: 40px;
      display: flex;
      justify-content: center;
      background: #f8f9fa;
      min-height: 400px;
      align-items: center;
    }

    .modal-footer {
      padding: 20px 30px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }

    .modal-use-btn {
      background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .modal-use-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(42,224,35,0.3);
    }

    .header { 
      text-align:center; 
      margin-bottom:45px; 
      background:rgb(3,2,2); 
      padding:70px 35px 35px 35px; /* Extra top padding for buttons */
      border-radius:28px; 
      box-shadow:0 25px 50px rgba(0,0,0,.2); 
      position: relative;
    }
    .header h1 { font-size:3rem; color:#06a529; font-weight:800; letter-spacing:-0.5px; }
    .header p { font-size:1.2rem; color:#ccc; font-weight:500; max-width:600px; margin:0 auto; }
    
    /* Header Navigation Buttons - FIXED FOR MOBILE */
    .header-nav {
      position: absolute;
      top: 15px;
      right: 15px;
      left: 15px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      z-index: 10;
    }
    .header-nav button {
      background: rgba(45,196,44,0.2);
      color: #2ae023;
      border: 2px solid #2ae023;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .header-nav button:hover {
      background: #2ae023;
      color: #000;
    }
    .header-nav button.logout-btn {
      border-color: #ff6b6b;
      color: #ff6b6b;
      background: rgba(255,107,107,0.1);
    }
    .header-nav button.logout-btn:hover {
      background: #ff6b6b;
      color: white;
    }

    .step-indicator { 
      text-align:center; 
      margin-bottom:40px; 
      position: relative;
      padding: 20px 150px; /* Space for back button */
    }
    .step-text { background:linear-gradient(135deg,#66ea75 0%,#07cf0d 100%); color:rgb(37,40,37); padding:14px 30px; border-radius:50px; font-weight:700; font-size:1.15rem; box-shadow:0 6px 20px rgba(7,207,13,.3); }

    .form-section { margin-bottom:50px; position:relative; transition: all .4s ease; }
    .form-section.skipped { opacity:0.4; /* removed pointer-events:none to keep Show link clickable */ max-height:60px; overflow:hidden; }
    .form-section.skipped .form-content { display:none; }

    .section-title {
      font-size:2rem; color:#04ab07ee; margin-bottom:30px; padding-bottom:16px;
      border-bottom:4px solid #0d8705; display:flex; align-items:center; gap:16px;
      font-weight:700; position:relative; flex-wrap:wrap;
    }
    .section-title::before { content:''; position:absolute; bottom:-4px; left:0; width:80px; height:4px; background:#2ae023; border-radius:2px; }
    .section-icon { color:#2ae023; font-size:1.8rem; width:50px; height:50px; display:flex; align-items:center; justify-content:center; background:rgba(42,224,35,.15); border-radius:12px; border:1px solid rgba(42,224,35,.3); }

    .skip-link {
      font-size: 0.85rem; color: #75ea66; cursor: pointer; font-weight: 600;
      text-decoration: underline; text-underline-offset: 3px; opacity: 0.8; margin-left:8px;
    }
    .skip-link:hover { color: #2ae023; opacity: 1; }

    .field-skip {
      font-size: 0.75rem; color: #75ea66; cursor: pointer; margin-left: 8px; font-weight: 500;
      text-decoration: underline; opacity: 0.7;
    }
    .field-skip:hover { opacity: 1; color: #2ae023; }

    .form-group { margin-bottom:26px; position:relative; }
    .form-group.skipped { opacity:0.4; /* removed pointer-events:none to allow clicking Show */ }
    .form-group.skipped input, .form-group.skipped textarea { display:none; }

    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    label { display:block; margin-bottom:10px; font-weight:600; color:#0fdc2a; font-size:15px; display:flex; align-items:center; gap:5px; }
    .required { color:#e53e3e; }

    input:not([type="checkbox"]), textarea {
      width:100%; padding:17px 18px; border:2px solid rgba(226,232,240,.25); border-radius:16px;
      font-size:16px; background:rgba(255,255,255,.08); color:#fff; backdrop-filter:blur(5px);
      transition:all .3s ease;
    }
    input:not([type="checkbox"]):focus, textarea:focus { outline:none; border-color:#12ca12; box-shadow:0 0 0 4px rgba(18,202,18,.2), 0 8px 25px rgba(18,202,18,.15); transform:translateY(-1px); background:rgba(255,255,255,.12); }
    textarea { resize:vertical; min-height:120px; }
    
    /* Checkbox styling */
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #2ae023;
      flex-shrink: 0;
    }
    
    /* Currently working here checkbox container */
    .checkbox-container {
      margin-top: 5px;
      margin-bottom: 15px;
    }
    
    .checkbox-container label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #0fdc2a;
      cursor: pointer;
      margin-bottom: 0;
    }

    .experience-item, .education-item {
      background:rgba(248,249,250,.1); padding:28px; border-radius:18px; margin-bottom:20px;
      border-left:6px solid #75ea66; border:1px solid rgba(117,234,102,.25); transition:all .35s ease;
    }
    .experience-item:hover, .education-item:hover { transform:translateY(-3px); box-shadow:0 15px 35px rgba(117,234,102,.2); }

    .reference-item, .custom-detail-item {
      background:rgba(248,249,250,.1); padding:28px; border-radius:18px; margin-bottom:20px;
      border-left:6px solid #2ae023; border:1px solid rgba(42,224,35,.25); transition:all .35s ease;
    }
    .reference-item:hover, .custom-detail-item:hover { transform:translateY(-3px); box-shadow:0 15px 35px rgba(42,224,35,.2); }

    .project-item {
      background:rgba(248,249,250,.1); padding:28px; border-radius:18px; margin-bottom:20px;
      border-left:6px solid #2ae023; border:1px solid rgba(42,224,35,.25); transition:all .35s ease;
      position: relative;
    }
    .project-item:hover { transform:translateY(-3px); box-shadow:0 15px 35px rgba(42,224,35,.2); }

    .add-more-btn {
      background:rgba(226,232,240,.15); color:#bbb; border:2px dashed rgba(203,213,224,.5);
      padding:18px; border-radius:16px; cursor:pointer; transition:all .35s ease; margin:20px 0;
      font-weight:600; font-size:15px; backdrop-filter:blur(5px);
    }
    .add-more-btn:hover { background:rgba(117,234,102,.15); border-color:#75ea66; color:#75ea66; transform:translateY(-2px); }

    .remove-btn {
      background:rgba(254,215,215,.25); color:#e53e3e; border:none; padding:10px 16px;
      border-radius:12px; cursor:pointer; font-size:13px; float:right; font-weight:600;
      transition:all .3s ease; backdrop-filter:blur(5px);
    }
    .remove-btn:hover { background:#fca5a5; transform:scale(1.05); }

    @media (max-width:768px) {
      .main-layout { grid-template-columns:1fr; }
      .form-row { grid-template-columns:1fr; }
      .btn { width:100%; justify-content:center; }
      .header { padding: 60px 20px 30px; }
      .header h1 { font-size:2.3rem; }
      .section-title { font-size:1.8rem; }
      .header-nav {
        top: 10px;
        right: 10px;
        left: 10px;
        justify-content: space-between;
        gap: 8px;
      }
      .header-nav button {
        font-size: 11px;
        padding: 8px 12px;
        flex: 1;
        min-width: 0;
      }
      #backToTemplatesBtn {
        position: static !important;
        transform: none !important;
        margin-bottom: 15px;
        width: 100%;
      }
      .step-indicator {
        padding: 20px 10px !important;
      }
      
      /* Mobile-optimized form inputs */
      input, textarea {
        padding: 14px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
        -webkit-appearance: none;
        appearance: none;
        border-radius: 12px;
      }
      
      textarea {
        min-height: 100px;
      }
      
      /* Better mobile spacing for form sections */
      .form-section {
        margin-bottom: 35px;
      }
      
      .section-title {
        font-size: 1.6rem;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .section-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
      }
      
      /* Mobile template grid */
      .templates-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .template-card {
        padding: 18px;
      }
      
      .template-categories {
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .category-btn {
        padding: 10px 18px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-nav">
        <button onclick="window.location.href='/dashboard'">
          <i class="fas fa-home"></i> Dashboard
        </button>
        <button onclick="logout()" style="border-color: #ff6b6b; color: #ff6b6b;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
      <h1>Hiero Resume Builder</h1>
      <p>Create your professional resume in simple steps</p>
    </div>

    <!-- Template Selection Section -->
    <div class="template-selection" id="templateSelection">
      <div class="step-indicator" style="margin-bottom: 40px;">
        <div class="step-text">Step 1: Choose Your Template</div>
      </div>
      
      <!-- Removed template categories since we only have one template -->
      
      <div class="templates-grid" id="templatesGrid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); max-width: 1200px; margin: 0 auto;">
        <!-- Hiero Pro Template (formerly Rishi) -->
        <div class="template-card" data-category="modern" data-template="rishi" data-type="free">
          <div class="template-preview" onclick="previewTemplate('rishi')">
            <i class="fas fa-laptop-code"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Pro Template</h3>
            <p>Professional modern template with clean design and excellent readability. Perfect for all industries and career levels.</p>
            <div class="template-tags">
              <span class="tag">Modern</span>
              <span class="tag">Professional</span>
              <span class="tag">ATS-Friendly</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('rishi')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Priya Template -->
        <div class="template-card" data-category="elegant" data-template="priya" data-type="free">
          <div class="template-preview" onclick="previewTemplate('priya')">
            <i class="fas fa-file-alt"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Priya Analytical Resume</h3>
            <p>Analytical, structured resume optimized for data-driven, academic and research-oriented profiles with strong project sections.</p>
            <div class="template-tags">
              <span class="tag">Analytical</span>
              <span class="tag">Academic</span>
              <span class="tag">Data-Driven</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('priya')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Hiero Elite Template (third template) -->
        <div class="template-card" data-category="elite" data-template="hiero-elite" data-type="free">
          <div class="template-preview" onclick="previewTemplate('hiero-elite')">
            <i class="fas fa-star"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Elite Template</h3>
            <p>Exclusive template with advanced design and layout options. Ideal for executives and professionals seeking a premium look.</p>
            <div class="template-tags">
              <span class="tag">Elite</span>
              <span class="tag">Premium</span>
              <span class="tag">Executive</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('hiero-elite')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Form Section (Initially Hidden) -->
    <div class="step-indicator" id="formStepIndicator" style="display: none;">
      <div class="step-text">Step 2: Fill Your Information</div>
    </div>

    <div class="main-layout">
      <!-- LEFT PANE -->
      <div class="left-pane">
        <form id="resumeForm">
          <!-- Personal Info -->
          <div class="form-section" id="section-personal">
            <h2 class="section-title">
              <i class="fas fa-user section-icon"></i> Personal Information
            </h2>
            <div class="form-content">
              <div class="form-group">
                <label for="fullName">Full Name <span class="required">*</span></label>
                <input type="text" id="fullName" required placeholder="Enter your full name">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="email">Email <span class="required">*</span></label>
                  <input type="email" id="email" required placeholder="john.doe@example.com" 
                         title="Please enter a valid email address (e.g., john@example.com)">
                  <small style="color: #666; font-size: 12px;">Examples: john@gmail.com, jane.doe@company.org</small>
                </div>
                <div class="form-group">
                  <label for="phone">Phone <span class="required">*</span></label>
                  <input type="tel" id="phone" required placeholder="+1 555-123-4567"
                         pattern="[\+]?[\d\s\-\(\)\.]+"
                         title="Please enter a valid phone number (numbers, spaces, dashes, parentheses, and + allowed)">
                  <small style="color: #666; font-size: 12px;">Examples: +1 555-123-4567, (555) 123-4567, 555.123.4567</small>
                </div>
              </div>

              <!-- Optional: Address -->
              <div class="form-group" id="group-address">
                <label>
                  Address
                  <span class="field-skip" onclick="skipField('address')">Skip</span>
                </label>
                <textarea id="address" placeholder="Your complete address"></textarea>
              </div>

              <div class="form-row">
                <!-- Optional: LinkedIn -->
                <div class="form-group" id="group-linkedin">
                  <label>
                    LinkedIn
                    <span class="field-skip" onclick="skipField('linkedin')">Skip</span>
                  </label>
                  <input type="url" id="linkedin" placeholder="https://linkedin.com/in/yourprofile">
                </div>
                <!-- Optional: Website -->
                <div class="form-group" id="group-website">
                  <label>
                    Portfolio
                    <span class="field-skip" onclick="skipField('website')">Skip</span>
                  </label>
                  <input type="url" id="website" placeholder="https://yourwebsite.com">
                </div>
              </div>
            </div>
          </div>

          <!-- Professional Summary -->
          <div class="form-section" id="section-summary">
            <h2 class="section-title">
              <i class="fas fa-user-tie section-icon"></i> Professional Summary
              <span class="skip-link" onclick="toggleSection('summary')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" rows="4" placeholder="Brief professional overview..."></textarea>
              </div>
            </div>
          </div>

          <!-- Work Experience -->
          <div class="form-section" id="section-experience">
            <h2 class="section-title">
              <i class="fas fa-briefcase section-icon"></i> Work Experience
              <span class="skip-link" onclick="toggleSection('experience')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="experienceContainer">
                <div class="experience-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="jobTitle1">Job Title</label>
                      <input type="text" id="jobTitle1" name="jobTitle[]" placeholder="Software Engineer">
                    </div>
                    <div class="form-group">
                      <label for="company1">Company</label>
                      <input type="text" id="company1" name="company[]" placeholder="Company Name">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="startDate1">Start Date</label>
                      <input type="month" id="startDate1" name="startDate[]">
                    </div>
                    <div class="form-group">
                      <label for="endDate1">End Date</label>
                      <input type="month" id="endDate1" name="endDate[]">
                    </div>
                  </div>
                  <div class="checkbox-container">
                    <label>
                      <input type="checkbox" id="current1"> Currently working here
                    </label>
                  </div>
                  <div class="form-group">
                    <label for="jobDescription1">Description</label>
                    <textarea id="jobDescription1" name="jobDescription[]" rows="4" placeholder="Key responsibilities..."></textarea>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addExperience()">Add Another Experience</button>
            </div>
          </div>

          <!-- Education -->
          <div class="form-section" id="section-education">
            <h2 class="section-title">
              <i class="fas fa-graduation-cap section-icon"></i> Education
              <span class="skip-link" onclick="toggleSection('education')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="educationContainer">
                <div class="education-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="degree1">Degree</label>
                      <input type="text" id="degree1" name="degree[]" placeholder="Bachelor of Science">
                    </div>
                    <div class="form-group">
                      <label for="school1">School</label>
                      <input type="text" id="school1" name="school[]" placeholder="University Name">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="gradYear1">Year</label>
                      <input type="number" id="gradYear1" name="gradYear[]" min="1950" max="2030" placeholder="2024">
                    </div>
                    <div class="form-group">
                      <label for="gpa1">GPA</label>
                      <input type="text" id="gpa1" name="gpa[]" placeholder="3.8/4.0">
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addEducation()">Add Another Education</button>
            </div>
          </div>
        </form>
      </div>

      <!-- RIGHT PANE -->
      <div class="right-pane">
        <div id="resumeFormPart2">
          <!-- Skills -->
          <div class="form-section" id="section-skills">
            <h2 class="section-title">
              <i class="fas fa-tools section-icon"></i> Skills
              <span class="skip-link" onclick="toggleSection('skills')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div class="form-group">
                <label for="technicalSkills">Technical Skills</label>
                <textarea id="technicalSkills" rows="3" placeholder="JavaScript, Python, React..."></textarea>
              </div>
              <div class="form-group">
                <label for="softSkills">Soft Skills</label>
                <textarea id="softSkills" rows="3" placeholder="Leadership, Communication..."></textarea>
              </div>
            </div>
          </div>

          <!-- Additional Info -->
            <h2 class="section-title">
              <i class="fas fa-plus-circle section-icon"></i> Additional Information
              <span class="skip-link" onclick="toggleSection('additional')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div class="form-group" id="group-certifications">
                <label>
                  Certifications
                  <span class="field-skip" onclick="skipField('certifications')">Skip</span>
                </label>
                <textarea id="certifications" rows="3" placeholder="AWS, Google Cloud..."></textarea>
              </div>
              <div class="form-group" id="group-languages">
                <label>
                  Languages
                  <span class="field-skip" onclick="skipField('languages')">Skip</span>
                </label>
                <textarea id="languages" rows="2" placeholder="English (Native)..."></textarea>
              </div>
              <div class="form-section" id="section-projects">
                <h2 class="section-title">
                  <i class="fas fa-code section-icon"></i> Projects
                  <span class="skip-link" onclick="toggleSection('projects')">Skip this section</span>
                </h2>
                <div class="form-content">
                  <div id="projectsContainer">
                    <div class="project-item">
                      <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
                      <div class="form-group">
                        <label>Project Name <span class="required">*</span></label>
                        <input type="text" name="projectName[]" placeholder="E-commerce Platform" required>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Technologies Used</label>
                          <input type="text" name="projectTech[]" placeholder="React, Node.js, MongoDB">
                        </div>
                        <div class="form-group">
                          <label>Duration/Year</label>
                          <input type="text" name="projectDuration[]" placeholder="6 months or 2023">
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Project Description</label>
                        <textarea name="projectDescription[]" rows="4" placeholder="Describe what the project does, key features, and your role..."></textarea>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>GitHub/Deployment Link (Optional)</label>
                          <input type="url" name="projectLink[]" placeholder="https://github.com/username/project">
                        </div>
                        <div class="form-group">
                          <label>Key Achievement/Metrics (Optional)</label>
                          <input type="text" name="projectAchievement[]" placeholder="10K+ users, 40% performance improvement">
                        </div>
                      </div>
                    </div>
                  </div>
                  <button type="button" class="add-more-btn" onclick="addProject()">
                    <i class="fas fa-plus"></i> Add Another Project
                  </button>
                  <p style="color: #2ae023; font-size: 0.85rem; margin-top: 15px; opacity: 0.8;">
                    <i class="fas fa-lightbulb"></i> Tip: Include 2-4 key projects that showcase your skills. Focus on impact and technologies used.
                  </p>
                </div>
              </div>
              <div class="form-group" id="group-achievements">
                <label>
                  Achievements
                  <span class="field-skip" onclick="skipField('achievements')">Skip</span>
                </label>
                <textarea id="achievements" rows="3" placeholder="Awards, hackathons..."></textarea>
              </div>
              <div class="form-group" id="group-hobbies">
                <label>
                  Hobbies
                  <span class="field-skip" onclick="skipField('hobbies')">Skip</span>
                </label>
                <textarea id="hobbies" rows="2" placeholder="Photography, hiking..."></textarea>
              </div>
            </div>
          </div>

          <!-- References -->
          <div class="form-section" id="section-references">
            <h2 class="section-title">
              <i class="fas fa-users section-icon"></i> References
              <span class="skip-link" onclick="toggleSection('references')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="referencesContainer">
                <div class="reference-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="refName1">Reference Name</label>
                      <input type="text" id="refName1" name="refName[]" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                      <label for="refTitle1">Title/Position</label>
                      <input type="text" id="refTitle1" name="refTitle[]" placeholder="Senior Manager">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="refCompany1">Company</label>
                      <input type="text" id="refCompany1" name="refCompany[]" placeholder="Company Name">
                    </div>
                    <div class="form-group">
                      <label for="refPhone1">Phone</label>
                      <input type="tel" id="refPhone1" name="refPhone[]" placeholder="(555) 123-4567"
                             pattern="[\+]?[\d\s\-\(\)\.]+"
                             title="Please enter a valid phone number">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="refEmail1">Email</label>
                    <input type="email" id="refEmail1" name="refEmail[]" placeholder="reference@company.com"
                           title="Please enter a valid email address">
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addReference()">Add Another Reference</button>
            </div>
          </div>

          <!-- Custom Details -->
          <div class="form-section" id="section-custom">
            <h2 class="section-title">
              <i class="fas fa-edit section-icon"></i> Custom Details
              <span class="skip-link" onclick="toggleSection('custom')">Skip this section</span>
            </h2>
            <div class="form-content">
              <p style="color: #2ae023; font-size: 14px; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> Add any additional sections you need (e.g., Publications, Volunteer Work, Awards, etc.)
              </p>
              <div id="customDetailsContainer">
                <div class="custom-detail-item">
                  <div class="form-group">
                    <label for="customHeading1">Section Heading</label>
                    <input type="text" id="customHeading1" name="customHeading[]" placeholder="e.g., Publications, Volunteer Work, Awards">
                  </div>
                  <div class="form-group">
                    <label for="customContent1">Content</label>
                    <textarea id="customContent1" name="customContent[]" rows="4" placeholder="Describe the details for this section..."></textarea>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addCustomDetail()">Add Another Custom Section</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Buttons -->
    <div class="bottom-actions">
      <button type="button" class="btn" style="background: #ffa500; color: white;" onclick="fillSampleData()">
        <i class="fas fa-magic"></i> Fill Sample Data
      </button>
      <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
      <button type="button" class="btn btn-primary" onclick="generateResume()">Generate Resume</button>
    </div>

    <!-- Results -->
    <div id="resultsSection" style="display:none; margin-top:40px; text-align:center;">
      <h2 style="color:#2ae023; font-size:2.2rem; margin-bottom:20px;">Your Resume is Ready!</h2>
      <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin-top:30px;">
        <button class="btn btn-secondary" onclick="editResume()">Edit Details</button>
        <button class="btn btn-primary" onclick="downloadResume()">Download PDF</button>
        <button class="btn btn-primary" onclick="previewResume()">Preview</button>
      </div>
    </div>
  </div>

  <script>
    // Version: 2024-11-26-v3 - Modal close fix + getTemplateName defined at line 1681
    // Last updated: 2024-11-26 17:30
    // Global state
    let selectedTemplate = null;

    // ========== BACKEND CONFIGURATION ==========
    // Using Render deployed backend for production access
    
    const BACKEND_URL = "https://hiero-resume-backend.onrender.com";
    
    console.log('ðŸŒ Backend URL:', BACKEND_URL);
    console.log('ðŸ”§ Mode: Using Render production backend');

    // Add quick backend health ping (non-blocking, silent failure)
    // Only run if page is loaded via http/https (not file://)
    (async () => {
      // Skip health check if opened via file:// protocol (CORS will fail)
      if (window.location.protocol === 'file:') {
        console.log('â„¹ï¸ Skipping health check (file:// protocol)');
        return;
      }
      
      try {
        const backendUrl = BACKEND_URL;
        console.log('ðŸ” Checking backend health at:', backendUrl + '/health');
        
        const r = await fetch(backendUrl + '/health', { 
          cache: 'no-store',
          method: 'GET',
          mode: 'cors',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (r.ok) { 
          const data = await r.json();
          console.log('âœ… Backend health check passed:', backendUrl, data);
        } else { 
          console.warn('âš ï¸ Health endpoint returned:', r.status, 'for', backendUrl);
        }
      } catch (e) { 
        // Silent failure - don't show error if backend is not accessible yet
        // This is just a health check, not critical for functionality
        // Common reasons: CORS, network error, server not running
        console.debug('â„¹ï¸ Backend health check skipped (non-critical):', e.message);
      }
    })();

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear authentication
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        
        // Clear any resume builder data
        localStorage.removeItem('selectedTemplate');
        
        // Redirect to login
        window.location.href = '/dashboard/login.html';
      }
    }

    // Check authentication on page load
    function checkAuthentication() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');
      
      if (!token || !user) {
        // Not logged in - redirect to login
        alert('Please login to access the resume builder');
        window.location.href = '/dashboard/login.html';
        return false;
      }
      return true;
    }

    // Initialize page - always start at Step 1 (template selection)
    function initializePage() {
      // Always show template selection first
      document.getElementById('templateSelection').style.display = 'block';
      document.getElementById('formStepIndicator').style.display = 'none';
      document.querySelector('.main-layout').style.display = 'none';
      document.querySelector('.bottom-actions').style.display = 'none';
      
      // Remove the back button if it exists
      const existingBackBtn = document.getElementById('backToTemplatesBtn');
      if (existingBackBtn) {
        existingBackBtn.remove();
      }
      
      // Clear any previous template selection when returning to Step 1
      // (User can select a different template)
      selectedTemplate = null;
      
      console.log('Page initialized - showing Step 1 (template selection)');
      
      // Ensure history state is set to Step 1
      if (history.state === null || history.state.step !== 1) {
        history.replaceState({ step: 1 }, '', '');
      }
    }

    // Template selection functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in
      if (!checkAuthentication()) {
        return; // Stop execution if not authenticated
      }
      
      // Initialize page to Step 1
      initializePage();
      
      // ==================== BROWSER BACK BUTTON HANDLING ====================
      // Push initial state to prevent direct back to index.html
      history.pushState({ step: 1 }, '', '');
      
      // Handle browser back/forward button
      window.addEventListener('popstate', function(event) {
        // Prevent going back to index.html
        event.preventDefault();
        
        // Check which step we're currently on
        const formVisible = document.querySelector('.main-layout').style.display !== 'none';
        const templateVisible = document.getElementById('templateSelection').style.display !== 'none';
        
        if (formVisible) {
          history.pushState({ step: 1 }, '', '');
        } else {
          initializePage();
        }
      });
      
      // Prevent accidental back navigation from touch gestures (mobile/trackpad)
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      
      document.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });
      
      document.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;
        
        // Detect horizontal swipe (typical back gesture)
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
          // If user swipes from left to right, keep them on this page
          if (diffX > 0) {
            history.pushState({ step: 1 }, '', '');
          }
        }
      }, { passive: true });
      
      // ==================== END BACK BUTTON HANDLING ====================
      
      // Category filtering (if category buttons exist)
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const category = this.getAttribute('data-category');
          document.querySelectorAll('.template-card').forEach(card => {
            const cat = card.getAttribute('data-category');
            if (!category || category === 'all' || cat === category) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        });
      });
      
      // Load saved skip states for sections
      ['summary','experience','education','skills','projects','additional','references','custom'].forEach(sec => {
        if (localStorage.getItem('skip_section_' + sec) === 'true') {
          const el = document.getElementById('section-' + sec);
          const link = el ? el.querySelector('.skip-link') : null;
          if (el && link) {
            el.classList.add('skipped');
            link.textContent = 'Show section';
          }
        }
      });
      
      // Load saved skip states and values for individual fields
      ['address','linkedin','website','certifications','languages','projects','achievements','hobbies'].forEach(field => {
        const group = document.getElementById('group-' + field);
        const input = document.getElementById(field);
        const skip = localStorage.getItem('skip_field_' + field) === 'true';
        const savedValue = localStorage.getItem('field_value_' + field);
        
        if (group && input) {
          const label = group.querySelector('label');
          const skipSpan = label ? label.querySelector('.field-skip') : null;
          
          if (skip) {
            group.classList.add('skipped');
            if (skipSpan) skipSpan.textContent = 'Show';
            if (savedValue !== null) input.value = '';
          } else if (savedValue !== null) {
            input.value = savedValue;
          }
        }
      });
    });

    // Template preview functionality with backend-powered preview
    async function previewTemplate(templateId) {
      // Template metadata
      const templateDetails = {
        'classic': {
          name: 'Classic Professional',
          description: 'Clean, traditional layout perfect for any industry',
          style: 'Traditional serif fonts, centered header, clean sections'
        },
        'minimal': {
          name: 'Minimal',
          description: 'Ultra-clean design with excellent readability',
          style: 'Minimalist design, sans-serif fonts, lots of whitespace'
        },
        'modern-pro': {
          name: 'Modern Professional',
          description: 'Contemporary design with subtle colors',
          style: 'Modern layout, accent colors, professional styling'
        },
        'tech-focus': {
          name: 'Tech Focus',
          description: 'Designed specifically for developers',
          style: 'Code-friendly layout, technical sections, modern fonts'
        },
        'creative-bold': {
          name: 'Creative Bold',
          description: 'Eye-catching design for creative professionals',
          style: 'Bold typography, creative layout, vibrant colors'
        },
        'portfolio-style': {
          name: 'Portfolio Style',
          description: 'Showcase your work with visual elements',
          style: 'Visual-first design, project showcase, modern layout'
        },
        'ats-optimized': {
          name: 'ATS Optimized',
          description: 'Designed to pass Applicant Tracking Systems',
          style: 'Simple structure, ATS-friendly format, clear sections'
        },
        'corporate-ats': {
          name: 'Corporate ATS',
          description: 'Professional corporate design that\'s ATS-compatible',
          style: 'Corporate styling, ATS-compatible, professional look'
        },
        'elegant-gradient': {
          name: 'Elegant Gradient',
          description: 'Beautiful gradient design with elegant typography',
          style: 'Gradient accents, elegant fonts, sophisticated design'
        },
        'minimalist-mono': {
          name: 'Minimalist Mono',
          description: 'Ultra-minimalist monochrome design',
          style: 'Black and white, minimal elements, clean typography'
        },
        'rishi': {
          name: 'Rishi Tech Modern',
          description: 'Modern tech layout with purple gradient sidebar',
          style: 'Two-column design, purple gradient, blue accents, Inter font'
        },
        'priya': {
          name: 'Priya Analytical Resume',
          description: 'Analytical, structured resume optimized for data-driven, academic and research-oriented profiles with strong project sections.',
          style: 'Georgia serif fonts, centered header, elegant spacing, academic style'
        },
        'hiero-elite': {
          name: 'Hiero Elite',
          description: 'Exclusive template with advanced design and layout options. Ideal for executives and professionals seeking a premium look.',
          style: 'Sophisticated layout, premium accents, executive styling'
        }
      };

      const template = templateDetails[templateId];
      if (!template) return;

      // Create modal with loading state
      const modal = document.createElement('div');
      modal.className = 'preview-modal-overlay';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: rgba(0,0,0,0.85); display: flex; align-items: center; 
        justify-content: center; z-index: 10000; padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; 
                    max-height: 90vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
          <div style="padding: 25px 30px; border-bottom: 1px solid #eee; flex-shrink: 0;">
            <button onclick="this.closest('.preview-modal-overlay').remove()" 
                    style="position: absolute; top: 15px; right: 15px; background: none; 
                           border: none; font-size: 28px; cursor: pointer; color: #999; line-height: 1; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;"
                    onmouseover="this.style.background='#f0f0f0'; this.style.color='#333';"
                    onmouseout="this.style.background='none'; this.style.color='#999';">Ã—</button>
            <h2 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 24px;">${template.name}</h2>
            <p style="margin: 0; color: #7f8c8d; font-size: 14px;">${template.description}</p>
          </div>
          <div id="preview-content" style="flex: 1; overflow-y: auto; padding: 30px; display: flex; justify-content: center; align-items: flex-start; background: #f8f9fa; min-height: 400px;">
            <div style="text-align: center; color: #666; padding: 60px 20px;">
              <i class="fas fa-spinner fa-spin" style="font-size: 42px; margin-bottom: 15px; color: #2ae023;"></i>
              <p style="font-size: 16px; margin: 0;">Loading preview...</p>
            </div>
          </div>
          <div style="padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #e0e0e0; flex-shrink: 0;">
            <button onclick="startBuilding('${templateId}'); this.closest('.preview-modal-overlay').remove();" 
                    style="background: #2ae023; color: white; border: none; padding: 14px 28px; 
                           border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; font-size: 16px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(42,224,35,0.3);"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(42,224,35,0.4)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(42,224,35,0.3)';">
              Use This Template
            </button>
          </div>
        </div>
      `;

      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.remove();
      });

      document.body.appendChild(modal);

      // Try to fetch preview from backend, with fallback to static preview
      let previewLoaded = false;
      const previewContainer = modal.querySelector('#preview-content');

      try {
        console.log('ðŸ” Fetching preview for template via backend:', templateId, 'â†’', BACKEND_URL + '/preview-resume');

        // Build sample data for backend preview
        let sampleData = {
          template: templateId,
          personalInfo: {
            fullName: 'Rahul Mehta',
            email: 'rahul.mehta@example.com',
            phone: '+91 98765 43210',
            location: 'Bengaluru, India',
            linkedin: 'linkedin.com/in/rahulmehta',
            github: 'github.com/rahulmehta'
          },
          summary: 'Full-stack developer with 4+ years of experience building scalable web applications and distributed services.',
          experience: [
            {
              jobTitle: 'Senior Software Engineer',
              company: 'TechCorp Solutions',
              startDate: '2022-01',
              endDate: 'Present',
              description: 'â€¢ Led development of microservices architecture for core product\nâ€¢ Improved API performance by 35% through caching and query optimization\nâ€¢ Mentored 3 junior developers and established code review best practices'
            },
            {
              jobTitle: 'Software Engineer',
              company: 'StartupXYZ',
              startDate: '2020-06',
              endDate: '2021-12',
              description: 'â€¢ Developed full-stack web applications using React and Node.js\nâ€¢ Implemented RESTful APIs and database optimization\nâ€¢ Collaborated with cross-functional teams in Agile environment'
            }
          ],
          education: [
            {
              degree: 'Bachelor of Science in Computer Science',
              school: 'University of Technology',
              gradYear: '2020',
              gpa: '3.8/4.0'
            }
          ],
          technicalSkills: 'JavaScript, React, Node.js, Python, AWS, Docker, MongoDB, PostgreSQL, Git, CI/CD (Jenkins, GitHub Actions), RESTful APIs, GraphQL, Microservices Architecture',
          softSkills: 'Leadership, Communication, Problem-solving, Team collaboration, Project management',
          projects: 'E-commerce Platform: Built full-stack application with 10K+ users\nTask Management App: Developed mobile-responsive SaaS product',
          certifications: 'AWS Certified Solutions Architect, Google Cloud Professional'
        };

        // Customize sample data for Priya template (elegant academic style)
        if (templateId === 'priya') {
          sampleData = {
            template: 'priya',
            personalInfo: {
              fullName: 'Priya Sharma',
              rollNo: '191401001',
              program: 'Computer Science',
              course: 'B.Tech',
              institute: 'Indian Institute of Information Technology, Vadodara',
              phone: '+91-9876543210',
              email: 'priya.sharma@iitvadodara.ac.in',
              officialEmail: '191401001@iitvadodara.ac.in',
              github: 'github.com/priyasharma',
              linkedin: 'linkedin.com/in/priyasharma',
              languages: 'C, C++, Python, Java, JavaScript',
              developerTools: 'Git, VS Code, IntelliJ IDEA, Eclipse',
              frameworks: 'React, Node.js, Django, Spring Boot',
              cloudDatabases: 'AWS, Firebase, MySQL, MongoDB',
              softSkills: 'Communication, Leadership, Problem-solving, Teamwork'
            },
            education: [
              {
                degree: 'B.Tech in Computer Science and Engineering',
                school: 'IIIT Vadodara',
                gradYear: '2023',
                gpa: '8.9/10.0'
              }
            ],
            projects: 'Placement Portal: Developed full-stack portal for college placements\nResearch Project: Worked on ML-based traffic prediction',
            certifications: 'GATE CS 2023 Qualified, Data Structures & Algorithms certifications'
          };
        }

        const response = await fetch(`${BACKEND_URL}/preview-resume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(sampleData)
        });

        if (!response.ok) {
          const errText = await response.text().catch(() => '');
          console.warn('âš ï¸ Backend preview failed:', response.status, errText.slice(0, 200));
          throw new Error('Backend preview failed');
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);

        // Clear loading
        previewContainer.innerHTML = '';

        // Try to embed PDF in an <iframe>
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        previewContainer.appendChild(iframe);

        previewLoaded = true;

        // Revoke URL when modal is closed
        modal.addEventListener('click', e => {
          if (e.target === modal) {
            URL.revokeObjectURL(url);
          }
        });

      } catch (error) {
        console.error('âŒ Error fetching backend preview, falling back to static preview:', error);

        // Fallback static preview: simple template info & sample layout text
        if (!previewLoaded && previewContainer) {
          previewContainer.innerHTML = `
            <div style="max-width: 800px; width: 100%; background: white; padding: 32px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08);">
              <h2 style="margin-bottom: 8px; color: #2c3e50;">${template.name}</h2>
              <p style="margin-bottom: 16px; color: #7f8c8d;">${template.description}</p>
              <p style="margin-bottom: 6px; font-size: 13px; color: #95a5a6;"><strong>Design style:</strong> ${template.style}</p>
              <hr style="margin: 18px 0; border: none; border-top: 1px solid #ecf0f1;" />
              <p style="font-size: 14px; color: #34495e; line-height: 1.6;">
                This is a static preview because the live backend preview is currently unavailable.<br/>
                You can still use this template and see the full rendered resume via the normal Preview / Download buttons after filling your information.
              </p>
            </div>
          `;
        }
      }
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear authentication
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        
        // Clear any resume builder data
        localStorage.removeItem('selectedTemplate');
        
        // Redirect to login
        window.location.href = '/dashboard/login.html';
      }
    }

    // Check authentication on page load
    function checkAuthentication() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');
      
      if (!token || !user) {
        // Not logged in - redirect to login
        alert('Please login to access the resume builder');
        window.location.href = '/dashboard/login.html';
        return false;
      }
      return true;
    }

    // Initialize page - always start at Step 1 (template selection)
    function initializePage() {
      // Always show template selection first
      document.getElementById('templateSelection').style.display = 'block';
      document.getElementById('formStepIndicator').style.display = 'none';
      document.querySelector('.main-layout').style.display = 'none';
      document.querySelector('.bottom-actions').style.display = 'none';
      
      // Remove the back button if it exists
      const existingBackBtn = document.getElementById('backToTemplatesBtn');
      if (existingBackBtn) {
        existingBackBtn.remove();
      }
      
      // Clear any previous template selection when returning to Step 1
      // (User can select a different template)
      selectedTemplate = null;
      
      console.log('Page initialized - showing Step 1 (template selection)');
      
      // Ensure history state is set to Step 1
      if (history.state === null || history.state.step !== 1) {
        history.replaceState({ step: 1 }, '', '');
      }
    }

    // Template selection functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in
      if (!checkAuthentication()) {
        return; // Stop execution if not authenticated
      }
      
      // Initialize page to Step 1
      initializePage();
      
      // ==================== BROWSER BACK BUTTON HANDLING ====================
      // Push initial state to prevent direct back to index.html
      history.pushState({ step: 1 }, '', '');
      
      // Handle browser back/forward button
      window.addEventListener('popstate', function(event) {
        // Prevent going back to index.html
        event.preventDefault();
        
        // Check which step we're currently on
        const formVisible = document.querySelector('.main-layout').style.display !== 'none';
        const templateVisible = document.getElementById('templateSelection').style.display !== 'none';
        
        if (formVisible) {
          history.pushState({ step: 1 }, '', '');
        } else {
          initializePage();
        }
      });
      
      // Prevent accidental back navigation from touch gestures (mobile/trackpad)
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      
      document.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });
      
      document.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;
        
        // Detect horizontal swipe (typical back gesture)
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
          // If user swipes from left to right, keep them on this page
          if (diffX > 0) {
            history.pushState({ step: 1 }, '', '');
          }
        }
      }, { passive: true });
      
      // ==================== END BACK BUTTON HANDLING ====================
      
      // Category filtering (if category buttons exist)
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const category = this.getAttribute('data-category');
          document.querySelectorAll('.template-card').forEach(card => {
            const cat = card.getAttribute('data-category');
            if (!category || category === 'all' || cat === category) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        });
      });
      
      // Load saved skip states for sections
      ['summary','experience','education','skills','projects','additional','references','custom'].forEach(sec => {
        if (localStorage.getItem('skip_section_' + sec) === 'true') {
          const el = document.getElementById('section-' + sec);
          const link = el ? el.querySelector('.skip-link') : null;
          if (el && link) {
            el.classList.add('skipped');
            link.textContent = 'Show section';
          }
        }
      });
      
      // Load saved skip states and values for individual fields
      ['address','linkedin','website','certifications','languages','projects','achievements','hobbies'].forEach(field => {
        const group = document.getElementById('group-' + field);
        const input = document.getElementById(field);
        const skip = localStorage.getItem('skip_field_' + field) === 'true';
        const savedValue = localStorage.getItem('field_value_' + field);
        
        if (group && input) {
          const label = group.querySelector('label');
          const skipSpan = label ? label.querySelector('.field-skip') : null;
          
          if (skip) {
            group.classList.add('skipped');
            if (skipSpan) skipSpan.textContent = 'Show';
            if (savedValue !== null) input.value = '';
          } else if (savedValue !== null) {
            input.value = savedValue;
          }
        }
      });
    });

    // Template preview functionality with backend-powered preview
    async function previewTemplate(templateId) {
      // Template metadata
      const templateDetails = {
        'classic': {
          name: 'Classic Professional',
          description: 'Clean, traditional layout perfect for any industry',
          style: 'Traditional serif fonts, centered header, clean sections'
        },
        'minimal': {
          name: 'Minimal',
          description: 'Ultra-clean design with excellent readability',
          style: 'Minimalist design, sans-serif fonts, lots of whitespace'
        },
        'modern-pro': {
          name: 'Modern Professional',
          description: 'Contemporary design with subtle colors',
          style: 'Modern layout, accent colors, professional styling'
        },
        'tech-focus': {
          name: 'Tech Focus',
          description: 'Designed specifically for developers',
          style: 'Code-friendly layout, technical sections, modern fonts'
        },
        'creative-bold': {
          name: 'Creative Bold',
          description: 'Eye-catching design for creative professionals',
          style: 'Bold typography, creative layout, vibrant colors'
        },
        'portfolio-style': {
          name: 'Portfolio Style',
          description: 'Showcase your work with visual elements',
          style: 'Visual-first design, project showcase, modern layout'
        },
        'ats-optimized': {
          name: 'ATS Optimized',
          description: 'Designed to pass Applicant Tracking Systems',
          style: 'Simple structure, ATS-friendly format, clear sections'
        },
        'corporate-ats': {
          name: 'Corporate ATS',
          description: 'Professional corporate design that\'s ATS-compatible',
          style: 'Corporate styling, ATS-compatible, professional look'
        },
        'elegant-gradient': {
          name: 'Elegant Gradient',
          description: 'Beautiful gradient design with elegant typography',
          style: 'Gradient accents, elegant fonts, sophisticated design'
        },
        'minimalist-mono': {
          name: 'Minimalist Mono',
          description: 'Ultra-minimalist monochrome design',
          style: 'Black and white, minimal elements, clean typography'
        },
        'rishi': {
          name: 'Rishi Tech Modern',
          description: 'Modern tech layout with purple gradient sidebar',
          style: 'Two-column design, purple gradient, blue accents, Inter font'
        },
        'priya': {
          name: 'Priya Analytical Resume',
          description: 'Analytical, structured resume optimized for data-driven, academic and research-oriented profiles with strong project sections.',
          style: 'Georgia serif fonts, centered header, elegant spacing, academic style'
        },
        'hiero-elite': {
          name: 'Hiero Elite',
          description: 'Exclusive template with advanced design and layout options. Ideal for executives and professionals seeking a premium look.',
          style: 'Sophisticated layout, premium accents, executive styling'
        }
      };

      const template = templateDetails[templateId];
      if (!template) return;

      // Create modal with loading state
      const modal = document.createlement('div');
      modal.className = 'preview-modal-overlay';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: rgba(0,0,0,0.85); display: flex; align-items: center; 
        justify-content: center; z-index: 10000; padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; 
                    max-height: 90vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
          <div style="padding: 25px 30px; border-bottom: 1px solid #eee; flex-shrink: 0;">
            <button onclick="this.closest('.preview-modal-overlay').remove()" 
                    style="position: absolute; top: 15px; right: 15px; background: none; 
                           border: none; font-size: 28px; cursor: pointer; color: #999; line-height: 1; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;"
                    onmouseover="this.style.background='#f0f0f0'; this.style.color='#333';"
                    onmouseout="this.style.background='none'; this.style.color='#999';">Ã—</button>
            <h2 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 24px;">${template.name}</h2>
            <p style="margin: 0; color: #7f8c8d; font-size: 14px;">${template.description}</p>
          </div>
          <div id="preview-content" style="flex: 1; overflow-y: auto; padding: 30px; display: flex; justify-content: center; align-items: flex-start; background: #f8f9fa; min-height: 400px;">
            <div style="text-align: center; color: #666; padding: 60px 20px;">
              <i class="fas fa-spinner fa-spin" style="font-size: 42px; margin-bottom: 15px; color: #2ae023;"></i>
              <p style="font-size: 16px; margin: 0;">Loading preview...</p>
            </div>
          </div>
          <div style="padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #e0e0e0; flex-shrink: 0;">
            <button onclick="startBuilding('${templateId}'); this.closest('.preview-modal-overlay').remove();" 
                    style="background: #2ae023; color: white; border: none; padding: 14px 28px; 
                           border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; font-size: 16px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(42,224,35,0.3);"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(42,224,35,0.4)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(42,224,35,0.3)';">
              Use This Template
            </button>
          </div>
        </div>
      `;

      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.remove();
      });

      document.body.appendChild(modal);

      // Try to fetch preview from backend, with fallback to static preview
      let previewLoaded = false;
      const previewContainer = modal.querySelector('#preview-content');

      try {
        console.log('ðŸ” Fetching preview for template via backend:', templateId, 'â†’', BACKEND_URL + '/preview-resume');

        // Build sample data for backend preview
        let sampleData = {
          template: templateId,
          personalInfo: {
            fullName: 'Rahul Mehta',
            email: 'rahul.mehta@example.com',
            phone: '+91 98765 43210',
            location: 'Bengaluru, India',
            linkedin: 'linkedin.com/in/rahulmehta',
            github: 'github.com/rahulmehta'
          },
          summary: 'Full-stack developer with 4+ years of experience building scalable web applications and distributed services.',
          experience: [
            {
              jobTitle: 'Senior Software Engineer',
              company: 'TechCorp Solutions',
              startDate: '2022-01',
              endDate: 'Present',
              description: 'â€¢ Led development of microservices architecture for core product\nâ€¢ Improved API performance by 35% through caching and query optimization\nâ€¢ Mentored 3 junior developers and established code review best practices'
            },
            {
              jobTitle: 'Software Engineer',
              company: 'StartupXYZ',
              startDate: '2020-06',
              endDate: '2021-12',
              description: 'â€¢ Developed full-stack web applications using React and Node.js\nâ€¢ Implemented RESTful APIs and database optimization\nâ€¢ Collaborated with cross-functional teams in Agile environment'
            }
          ],
          education: [
            {
              degree: 'Bachelor of Science in Computer Science',
              school: 'University of Technology',
              gradYear: '2020',
              gpa: '3.8/4.0'
            }
          ],
          technicalSkills: 'JavaScript, React, Node.js, Python, AWS, Docker, MongoDB, PostgreSQL, Git, CI/CD (Jenkins, GitHub Actions), RESTful APIs, GraphQL, Microservices Architecture',
          softSkills: 'Leadership, Communication, Problem-solving, Team collaboration, Project management',
          projects: 'E-commerce Platform: Built full-stack application with 10K+ users\nTask Management App: Developed mobile-responsive SaaS product',
          certifications: 'AWS Certified Solutions Architect, Google Cloud Professional'
        };

        // Customize sample data for Priya template (elegant academic style)
        if (templateId === 'priya') {
          sampleData = {
            template: 'priya',
            personalInfo: {
              fullName: 'Priya Sharma',
              rollNo: '191401001',
              program: 'Computer Science',
              course: 'B.Tech',
              institute: 'Indian Institute of Information Technology, Vadodara',
              phone: '+91-9876543210',
              email: 'priya.sharma@iitvadodara.ac.in',
              officialEmail: '191401001@iitvadodara.ac.in',
              github: 'github.com/priyasharma',
              linkedin: 'linkedin.com/in/priyasharma',
              languages: 'C, C++, Python, Java, JavaScript',
              developerTools: 'Git, VS Code, IntelliJ IDEA, Eclipse',
              frameworks: 'React, Node.js, Django, Spring Boot',
              cloudDatabases: 'AWS, Firebase, MySQL, MongoDB',
              softSkills: 'Communication, Leadership, Problem-solving, Teamwork'
            },
            education: [
              {
                degree: 'B.Tech in Computer Science and Engineering',
                school: 'IIIT Vadodara',
                gradYear: '2023',
                gpa: '8.9/10.0'
              }
            ],
            projects: 'Placement Portal: Developed full-stack portal for college placements\nResearch Project: Worked on ML-based traffic prediction',
            certifications: 'GATE CS 2023 Qualified, Data Structures & Algorithms certifications'
          };
        }

        const response = await fetch(`${BACKEND_URL}/preview-resume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(sampleData)
        });

        if (!response.ok) {
          const errText = await response.text().catch(() => '');
          console.warn('âš ï¸ Backend preview failed:', response.status, errText.slice(0, 200));
          throw new Error('Backend preview failed');
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);

        // Clear loading
        previewContainer.innerHTML = '';

        // Try to embed PDF in an <iframe>
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        previewContainer.appendChild(iframe);

        previewLoaded = true;

        // Revoke URL when modal is closed
        modal.addEventListener('click', e => {
          if (e.target === modal) {
            URL.revokeObjectURL(url);
          }
        });

      } catch (error) {
        console.error('âŒ Error fetching backend preview, falling back to static preview:', error);

        // Fallback static preview: simple template info & sample layout text
        if (!previewLoaded && previewContainer) {
          previewContainer.innerHTML = `
            <div style="max-width: 800px; width: 100%; background: white; padding: 32px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08);">
              <h2 style="margin-bottom: 8px; color: #2c3e50;">${template.name}</h2>
              <p style="margin-bottom: 16px; color: #7f8c8d;">${template.description}</p>
              <p style="margin-bottom: 6px; font-size: 13px; color: #95a5a6;"><strong>Design style:</strong> ${template.style}</p>
              <hr style="margin: 18px 0; border: none; border-top: 1px solid #ecf0f1;" />
              <p style="font-size: 14px; color: #34495e; line-height: 1.6;">
                This is a static preview because the live backend preview is currently unavailable.<br/>
                You can still use this template and see the full rendered resume via the normal Preview / Download buttons after filling your information.
              </p>
            </div>
          `;
        }
      }
    }

    function collectFormData() {
      const data = { personalInfo: {}, experience: [], education: [], references: [], customDetails: [] };

      // Personal
      data.personalInfo.fullName = document.getElementById('fullName').value;
      data.personalInfo.email = document.getElementById('email').value;
      data.personalInfo.phone = document.getElementById('phone').value;

      // Optional fields (only if not skipped and not empty)
      const optional = ['address','linkedin','website','summary','technicalSkills','softSkills','certifications','languages','achievements','hobbies'];
      optional.forEach(field => {
        const group = document.getElementById('group-' + field) || document.getElementById('section-' + field);
        const input = document.getElementById(field);
        if (group && !group.classList.contains('skipped') && input && input.value.trim()) {
          data[field] = input.value.trim();
        }
      });

      // Projects (structured data)
      const projectsSection = document.getElementById('section-projects');
      if (projectsSection && !projectsSection.classList.contains('skipped')) {
        data.projects = [];
        document.querySelectorAll('input[name="projectName[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            const project = {
              name: el.value.trim(),
              technologies: document.querySelectorAll('input[name="projectTech[]"]')[i]?.value || '',
              duration: document.querySelectorAll('input[name="projectDuration[]"]')[i]?.value || '',
              description: document.querySelectorAll('textarea[name="projectDescription[]"]')[i]?.value || '',
              link: document.querySelectorAll('input[name="projectLink[]"]')[i]?.value || '',
              achievement: document.querySelectorAll('input[name="projectAchievement[]"]')[i]?.value || ''
            };
            data.projects.push(project);
          }
        });
        // If no structured projects, fall back to old textarea format
        if (data.projects.length === 0) {
          const oldProjectsInput = document.getElementById('projects');
          if (oldProjectsInput && oldProjectsInput.value.trim()) {
            data.projects = oldProjectsInput.value.trim();
          }
        }
      } else {
        // Fallback to old textarea if section is skipped
        const oldProjectsInput = document.getElementById('projects');
        if (oldProjectsInput && oldProjectsInput.value.trim()) {
          data.projects = oldProjectsInput.value.trim();
        }
      }

      // Experience & Education
      document.querySelectorAll('input[name="jobTitle[]"]').forEach((el, i) => {
        if (el.value.trim()) {
          data.experience.push({
            jobTitle: el.value,
            company: document.querySelectorAll('input[name="company[]"]')[i].value,
            startDate: document.querySelectorAll('input[name="startDate[]"]')[i].value,
            endDate: document.querySelectorAll('input[name="endDate[]"]')[i].value,
            description: document.querySelectorAll('textarea[name="jobDescription[]"]')[i].value
          });
        }
      });

      document.querySelectorAll('input[name="degree[]"]').forEach((el, i) => {
        if (el.value.trim()) {
          data.education.push({
            degree: el.value,
            school: document.querySelectorAll('input[name="school[]"]')[i].value,
            gradYear: document.querySelectorAll('input[name="gradYear[]"]')[i].value,
            gpa: document.querySelectorAll('input[name="gpa[]"]')[i].value
          });
        }
      });

      // References (only if section is not skipped)
      const refSection = document.getElementById('section-references');
      if (refSection && !refSection.classList.contains('skipped')) {
        document.querySelectorAll('input[name="refName[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            data.references.push({
              name: el.value,
              title: document.querySelectorAll('input[name="refTitle[]"]')[i].value,
              company: document.querySelectorAll('input[name="refCompany[]"]')[i].value,
              phone: document.querySelectorAll('input[name="refPhone[]"]')[i].value,
              email: document.querySelectorAll('input[name="refEmail[]"]')[i].value
            });
          }
        });
      }

      // Custom Details (only if section is not skipped)
      const customSection = document.getElementById('section-custom');
      if (customSection && !customSection.classList.contains('skipped')) {
        document.querySelectorAll('input[name="customHeading[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            data.customDetails.push({
              heading: el.value,
              content: document.querySelectorAll('textarea[name="customContent[]"]')[i].value
            });
          }
        });
      }

      return data;
    }

    function clearForm() {
      if(confirm('This will clear all form data and return to template selection. Continue?')) {
        localStorage.clear();
        location.reload();
      }
    }

    function editResume() {
      document.getElementById('resultsSection').style.display = 'none';
      document.querySelector('.main-layout').style.display = 'grid';
      document.querySelector('.bottom-actions').style.display = 'flex';
    }

    // Download and Preview with backend integration
    async function downloadResume() {
      const btn = event.target;
      const originalText = btn.innerHTML;
      
      // Show more informative loading message
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF... (this may take 5-10 seconds)';
      btn.disabled = true;

      try {
        const data = JSON.parse(localStorage.getItem('resumeData') || '{}');
        
        // Ensure template is included
        if (!data.template) {
          data.template = selectedTemplate || localStorage.getItem('selectedTemplate') || 'classic';
        }
        
        console.log('ðŸ“¡ POST', `${BACKEND_URL}/download-resume`);
        const response = await fetch(`${BACKEND_URL}/download-resume`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/pdf'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ Server error:', errorText);
          throw new Error(`Download failed: ${response.status} ${response.statusText}`);
        }

        // Check content type
        const contentType = response.headers.get('content-type');
        console.log('ðŸ“„ Response Content-Type:', contentType);
        
        if (!contentType || !contentType.includes('application/pdf')) {
          const text = await response.text();
          console.error('âŒ Response is not PDF!', text.substring(0, 200));
          throw new Error('Server returned non-PDF response');
        }

        const blob = await response.blob();
        console.log('âœ… PDF blob received, size:', blob.size, 'bytes, type:', blob.type);
        
        if (blob.size === 0) {
          throw new Error('Received empty PDF file');
        }
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${data.personalInfo?.fullName || 'resume'}_${data.template}_resume.pdf`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        }, 100);

      } catch (error) {
        console.error('Download error full:', error);
        alert(`Failed to download resume: ${error.message}. Please try again.`);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    async function previewResume() {
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Preview...';
      btn.disabled = true;

      try {
        const data = JSON.parse(localStorage.getItem('resumeData') || '{}');
        
        // Ensure template is included
        if (!data.template) {
          data.template = selectedTemplate || localStorage.getItem('selectedTemplate') || 'classic';
        }
        
        console.log('Previewing resume with template:', data.template);
        
        const response = await fetch(`${BACKEND_URL}/preview-resume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Preview failed' }));
          throw new Error(errorData.error || 'Preview failed');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        window.open(url, '_blank');
        
        setTimeout(() => window.URL.revokeObjectURL(url), 1000);

      } catch (error) {
        console.error('Preview error:', error);
        alert(`Failed to preview resume: ${error.message}. Please try again.`);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>