<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hiero Resume Builder</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #000501 0%, #2cc42c 100%);
      min-height: 100vh;
      color: #0b0a0a;
      line-height: 1.6;
    }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    
    /* Template Selection Styles */
    .template-selection {
      background: rgb(3,2,2);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      border: 1px solid rgba(45,196,44,0.15);
    }
    
    .template-categories {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    
    .category-btn {
      padding: 12px 24px;
      border: 2px solid rgba(45,196,44,0.3);
      background: transparent;
      color: #2ae023;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .category-btn.active {
      background: #2ae023;
      color: #000;
      border-color: #2ae023;
    }
    
    .category-btn:hover {
      background: rgba(42,224,35,0.1);
      border-color: #2ae023;
    }
    
    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .template-card {
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(45,196,44,0.2);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .template-card:hover {
      border-color: #2ae023;
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(42,224,35,0.2);
    }
    
    .template-card.premium {
      border-color: #ffd700;
    }
    
    .template-card.premium:hover {
      border-color: #ffd700;
      box-shadow: 0 15px 40px rgba(255,215,0,0.2);
    }
    
    .premium-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .template-preview {
      width: 100%;
      height: 200px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2ae023;
      font-size: 3rem;
      border: 1px solid rgba(45,196,44,0.2);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .template-preview:hover {
      background: rgba(255,255,255,0.15);
      border-color: #2ae023;
    }
    
    .preview-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .template-preview:hover .preview-overlay {
      opacity: 1;
    }
    
    .preview-btn {
      background: rgba(42,224,35,0.2);
      color: #2ae023;
      border: 2px solid #2ae023;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .preview-btn:hover {
      background: #2ae023;
      color: #000;
    }
    
    .template-info h3 {
      color: #2ae023;
      font-size: 1.2rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .template-info p {
      color: #ccc;
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 15px;
    }
    
    .template-tags {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tag {
      background: rgba(42,224,35,0.2);
      color: #2ae023;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .start-building-btn {
      width: 100%;
      background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .start-building-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(42,224,35,0.3);
    }
    
    /* Hide form initially */
    .main-layout { display:none; grid-template-columns:1fr 1fr; gap:30px; align-items:start; }
    .left-pane, .right-pane {
      background: rgb(3,2,2);
      border-radius:24px;
      padding:35px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.05);
      border:1px solid rgba(45,196,44,0.15);
    }
    .bottom-actions { display:none; gap:20px; justify-content:center; margin-top:40px; }
    .btn { padding:18px 36px; border:none; border-radius:16px; font-size:17px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:12px; transition:all .35s ease; }
    .btn-primary { background:linear-gradient(135deg,#05b41c 0%,#06c719 100%); color:white; box-shadow:0 8px 25px rgba(5,180,28,.4); }
    .btn-primary:hover { transform:translateY(-4px); box-shadow:0 15px 35px rgba(7,210,7,.6); }
    .btn-secondary { background:rgba(255,255,255,.12); color:#ddd; border:2px solid rgba(226,232,240,.3); }
    .btn-secondary:hover { background:rgba(1,6,11,.8); border-color:#0fdc2a; color:#0fdc2a; transform:translateY(-4px); }

    /* Modal styles for template preview */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 30px;
      border-bottom: 1px solid #eee;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      line-height: 1;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: #f5f5f5;
      color: #333;
    }

    .modal-preview {
      padding: 40px;
      display: flex;
      justify-content: center;
      background: #f8f9fa;
      min-height: 400px;
      align-items: center;
    }

    .modal-footer {
      padding: 20px 30px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }

    .modal-use-btn {
      background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .modal-use-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(42,224,35,0.3);
    }

    .header { 
      text-align:center; 
      margin-bottom:45px; 
      background:rgb(3,2,2); 
      padding:70px 35px 35px 35px; /* Extra top padding for buttons */
      border-radius:28px; 
      box-shadow:0 25px 50px rgba(0,0,0,.2); 
      position: relative;
    }
    .header h1 { font-size:3rem; color:#06a529; font-weight:800; letter-spacing:-0.5px; }
    .header p { font-size:1.2rem; color:#ccc; font-weight:500; max-width:600px; margin:0 auto; }
    
    /* Header Navigation Buttons - FIXED FOR MOBILE */
    .header-nav {
      position: absolute;
      top: 15px;
      right: 15px;
      left: 15px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      z-index: 10;
    }
    .header-nav button {
      background: rgba(45,196,44,0.2);
      color: #2ae023;
      border: 2px solid #2ae023;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .header-nav button:hover {
      background: #2ae023;
      color: #000;
    }
    .header-nav button.logout-btn {
      border-color: #ff6b6b;
      color: #ff6b6b;
      background: rgba(255,107,107,0.1);
    }
    .header-nav button.logout-btn:hover {
      background: #ff6b6b;
      color: white;
    }

    .step-indicator { 
      text-align:center; 
      margin-bottom:40px; 
      position: relative;
      padding: 20px 150px; /* Space for back button */
    }
    .step-text { background:linear-gradient(135deg,#66ea75 0%,#07cf0d 100%); color:rgb(37,40,37); padding:14px 30px; border-radius:50px; font-weight:700; font-size:1.15rem; box-shadow:0 6px 20px rgba(7,207,13,.3); }

    .form-section { margin-bottom:50px; position:relative; transition: all .4s ease; }
    .form-section.skipped { opacity:0.4; /* removed pointer-events:none to keep Show link clickable */ max-height:60px; overflow:hidden; }
    .form-section.skipped .form-content { display:none; }

    .section-title {
      font-size:2rem; color:#04ab07ee; margin-bottom:30px; padding-bottom:16px;
      border-bottom:4px solid #0d8705; display:flex; align-items:center; gap:16px;
      font-weight:700; position:relative; flex-wrap:wrap;
    }
    .section-title::before { content:''; position:absolute; bottom:-4px; left:0; width:80px; height:4px; background:#2ae023; border-radius:2px; }
    .section-icon { color:#2ae023; font-size:1.8rem; width:50px; height:50px; display:flex; align-items:center; justify-content:center; background:rgba(42,224,35,.15); border-radius:12px; border:1px solid rgba(42,224,35,.3); }

    .skip-link {
      font-size: 0.85rem; color: #75ea66; cursor: pointer; font-weight: 600;
      text-decoration: underline; text-underline-offset: 3px; opacity: 0.8; margin-left:8px;
    }
    .skip-link:hover { color: #2ae023; opacity: 1; }

    .field-skip {
      font-size: 0.75rem; color: #75ea66; cursor: pointer; margin-left: 8px; font-weight: 500;
      text-decoration: underline; opacity: 0.7;
    }
    .field-skip:hover { opacity: 1; color: #2ae023; }

    .form-group { margin-bottom:26px; position:relative; }
    .form-group.skipped { opacity:0.4; /* removed pointer-events:none to allow clicking Show */ }
    .form-group.skipped input, .form-group.skipped textarea { display:none; }

    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    label { display:block; margin-bottom:10px; font-weight:600; color:#0fdc2a; font-size:15px; display:flex; align-items:center; gap:5px; }
    .required { color:#e53e3e; }

    input:not([type="checkbox"]), textarea {
      width:100%; padding:17px 18px; border:2px solid rgba(226,232,240,.25); border-radius:16px;
      font-size:16px; background:rgba(255,255,255,.08); color:#fff; backdrop-filter:blur(5px);
      transition:all .3s ease;
    }
    input:not([type="checkbox"]):focus, textarea:focus { outline:none; border-color:#12ca12; box-shadow:0 0 0 4px rgba(18,202,18,.2), 0 8px 25px rgba(18,202,18,.15); transform:translateY(-1px); background:rgba(255,255,255,.12); }
    textarea { resize:vertical; min-height:120px; }
    
    /* Checkbox styling */
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #2ae023;
      flex-shrink: 0;
    }
    
    /* Currently working here checkbox container */
    .checkbox-container {
      margin-top: 5px;
      margin-bottom: 15px;
    }
    
    .checkbox-container label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #0fdc2a;
      cursor: pointer;
      margin-bottom: 0;
    }

    .experience-item, .education-item {
      background:rgba(248,249,250,.1); padding:28px; border-radius:18px; margin-bottom:20px;
      border-left:6px solid #75ea66; border:1px solid rgba(117,234,102,.25); transition:all .35s ease;
    }
    .experience-item:hover, .education-item:hover { transform:translateY(-3px); box-shadow:0 15px 35px rgba(117,234,102,.2); }

    .reference-item, .custom-detail-item {
      background:rgba(248,249,250,.1); padding:28px; border-radius:18px; margin-bottom:20px;
      border-left:6px solid #2ae023; border:1px solid rgba(42,224,35,.25); transition:all .35s ease;
    }
    .reference-item:hover, .custom-detail-item:hover { transform:translateY(-3px); box-shadow:0 15px 35px rgba(42,224,35,.2); }

    .project-item {
      background:rgba(248,249,250,.1); padding:28px; border-radius:18px; margin-bottom:20px;
      border-left:6px solid #2ae023; border:1px solid rgba(42,224,35,.25); transition:all .35s ease;
      position: relative;
    }
    .project-item:hover { transform:translateY(-3px); box-shadow:0 15px 35px rgba(42,224,35,.2); }

    .add-more-btn {
      background:rgba(226,232,240,.15); color:#bbb; border:2px dashed rgba(203,213,224,.5);
      padding:18px; border-radius:16px; cursor:pointer; transition:all .35s ease; margin:20px 0;
      font-weight:600; font-size:15px; backdrop-filter:blur(5px);
    }
    .add-more-btn:hover { background:rgba(117,234,102,.15); border-color:#75ea66; color:#75ea66; transform:translateY(-2px); }

    .remove-btn {
      background:rgba(254,215,215,.25); color:#e53e3e; border:none; padding:10px 16px;
      border-radius:12px; cursor:pointer; font-size:13px; float:right; font-weight:600;
      transition:all .3s ease; backdrop-filter:blur(5px);
    }
    .remove-btn:hover { background:#fca5a5; transform:scale(1.05); }

    @media (max-width:768px) {
      .main-layout { grid-template-columns:1fr; }
      .form-row { grid-template-columns:1fr; }
      .btn { width:100%; justify-content:center; }
      .header { padding: 60px 20px 30px; }
      .header h1 { font-size:2.3rem; }
      .section-title { font-size:1.8rem; }
      .header-nav {
        top: 10px;
        right: 10px;
        left: 10px;
        justify-content: space-between;
        gap: 8px;
      }
      .header-nav button {
        font-size: 11px;
        padding: 8px 12px;
        flex: 1;
        min-width: 0;
      }
      #backToTemplatesBtn {
        position: static !important;
        transform: none !important;
        margin-bottom: 15px;
        width: 100%;
      }
      .step-indicator {
        padding: 20px 10px !important;
      }
      
      /* Mobile-optimized form inputs */
      input, textarea {
        padding: 14px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
        -webkit-appearance: none;
        appearance: none;
        border-radius: 12px;
      }
      
      textarea {
        min-height: 100px;
      }
      
      /* Better mobile spacing for form sections */
      .form-section {
        margin-bottom: 35px;
      }
      
      .section-title {
        font-size: 1.6rem;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .section-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
      }
      
      /* Mobile template grid */
      .templates-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .template-card {
        padding: 18px;
      }
      
      .template-categories {
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .category-btn {
        padding: 10px 18px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-nav">
        <button onclick="window.location.href='/dashboard'">
          <i class="fas fa-home"></i> Dashboard
        </button>
        <button onclick="logout()" style="border-color: #ff6b6b; color: #ff6b6b;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
      <h1>Hiero Resume Builder</h1>
      <p>Create your professional resume in simple steps</p>
    </div>

    <!-- Template Selection Section -->
    <div class="template-selection" id="templateSelection">
      <div class="step-indicator" style="margin-bottom: 40px;">
        <div class="step-text">Step 1: Choose Your Template</div>
      </div>
      
      <!-- Removed template categories since we only have one template -->
      
      <div class="templates-grid" id="templatesGrid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); max-width: 1200px; margin: 0 auto;">
        <!-- Hiero Pro Template (formerly Rishi) -->
        <div class="template-card" data-category="modern" data-template="rishi" data-type="free">
          <div class="template-preview" onclick="previewTemplate('rishi')">
            <i class="fas fa-laptop-code"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Hiero Pro Template</h3>
            <p>Professional modern template with clean design and excellent readability. Perfect for all industries and career levels.</p>
            <div class="template-tags">
              <span class="tag">Modern</span>
              <span class="tag">Professional</span>
              <span class="tag">ATS-Friendly</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('rishi')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>

        <!-- Priya Analytics Single-Column Template (matches Priya Sharma PDF) -->
        <div class="template-card" data-category="analytics" data-template="priya-analytics" data-type="free">
          <div class="template-preview" onclick="previewTemplate('priya-analytics')">
            <i class="fas fa-chart-line"></i>
            <div class="preview-overlay">
              <button class="preview-btn">Preview Template</button>
            </div>
          </div>
          <div class="template-info">
            <h3>Priya Analytics Template</h3>
            <p>Single-column layout with a grey top bar and bold section headings. Ideal for data-driven professionals.</p>
            <div class="template-tags">
              <span class="tag">Analytics</span>
              <span class="tag">Single Column</span>
              <span class="tag">Data Science</span>
            </div>
            <button class="start-building-btn" onclick="startBuilding('priya-analytics')">
              <i class="fas fa-arrow-right"></i> Start Building
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Form Section (Initially Hidden) -->
    <div class="step-indicator" id="formStepIndicator" style="display: none;">
      <div class="step-text">Step 2: Fill Your Information</div>
    </div>

    <div class="main-layout">
      <!-- LEFT PANE -->
      <div class="left-pane">
        <form id="resumeForm">
          <!-- Personal Info -->
          <div class="form-section" id="section-personal">
            <h2 class="section-title">
              <i class="fas fa-user section-icon"></i> Personal Information
            </h2>
            <div class="form-content">
              <div class="form-group">
                <label for="fullName">Full Name <span class="required">*</span></label>
                <input type="text" id="fullName" required placeholder="Enter your full name">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="email">Email <span class="required">*</span></label>
                  <input type="email" id="email" required placeholder="john.doe@example.com" 
                         title="Please enter a valid email address (e.g., john@example.com)">
                  <small style="color: #666; font-size: 12px;">Examples: john@gmail.com, jane.doe@company.org</small>
                </div>
                <div class="form-group">
                  <label for="phone">Phone <span class="required">*</span></label>
                  <input type="tel" id="phone" required placeholder="+1 555-123-4567"
                         pattern="[\+]?[\d\s\-\(\)\.]+"
                         title="Please enter a valid phone number (numbers, spaces, dashes, parentheses, and + allowed)">
                  <small style="color: #666; font-size: 12px;">Examples: +1 555-123-4567, (555) 123-4567, 555.123.4567</small>
                </div>
              </div>

              <!-- Optional: Address -->
              <div class="form-group" id="group-address">
                <label>
                  Address
                  <span class="field-skip" onclick="skipField('address')">Skip</span>
                </label>
                <textarea id="address" placeholder="Your complete address"></textarea>
              </div>

              <div class="form-row">
                <!-- Optional: LinkedIn -->
                <div class="form-group" id="group-linkedin">
                  <label>
                    LinkedIn
                    <span class="field-skip" onclick="skipField('linkedin')">Skip</span>
                  </label>
                  <input type="url" id="linkedin" placeholder="https://linkedin.com/in/yourprofile">
                </div>
                <!-- Optional: Website -->
                <div class="form-group" id="group-website">
                  <label>
                    Portfolio
                    <span class="field-skip" onclick="skipField('website')">Skip</span>
                  </label>
                  <input type="url" id="website" placeholder="https://yourwebsite.com">
                </div>
              </div>
            </div>
          </div>

          <!-- Professional Summary -->
          <div class="form-section" id="section-summary">
            <h2 class="section-title">
              <i class="fas fa-user-tie section-icon"></i> Professional Summary
              <span class="skip-link" onclick="toggleSection('summary')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" rows="4" placeholder="Brief professional overview..."></textarea>
              </div>
            </div>
          </div>

          <!-- Work Experience -->
          <div class="form-section" id="section-experience">
            <h2 class="section-title">
              <i class="fas fa-briefcase section-icon"></i> Work Experience
              <span class="skip-link" onclick="toggleSection('experience')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="experienceContainer">
                <div class="experience-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="jobTitle1">Job Title</label>
                      <input type="text" id="jobTitle1" name="jobTitle[]" placeholder="Software Engineer">
                    </div>
                    <div class="form-group">
                      <label for="company1">Company</label>
                      <input type="text" id="company1" name="company[]" placeholder="Company Name">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="startDate1">Start Date</label>
                      <input type="month" id="startDate1" name="startDate[]">
                    </div>
                    <div class="form-group">
                      <label for="endDate1">End Date</label>
                      <input type="month" id="endDate1" name="endDate[]">
                    </div>
                  </div>
                  <div class="checkbox-container">
                    <label>
                      <input type="checkbox" id="current1"> Currently working here
                    </label>
                  </div>
                  <div class="form-group">
                    <label for="jobDescription1">Description</label>
                    <textarea id="jobDescription1" name="jobDescription[]" rows="4" placeholder="Key responsibilities..."></textarea>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addExperience()">Add Another Experience</button>
            </div>
          </div>

          <!-- Education -->
          <div class="form-section" id="section-education">
            <h2 class="section-title">
              <i class="fas fa-graduation-cap section-icon"></i> Education
              <span class="skip-link" onclick="toggleSection('education')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="educationContainer">
                <div class="education-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="degree1">Degree</label>
                      <input type="text" id="degree1" name="degree[]" placeholder="Bachelor of Science">
                    </div>
                    <div class="form-group">
                      <label for="school1">School</label>
                      <input type="text" id="school1" name="school[]" placeholder="University Name">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="gradYear1">Year</label>
                      <input type="number" id="gradYear1" name="gradYear[]" min="1950" max="2030" placeholder="2024">
                    </div>
                    <div class="form-group">
                      <label for="gpa1">GPA</label>
                      <input type="text" id="gpa1" name="gpa[]" placeholder="3.8/4.0">
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addEducation()">Add Another Education</button>
            </div>
          </div>
        </form>
      </div>

      <!-- RIGHT PANE -->
      <div class="right-pane">
        <div id="resumeFormPart2">
          <!-- Skills -->
          <div class="form-section" id="section-skills">
            <h2 class="section-title">
              <i class="fas fa-tools section-icon"></i> Skills
              <span class="skip-link" onclick="toggleSection('skills')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div class="form-group">
                <label for="technicalSkills">Technical Skills</label>
                <textarea id="technicalSkills" rows="3" placeholder="JavaScript, Python, React..."></textarea>
              </div>
              <div class="form-group">
                <label for="softSkills">Soft Skills</label>
                <textarea id="softSkills" rows="3" placeholder="Leadership, Communication..."></textarea>
              </div>
            </div>
          </div>

          <!-- Additional Info -->
            <h2 class="section-title">
              <i class="fas fa-plus-circle section-icon"></i> Additional Information
              <span class="skip-link" onclick="toggleSection('additional')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div class="form-group" id="group-certifications">
                <label>
                  Certifications
                  <span class="field-skip" onclick="skipField('certifications')">Skip</span>
                </label>
                <textarea id="certifications" rows="3" placeholder="AWS, Google Cloud..."></textarea>
              </div>
              <div class="form-group" id="group-languages">
                <label>
                  Languages
                  <span class="field-skip" onclick="skipField('languages')">Skip</span>
                </label>
                <textarea id="languages" rows="2" placeholder="English (Native)..."></textarea>
              </div>
              <div class="form-section" id="section-projects">
                <h2 class="section-title">
                  <i class="fas fa-code section-icon"></i> Projects
                  <span class="skip-link" onclick="toggleSection('projects')">Skip this section</span>
                </h2>
                <div class="form-content">
                  <div id="projectsContainer">
                    <div class="project-item">
                      <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
                      <div class="form-group">
                        <label>Project Name <span class="required">*</span></label>
                        <input type="text" name="projectName[]" placeholder="E-commerce Platform" required>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>Technologies Used</label>
                          <input type="text" name="projectTech[]" placeholder="React, Node.js, MongoDB">
                        </div>
                        <div class="form-group">
                          <label>Duration/Year</label>
                          <input type="text" name="projectDuration[]" placeholder="6 months or 2023">
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Project Description</label>
                        <textarea name="projectDescription[]" rows="4" placeholder="Describe what the project does, key features, and your role..."></textarea>
                      </div>
                      <div class="form-row">
                        <div class="form-group">
                          <label>GitHub/Deployment Link (Optional)</label>
                          <input type="url" name="projectLink[]" placeholder="https://github.com/username/project">
                        </div>
                        <div class="form-group">
                          <label>Key Achievement/Metrics (Optional)</label>
                          <input type="text" name="projectAchievement[]" placeholder="10K+ users, 40% performance improvement">
                        </div>
                      </div>
                    </div>
                  </div>
                  <button type="button" class="add-more-btn" onclick="addProject()">
                    <i class="fas fa-plus"></i> Add Another Project
                  </button>
                  <p style="color: #2ae023; font-size: 0.85rem; margin-top: 15px; opacity: 0.8;">
                    <i class="fas fa-lightbulb"></i> Tip: Include 2-4 key projects that showcase your skills. Focus on impact and technologies used.
                  </p>
                </div>
              </div>
              <div class="form-group" id="group-achievements">
                <label>
                  Achievements
                  <span class="field-skip" onclick="skipField('achievements')">Skip</span>
                </label>
                <textarea id="achievements" rows="3" placeholder="Awards, hackathons..."></textarea>
              </div>
              <div class="form-group" id="group-hobbies">
                <label>
                  Hobbies
                  <span class="field-skip" onclick="skipField('hobbies')">Skip</span>
                </label>
                <textarea id="hobbies" rows="2" placeholder="Photography, hiking..."></textarea>
              </div>
            </div>
          </div>

          <!-- References -->
          <div class="form-section" id="section-references">
            <h2 class="section-title">
              <i class="fas fa-users section-icon"></i> References
              <span class="skip-link" onclick="toggleSection('references')">Skip this section</span>
            </h2>
            <div class="form-content">
              <div id="referencesContainer">
                <div class="reference-item">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="refName1">Reference Name</label>
                      <input type="text" id="refName1" name="refName[]" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                      <label for="refTitle1">Title/Position</label>
                      <input type="text" id="refTitle1" name="refTitle[]" placeholder="Senior Manager">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="refCompany1">Company</label>
                      <input type="text" id="refCompany1" name="refCompany[]" placeholder="Company Name">
                    </div>
                    <div class="form-group">
                      <label for="refPhone1">Phone</label>
                      <input type="tel" id="refPhone1" name="refPhone[]" placeholder="(555) 123-4567"
                             pattern="[\+]?[\d\s\-\(\)\.]+"
                             title="Please enter a valid phone number">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="refEmail1">Email</label>
                    <input type="email" id="refEmail1" name="refEmail[]" placeholder="reference@company.com"
                           title="Please enter a valid email address">
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addReference()">Add Another Reference</button>
            </div>
          </div>

          <!-- Custom Details -->
          <div class="form-section" id="section-custom">
            <h2 class="section-title">
              <i class="fas fa-edit section-icon"></i> Custom Details
              <span class="skip-link" onclick="toggleSection('custom')">Skip this section</span>
            </h2>
            <div class="form-content">
              <p style="color: #2ae023; font-size: 14px; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> Add any additional sections you need (e.g., Publications, Volunteer Work, Awards, etc.)
              </p>
              <div id="customDetailsContainer">
                <div class="custom-detail-item">
                  <div class="form-group">
                    <label for="customHeading1">Section Heading</label>
                    <input type="text" id="customHeading1" name="customHeading[]" placeholder="e.g., Publications, Volunteer Work, Awards">
                  </div>
                  <div class="form-group">
                    <label for="customContent1">Content</label>
                    <textarea id="customContent1" name="customContent[]" rows="4" placeholder="Describe the details for this section..."></textarea>
                  </div>
                </div>
              </div>
              <button type="button" class="add-more-btn" onclick="addCustomDetail()">Add Another Custom Section</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Buttons -->
    <div class="bottom-actions">
      <button type="button" class="btn" style="background: #ffa500; color: white;" onclick="fillSampleData()">
        <i class="fas fa-magic"></i> Fill Sample Data
      </button>
      <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
      <button type="button" class="btn btn-primary" onclick="generateResume()">Generate Resume</button>
    </div>

    <!-- Results -->
    <div id="resultsSection" style="display:none; margin-top:40px; text-align:center;">
      <h2 style="color:#2ae023; font-size:2.2rem; margin-bottom:20px;">Your Resume is Ready!</h2>
      <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin-top:30px;">
        <button class="btn btn-secondary" onclick="editResume()">Edit Details</button>
        <button class="btn btn-primary" onclick="downloadResume()">Download PDF</button>
        <button class="btn btn-primary" onclick="previewResume()">Preview</button>
      </div>
    </div>
  </div>

  <script>
    // Version: 2024-11-26-v3 - Modal close fix + getTemplateName defined at line 1681
    // Last updated: 2024-11-26 17:30
    // Global state
    let selectedTemplate = null;

    // ========== BACKEND CONFIGURATION ==========
    // Using Render deployed backend for production access
    
    const BACKEND_URL = "https://hiero-resume-backend.onrender.com";
    
    console.log('ðŸŒ Backend URL:', BACKEND_URL);
    console.log('ðŸ”§ Mode: Using Render production backend');

    // Add quick backend health ping (non-blocking, silent failure)
    // Only run if page is loaded via http/https (not file://)
    (async () => {
      // Skip health check if opened via file:// protocol (CORS will fail)
      if (window.location.protocol === 'file:') {
        console.log('â„¹ï¸ Skipping health check (file:// protocol)');
        return;
      }
      
      try {
        const backendUrl = BACKEND_URL;
        console.log('ðŸ” Checking backend health at:', backendUrl + '/health');
        
        const r = await fetch(backendUrl + '/health', { 
          cache: 'no-store',
          method: 'GET',
          mode: 'cors',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (r.ok) { 
          const data = await r.json();
          console.log('âœ… Backend health check passed:', backendUrl, data);
        } else { 
          console.warn('âš ï¸ Health endpoint returned:', r.status, 'for', backendUrl);
        }
      } catch (e) { 
        // Silent failure - don't show error if backend is not accessible yet
        // This is just a health check, not critical for functionality
        // Common reasons: CORS, network error, server not running
        console.debug('â„¹ï¸ Backend health check skipped (non-critical):', e.message);
      }
    })();

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear authentication
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        
        // Clear any resume builder data
        localStorage.removeItem('selectedTemplate');
        
        // Redirect to login
        window.location.href = '/dashboard/login.html';
      }
    }

    // Check authentication on page load
    function checkAuthentication() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');
      
      if (!token || !user) {
        // Not logged in - redirect to login
        alert('Please login to access the resume builder');
        window.location.href = '/dashboard/login.html';
        return false;
      }
      return true;
    }

    // Initialize page - always start at Step 1 (template selection)
    function initializePage() {
      // Always show template selection first
      document.getElementById('templateSelection').style.display = 'block';
      document.getElementById('formStepIndicator').style.display = 'none';
      document.querySelector('.main-layout').style.display = 'none';
      document.querySelector('.bottom-actions').style.display = 'none';
      
      // Remove the back button if it exists
      const existingBackBtn = document.getElementById('backToTemplatesBtn');
      if (existingBackBtn) {
        existingBackBtn.remove();
      }
      
      // Clear any previous template selection when returning to Step 1
      // (User can select a different template)
      selectedTemplate = null;
      
      console.log('Page initialized - showing Step 1 (template selection)');
      
      // Ensure history state is set to Step 1
      if (history.state === null || history.state.step !== 1) {
        history.replaceState({ step: 1 }, '', '');
      }
    }

    // Template selection functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in
      if (!checkAuthentication()) {
        return; // Stop execution if not authenticated
      }
      
      // Initialize page to Step 1
      initializePage();
      
      // ==================== BROWSER BACK BUTTON HANDLING ====================
      // Push initial state to prevent direct back to index.html
      history.pushState({ step: 1 }, '', '');
      
      // Handle browser back/forward button
      window.addEventListener('popstate', function(event) {
        // Prevent going back to index.html
        event.preventDefault();
        
        // Check which step we're currently on
        const formVisible = document.querySelector('.main-layout').style.display !== 'none';
        const templateVisible = document.getElementById('templateSelection').style.display !== 'none';
        
        if (formVisible) {
          // User is on Step 2 (form), go back to Step 1 (template selection)
          console.log('Browser back button pressed - returning to Step 1');
          initializePage();
          
          // Push state again to maintain control
          history.pushState({ step: 1 }, '', '');
        } else {
          // User is on Step 1, prevent going back to index.html
          console.log('Already on Step 1 - preventing further back navigation');
          
          // Ask user for confirmation before leaving
          const confirmLeave = confirm('Do you want to leave the resume builder? Your progress will be saved.');
          if (confirmLeave) {
            // Clear localStorage if needed and redirect to dashboard/index
            window.location.href = 'index.html';
          } else {
            // Stay on current page
            history.pushState({ step: 1 }, '', '');
          }
        }
      });
      
      // Prevent accidental back navigation from touch gestures (mobile/trackpad)
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      
      document.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });
      
      document.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleGesture();
      }, { passive: true });
      
      function handleGesture() {
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;
        
        // Detect horizontal swipe (typical back gesture)
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
          // Right swipe detected (potential back gesture)
          if (diffX > 0) {
            // Check if we should allow this
            const formVisible = document.querySelector('.main-layout').style.display !== 'none';
            if (formVisible) {
              // On Step 2, swipe should go to Step 1
              console.log('Swipe detected on Step 2 - returning to Step 1');
              initializePage();
              history.pushState({ step: 1 }, '', '');
            }
          }
        }
      }
      
      // Prevent mouse-based back navigation (two-finger swipe on trackpad)
      let gestureStarted = false;
      
      document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
        gestureStarted = true;
      });
      
      document.addEventListener('gesturechange', function(e) {
        if (gestureStarted) {
          e.preventDefault();
        }
      });
      
      document.addEventListener('gestureend', function(e) {
        e.preventDefault();
        gestureStarted = false;
      });
      
      // ==================== END BACK BUTTON HANDLING ====================
      
      // Category filtering
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Update active category
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          // Filter templates
          const category = this.dataset.category;
          const cards = document.querySelectorAll('.template-card');
          
          cards.forEach(card => {
            if (category === 'all' || card.dataset.category === category) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        });
      });

      // Load saved skip states
      ['summary','experience','education','skills','projects','additional','references','custom'].forEach(sec => {
        if (localStorage.getItem('skip_section_' + sec) === 'true') {
          const el = document.getElementById('section-' + sec);
          const link = el?.querySelector('.skip-link');
          if (el && link) {
            el.classList.add('skipped');
            link.textContent = 'Show section';
          }
        }
      });
      
      ['address','linkedin','website','certifications','languages','projects','achievements','hobbies'].forEach(field => {
        if (localStorage.getItem('skip_field_' + field) === 'true') {
          const group = document.getElementById('group-' + field);
          const input = document.getElementById(field);
          const label = group?.querySelector('label');
          const skipSpan = label?.querySelector('.field-skip');
          
          if (group && input && skipSpan) {
            group.classList.add('skipped');
            skipSpan.textContent = 'Show';
            // Note: Field value will be restored when user clicks "Show" using the improved skipField function
          }
        } else {
          // Restore field value if not skipped
          const input = document.getElementById(field);
          const savedValue = localStorage.getItem('field_value_' + field);
          if (input && savedValue !== null) {
            input.value = savedValue;
          }
        }
      });
    });

    // Template preview functionality with fallback static preview
    async function previewTemplate(templateId) {
      // Template metadata
      const templateDetails = {
        'classic': {
          name: 'Classic Professional',
          description: 'Clean, traditional layout perfect for any industry',
          style: 'Traditional serif fonts, centered header, clean sections'
        },
        'minimal': {
          name: 'Minimal',
          description: 'Ultra-clean design with excellent readability',
          style: 'Minimalist design, sans-serif fonts, lots of whitespace'
        },
        'modern-pro': {
          name: 'Modern Professional',
          description: 'Contemporary design with subtle colors',
          style: 'Modern layout, accent colors, professional styling'
        },
        'tech-focus': {
          name: 'Tech Focus',
          description: 'Designed specifically for developers',
          style: 'Code-friendly layout, technical sections, modern fonts'
        },
        'creative-bold': {
          name: 'Creative Bold',
          description: 'Eye-catching design for creative professionals',
          style: 'Bold typography, creative layout, vibrant colors'
        },
        'portfolio-style': {
          name: 'Portfolio Style',
          description: 'Showcase your work with visual elements',
          style: 'Visual-first design, project showcase, modern layout'
        },
        'ats-optimized': {
          name: 'ATS Optimized',
          description: 'Designed to pass Applicant Tracking Systems',
          style: 'Simple structure, ATS-friendly format, clear sections'
        },
        'corporate-ats': {
          name: 'Corporate ATS',
          description: 'Professional corporate design that\'s ATS-compatible',
          style: 'Corporate styling, ATS-compatible, professional look'
        },
        'elegant-gradient': {
          name: 'Elegant Gradient',
          description: 'Beautiful gradient design with elegant typography',
          style: 'Gradient accents, elegant fonts, sophisticated design'
        },
        'minimalist-mono': {
          name: 'Minimalist Mono',
          description: 'Ultra-minimalist monochrome design',
          style: 'Black and white, minimal elements, clean typography'
        },
        'rishi': {
          name: 'Rishi Tech Modern',
          description: 'Modern tech layout with purple gradient sidebar',
          style: 'Two-column design, purple gradient, blue accents, Inter font'
        },
        'priya': {
          name: 'Priya Elegant',
          description: 'Classic serif design with elegant typography and traditional layout',
          style: 'Georgia serif fonts, centered header, elegant spacing, academic style'
        },
        'priya-analytics': {
          name: 'Priya Analytics',
          description: 'Single-column layout with a grey top bar and bold section headings. Ideal for data-driven professionals.',
          style: 'Single-column, grey top bar, bold section headings with horizontal rules, matching the Priya Sharma data analyst resume style'
        }
      };

      const template = templateDetails[templateId];
      if (!template) return;

      // Create modal with loading state
      const modal = document.createElement('div');
      modal.className = 'preview-modal-overlay';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: rgba(0,0,0,0.85); display: flex; align-items: center; 
        justify-content: center; z-index: 10000; padding: 20px;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; max-width: 900px; width: 100%; 
                    max-height: 90vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
          <div style="padding: 25px 30px; border-bottom: 1px solid #eee; flex-shrink: 0;">
            <button onclick="this.closest('.preview-modal-overlay').remove()" 
                    style="position: absolute; top: 15px; right: 15px; background: none; 
                           border: none; font-size: 28px; cursor: pointer; color: #999; line-height: 1; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;"
                    onmouseover="this.style.background='#f0f0f0'; this.style.color='#333';"
                    onmouseout="this.style.background='none'; this.style.color='#999';">Ã—</button>
            <h2 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 24px;">${template.name}</h2>
            <p style="margin: 0; color: #7f8c8d; font-size: 14px;">${template.description}</p>
          </div>
          <div id="preview-content" style="flex: 1; overflow-y: auto; padding: 30px; display: flex; justify-content: center; align-items: flex-start; background: #f8f9fa; min-height: 400px;">
            <div style="text-align: center; color: #666; padding: 60px 20px;">
              <i class="fas fa-spinner fa-spin" style="font-size: 42px; margin-bottom: 15px; color: #2ae023;"></i>
              <p style="font-size: 16px; margin: 0;">Loading preview...</p>
            </div>
          </div>
          <div style="padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #e0e0e0; flex-shrink: 0;">
            <button onclick="startBuilding('${templateId}'); this.closest('.preview-modal-overlay').remove();" 
                    style="background: #2ae023; color: white; border: none; padding: 14px 28px; 
                           border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; font-size: 16px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(42,224,35,0.3);"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(42,224,35,0.4)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(42,224,35,0.3)';">
              Use This Template
            </button>
          </div>
        </div>
      `;

      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.remove();
      });

      document.body.appendChild(modal);

      // Try to fetch preview from backend, with fallback to static preview
      let previewLoaded = false;
      
      try {
        console.log('ðŸ” Fetching preview for template:', templateId);
        
        // Sample data tailored for different templates
        let sampleData = {
          template: templateId,
          personalInfo: {
            fullName: 'John Doe',
            email: 'john.doe@example.com',
            phone: '(555) 123-4567'
          },
          address: 'San Francisco, CA',
          linkedin: 'linkedin.com/in/johndoe',
          summary: 'Results-driven professional with 5+ years of experience in software development and team leadership. Proven track record of delivering scalable solutions and improving system performance.',
          experience: [
            {
              jobTitle: 'Senior Software Engineer',
              company: 'Tech Innovations Inc.',
              startDate: '2022-01',
              endDate: 'Present',
              description: 'â€¢ Led development of microservices architecture serving 1M+ users\nâ€¢ Improved system performance by 40% through optimization\nâ€¢ Mentored team of 5 junior developers'
            },
            {
              jobTitle: 'Software Engineer',
              company: 'StartupXYZ',
              startDate: '2020-06',
              endDate: '2021-12',
              description: 'â€¢ Developed full-stack web applications using React and Node.js\nâ€¢ Implemented RESTful APIs and database optimization\nâ€¢ Collaborated with cross-functional teams in Agile environment'
            }
          ],
          education: [
            {
              degree: 'Bachelor of Science in Computer Science',
              school: 'University of Technology',
              gradYear: '2020',
              gpa: '3.8/4.0'
            }
          ],
          technicalSkills: 'JavaScript, React, Node.js, Python, AWS, Docker, MongoDB, PostgreSQL, Git, CI/CD (Jenkins, GitHub Actions), RESTful APIs, GraphQL, Microservices Architecture',
          softSkills: 'Leadership, Communication, Problem-solving, Team collaboration, Project management',
          projects: 'E-commerce Platform: Built full-stack application with 10K+ users\nTask Management App: Developed mobile-responsive SaaS product',
          certifications: 'AWS Certified Solutions Architect, Google Cloud Professional'
        };

        // Customize sample data for Priya template (elegant academic style)
        if (templateId === 'priya') {
          sampleData = {
            template: 'priya',
            personalInfo: {
              fullName: 'Priya Sharma',
              rollNo: '191401001',
              program: 'Computer Science',
              course: 'B.Tech',
              institute: 'Indian Institute of Information Technology, Vadodara',
              phone: '+91-9876543210',
              email: 'priya.sharma@iitvadodara.ac.in',
              officialEmail: '191401001@iitvadodara.ac.in',
              github: 'github.com/priyasharma',
              linkedin: 'linkedin.com/in/priyasharma',
              languages: 'C, C++, Python, Java, JavaScript',
              developerTools: 'Git, VS Code, IntelliJ IDEA, Eclipse',
              frameworks: 'React, Node.js, Django, Spring Boot',
              cloudDatabases: 'AWS, Firebase, MySQL, MongoDB',
              softSkills: 'Communication, Leadership, Problem-solving, Teamwork'
            },
            education: [
              {
                institute: 'Indian Institute of Information Technology, Vadodara',
                degree: 'B.Tech in Computer Science',
                details: 'CGPA: 8.5/10.0',
                dates: '2019 - 2023'
              },
              {
                institute: 'Delhi Public School',
                degree: 'All India Senior School Certificate Examination',
                details: 'Percentage: 92%',
                dates: '2019'
              },
              {
                institute: 'Delhi Public School',
                degree: 'All India Secondary School Examination',
                details: 'Percentage: 94%',
                dates: '2017'
              }
            ],
            experience: [
              {
                company: 'TechCorp Solutions',
                role: 'Full Stack Developer Intern',
                location: 'Bangalore',
                dates: 'May 2022 - July 2022',
                points: ['Developed responsive web applications using React and Node.js', 'Optimized database queries improving performance by 30%', 'Collaborated with team to deliver client requirements']
              }
            ],
            projects: [
              {
                title: 'AI-Powered Study Assistant',
                description: 'Developed a machine learning based study assistant',
                technologies: 'Python, TensorFlow, React, MongoDB',
                dates: '2022-2023'
              },
              {
                title: 'E-Commerce Platform',
                description: 'Built a full-stack e-commerce solution',
                technologies: 'React, Node.js, Express, MongoDB',
                dates: '2021-2022'
              }
            ],
            achievements: [
              'Winner of Inter-College Hackathon 2022',
              'Published research paper on AI in peer-reviewed journal',
              'Awarded Best Project in Software Engineering course'
            ],
            extracurricular: [
              'President of Coding Club',
              'Volunteer at Local Tech Community Center',
              'Active participant in competitive programming'
            ],
            traits: [
              'Self-motivated and eager to learn new technologies',
              'Strong problem-solving and analytical skills',
              'Excellent collaboration and communication abilities'
            ]
          };
        }

        // Add timeout to fetch request (increased for ngrok)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
          console.warn('â±ï¸ Preview request timeout after 90 seconds');
        }, 90000); // 90 seconds for ngrok

        console.log('ðŸ“¡ Fetching preview from:', `${BACKEND_URL}/preview-resume`);
        const response = await fetch(`${BACKEND_URL}/preview-resume`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'text/html'
          },
          body: JSON.stringify(sampleData),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const previewHTML = await response.text();
        
        console.log('âœ… Preview loaded successfully for template:', templateId);
        console.log('HTML length:', previewHTML.length);
        console.log('HTML preview (first 200 chars):', previewHTML.substring(0, 200));
        
        // Safety check
        if (!previewHTML || previewHTML.trim().length < 100) {
          throw new Error('No valid HTML received from backend');
        }
        
        // Update preview content with iframe for better isolation
        const previewContent = modal.querySelector('#preview-content');
        
        // Create iframe container
        const container = document.createElement('div');
        container.style.cssText = 'width: 100%; max-width: 700px; background: white; box-shadow: 0 2px 20px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;';
        
        // Create iframe element
        const iframe = document.createElement('iframe');
        iframe.style.cssText = 'width: 100%; height: 800px; border: none; display: block; background: white;';
        iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts');
        
        // Clear preview content and append container
        previewContent.innerHTML = '';
        container.appendChild(iframe);
        previewContent.appendChild(container);
        
        // Wait for iframe to be ready, then write content
        setTimeout(() => {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(previewHTML);
            iframeDoc.close();
            console.log('âœ… Template preview rendered in iframe for:', templateId);
          } catch (writeError) {
            console.error('Error writing to iframe:', writeError);
            // Fallback: use srcdoc
            iframe.srcdoc = previewHTML;
            console.log('âœ… Using srcdoc fallback for:', templateId);
          }
        }, 100);
        
        previewLoaded = true;
        
      } catch (error) {
        console.error('âŒ Error fetching preview:', error, 'URL:', BACKEND_URL + '/preview-resume');
        
        const previewContent = modal.querySelector('#preview-content');
        
        // Check error type
        const isTimeout = error.name === 'AbortError';
        const isNetworkError = isTimeout || error.message.includes('fetch') || error.message.includes('Failed to fetch');
        
        // Show fallback static preview
        previewContent.innerHTML = `
          <div style="width: 100%; max-width: 700px; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 20px rgba(0,0,0,0.1);">
            <div style="text-align: center; margin-bottom: 30px;">
              <div style="display: inline-block; padding: 12px 24px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                <p style="margin: 0; color: #856404; font-size: 14px; font-weight: 500;">
                  <i class="fas fa-info-circle"></i> ${isTimeout ? 'Request timed out - server took too long to respond' : isNetworkError ? 'Backend server not responding' : 'Preview temporarily unavailable'}
                </p>
              </div>
              <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 22px;">${template.name}</h3>
              <p style="margin: 0 0 20px 0; color: #7f8c8d; font-size: 14px;">${template.style}</p>
            </div>
            
            <div style="border: 2px dashed #e0e0e0; border-radius: 8px; padding: 30px; background: #fafafa;">
              <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2ae023;">
                <h1 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 28px;">Your Name Here</h1>
                <p style="margin: 0; color: #7f8c8d; font-size: 14px;">email@example.com | (555) 123-4567 | Location</p>
              </div>
              
              <div style="margin-bottom: 20px;">
                <h2 style="margin: 0 0 10px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Professional Summary</h2>
                <p style="margin: 0; color: #555; line-height: 1.6; font-size: 14px;">
                  Your professional summary will appear here with your key qualifications, years of experience, and main areas of expertise.
                </p>
              </div>
              
              <div style="margin-bottom: 20px;">
                <h2 style="margin: 0 0 15px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Work Experience</h2>
                <div style="margin-bottom: 15px;">
                  <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">Job Title</h3>
                  <p style="margin: 0 0 5px 0; color: #7f8c8d; font-size: 14px;">Company Name | 2020 - Present</p>
                  <p style="margin: 0; color: #555; font-size: 14px; line-height: 1.5;">
                    â€¢ Your key responsibilities and achievements<br>
                    â€¢ Measurable results and impacts<br>
                    â€¢ Technologies and skills used
                  </p>
                </div>
              </div>
              
              <div style="margin-bottom: 20px;">
                <h2 style="margin: 0 0 15px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Education</h2>
                <div>
                  <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">Degree Name</h3>
                  <p style="margin: 0; color: #7f8c8d; font-size: 14px;">University Name | Graduation Year</p>
                </div>
              </div>
              
              <div>
              <div style="margin-bottom: 20px;">
                <h2 style="margin: 0 0 15px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Work Experience</h2>
                <div style="margin-bottom: 15px;">
                  <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">Job Title</h3>
                  <p style="margin: 0 0 5px 0; color: #7f8c8d; font-size: 14px;">Company Name | 2020 - Present</p>
                  <p style="margin: 0; color: #555; font-size: 14px; line-height: 1.5;">
                    â€¢ Your key responsibilities and achievements<br>
                    â€¢ Measurable results and impacts<br>
                    â€¢ Technologies and skills used
                  </p>
                </div>
              </div>
              
              <div style="margin-bottom: 20px;">
                <h2 style="margin: 0 0 15px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Education</h2>
                <div>
                  <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">Degree Name</h3>
                  <p style="margin: 0; color: #7f8c8d; font-size: 14px;">University Name | Graduation Year</p>
                </div>
              </div>
              
              <div>
                <h2 style="margin: 0 0 10px 0; color: #2ae023; font-size: 18px; text-transform: uppercase; letter-spacing: 1px;">Skills</h2>
                <p style="margin: 0; color: #555; font-size: 14px; line-height: 1.6;">
                  Your technical and soft skills will be displayed here in a clean, organized format.
                </p>
              </div>
            </div>
            
            ${isNetworkError ? `
            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #2ae023;">
              <p style="margin: 0 0 8px 0; color: #2c5e2e; font-size: 13px; font-weight: 600;">
                ðŸ’¡ To see the actual template preview:
              </p>
              <p style="margin: 0; color: #2c5e2e; font-size: 12px; line-height: 1.5;">
                Make sure the backend server is running. You can still select this template to continue building your resume.
              </p>
            </div>
            ` : ''}
          </div>
        `;
      }
    }

    // Note: Template preview is now fetched from backend via /preview-resume API
    // The previewTemplate() function above handles fetching and rendering

    // Start building with selected template
    function startBuilding(templateId) {
      selectedTemplate = templateId;
      
      // Save selected template to localStorage (for PDF generation)
      localStorage.setItem('selectedTemplate', templateId);
      
      console.log('âœ… Template selected:', templateId);
      
      // Show import resume modal first
      showImportResumeModal();
    }
    
    // Helper function to get template display name
    function getTemplateName(templateId) {
      const names = {
        'classic': 'Classic Professional',
        'minimal': 'Minimal',
        'modern-pro': 'Modern Professional',
        'tech-focus': 'Tech Focus',
        'creative-bold': 'Creative Bold',
        'portfolio-style': 'Portfolio Style',
        'ats-optimized': 'ATS Optimized',
        'corporate-ats': 'Corporate ATS',
        'elegant-gradient': 'Elegant Gradient',
        'minimalist-mono': 'Minimalist Mono',
        'rishi': 'Rishi Tech Modern',
        'priya': 'Priya Elegant',
        'priya-analytics': 'Priya Analytics (Single Column)'
      };
      return names[templateId] || 'Selected';
    }
    
    // Show modal asking if user has an old resume
    function showImportResumeModal() {
      const modal = document.createElement('div');
      modal.id = 'importResumeModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      `;
      
      modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(42,224,35,0.3);">
          <h2 style="margin: 0 0 20px 0; color: #2ae023; font-size: 24px; text-align: center;">
            <i class="fas fa-file-upload"></i> Do you have an old resume?
          </h2>
          <p style="color: #bbb; text-align: center; margin-bottom: 30px; line-height: 1.6;">
            Upload your existing resume and we'll auto-fill the form for you!<br>
            <span style="font-size: 14px; color: #888;">Supports PDF, DOCX, and images</span>
          </p>
          
          <div style="display: flex; gap: 15px; flex-direction: column;">
            <label for="resumeFileInput" style="background: linear-gradient(135deg, #2ae023 0%, #06a529 100%); color: #fff; padding: 18px; border-radius: 12px; cursor: pointer; text-align: center; font-weight: 600; transition: all 0.3s ease; border: none; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
              <i class="fas fa-upload"></i> Yes, Upload My Resume
            </label>
            <input type="file" id="resumeFileInput" accept=".pdf,.doc,.docx,image/*" style="display: none;">
            
            <button id="proceedWithoutImportBtn" style="background: rgba(255,255,255,0.1); color: #fff; padding: 18px; border-radius: 12px; cursor: pointer; border: 2px solid rgba(255,255,255,0.2); font-weight: 600; transition: all 0.3s ease; font-size: 16px;">
              <i class="fas fa-edit"></i> No, I'll Fill It Manually
            </button>
          </div>
          
          <div id="uploadStatus" style="margin-top: 20px; padding: 15px; border-radius: 10px; display: none; text-align: center;"></div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal when clicking the backdrop (outside the content box)
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          console.log('ðŸ”µ Backdrop clicked, closing modal...');
          closeImportModal();
        }
      });
      
      // Handle "No, I'll Fill It Manually" button click
      document.getElementById('proceedWithoutImportBtn').addEventListener('click', function(e) {
        console.log('ðŸŸ¢ "No, I\'ll Fill It Manually" button clicked');
        e.preventDefault();
        e.stopPropagation();
        proceedToFormWithoutImport();
      });
      
      // Handle ESC key to close modal
      const escHandler = function(e) {
        if (e.key === 'Escape') {
          console.log('ðŸ”µ ESC pressed, closing modal...');
          closeImportModal();
          document.removeEventListener('keydown', escHandler);
        }
      };
      document.addEventListener('keydown', escHandler);
      
      // Handle file upload
      document.getElementById('resumeFileInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'rgba(42,224,35,0.1)';
        statusDiv.style.color = '#2ae023';
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing your resume...';
        
        try {
          const formData = new FormData();
          formData.append('resume', file);
          
          const response = await fetch('https://hiero-resume-backend.onrender.com/api/resume/import', {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Upload failed');
          }
          
          const result = await response.json();
          
          if (result.success && result.data) {
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Resume imported successfully!';
            
            // Store the imported data temporarily
            localStorage.setItem('importedResumeData', JSON.stringify(result.data));
            
            // Close modal and show form after a short delay
            setTimeout(() => {
              closeImportModal();
              proceedToForm();
              
              // Fill form after a short delay to ensure form fields are created
              setTimeout(() => {
                const importedData = JSON.parse(localStorage.getItem('importedResumeData'));
                if (importedData) {
                  fillFormWithImportedData(importedData);
                  localStorage.removeItem('importedResumeData');
                }
              }, 500);
            }, 1000);
          } else {
            throw new Error('Invalid response from server');
          }
        } catch (error) {
          console.error('Import error:', error);
          statusDiv.style.background = 'rgba(239,68,68,0.1)';
          statusDiv.style.color = '#ef4444';
          
          // Show detailed error message with helpful tips
          let errorMessage = error.message;
          
          // Check if it's a text extraction error
          if (errorMessage.includes('Unable to extract text') || errorMessage.includes('Could not extract text')) {
            statusDiv.innerHTML = `
              <div style="text-align: left;">
                <div style="margin-bottom: 10px;">
                  <i class="fas fa-exclamation-circle"></i> <strong>Cannot read this resume file</strong>
                </div>
                <div style="font-size: 13px; line-height: 1.5; margin-bottom: 15px;">
                  This resume may be:
                  <ul style="margin: 5px 0 0 20px; padding: 0;">
                    <li>A scanned image PDF (no selectable text)</li>
                    <li>Password-protected or corrupted</li>
                    <li>In an unsupported format</li>
                  </ul>
                </div>
                <button onclick="proceedToFormWithoutImport()" style="
                  background: linear-gradient(135deg, #2ae023 0%, #1a8b17 100%);
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-weight: 600;
                  width: 100%;
                  font-size: 14px;
                ">
                  <i class="fas fa-edit"></i> Fill Form Manually Instead
                </button>
              </div>
            `;
          } else {
            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMessage}`;
          }
        }
      });
    }
    
    // Close import modal
    function closeImportModal() {
      console.log('ðŸ”µ Attempting to close import modal...');
      const modal = document.getElementById('importResumeModal');
      if (modal) {
        console.log('âœ… Modal found, removing...');
        modal.remove();
        console.log('âœ… Modal removed successfully');
      } else {
        console.warn('âš ï¸ Modal not found with id "importResumeModal"');
      }
    }
    
    // Proceed to form without importing
    function proceedToFormWithoutImport() {
      console.log('ðŸ”µ proceedToFormWithoutImport called');
      try {
        closeImportModal();
        console.log('ðŸ”µ Modal closed, proceeding to form...');
        proceedToForm();
      } catch (error) {
        console.error('âŒ Error in proceedToFormWithoutImport:', error);
        alert('Error: ' + error.message);
      }
    }
    
    // Show the form (Step 2)
    function proceedToForm() {
      console.log('ðŸ”µ Moving from Step 1 â†’ Step 2');
      console.log('ðŸ”µ Selected template:', selectedTemplate);
      
      try {
        // Check if template is selected
        if (!selectedTemplate) {
          console.error('âŒ No template selected!');
          alert('Please select a template first');
          return;
        }
        
        // Hide template selection (Step 1)
        const templateSelection = document.getElementById('templateSelection');
        if (templateSelection) {
          templateSelection.style.display = 'none';
          console.log('âœ… Template selection hidden');
        } else {
          console.error('âŒ templateSelection element not found');
        }
        
        // Show form step indicator and form (Step 2)
        const formStepIndicator = document.getElementById('formStepIndicator');
        if (formStepIndicator) {
          formStepIndicator.style.display = 'block';
          console.log('âœ… Form step indicator shown');
        } else {
          console.error('âŒ formStepIndicator element not found');
        }
        
        const mainLayout = document.querySelector('.main-layout');
        if (mainLayout) {
          mainLayout.style.display = 'grid';
          console.log('âœ… Main layout shown');
        } else {
          console.error('âŒ main-layout element not found');
        }
        
        const bottomActions = document.querySelector('.bottom-actions');
        if (bottomActions) {
          bottomActions.style.display = 'flex';
          console.log('âœ… Bottom actions shown');
        } else {
          console.error('âŒ bottom-actions element not found');
        }
        
        // Update step indicator with template info
        const templateName = getTemplateName(selectedTemplate);
        console.log('âœ… Template name:', templateName);
        
        const stepText = document.querySelector('#formStepIndicator .step-text');
        if (stepText) {
          stepText.textContent = `Step 2: Fill Your Information (Using ${templateName} template)`;
          console.log('âœ… Step text updated');
        } else {
          console.error('âŒ step-text element not found');
        }
        
        // Add a back button to return to Step 1
        addBackToTemplatesButton();
        console.log('âœ… Back button added');
        
        // Push history state for Step 2 (enables proper back button behavior)
        history.pushState({ step: 2, template: selectedTemplate }, '', '');
        console.log('âœ… History state pushed');
        
        // Scroll to form
        setTimeout(() => {
          const mainLayoutScroll = document.querySelector('.main-layout');
          if (mainLayoutScroll) {
            mainLayoutScroll.scrollIntoView({ behavior: 'smooth' });
            console.log('âœ… Scrolled to form');
          }
        }, 100);
        
        console.log('âœ…âœ…âœ… proceedToForm completed successfully!');
        
      } catch (error) {
        console.error('âŒ Error in proceedToForm:', error);
        alert('Error proceeding to form: ' + error.message);
      }
    }
    
    // Fill form with imported resume data
    function fillFormWithImportedData(data) {
      console.log('ðŸ“ Auto-filling form with imported data:', data);
      
      try {
        // Personal Info
        if (data.personalInfo) {
          const pi = data.personalInfo;
          const setFieldValue = (id, value) => {
            const field = document.getElementById(id);
            if (field && value) field.value = value;
          };
          
          setFieldValue('fullName', pi.fullName);
          setFieldValue('email', pi.email);
          setFieldValue('phone', pi.phone);
          setFieldValue('address', pi.address);
          setFieldValue('linkedin', pi.linkedin);
          setFieldValue('github', pi.github);
        }
        
        // Skills (convert array to comma-separated string)
        if (data.skills && Array.isArray(data.skills) && data.skills.length > 0) {
          const skillsField = document.getElementById('skills') || document.getElementById('technicalSkills');
          if (skillsField) {
            skillsField.value = data.skills.join(', ');
          }
        }
        
        // Experience
        if (data.experience && Array.isArray(data.experience)) {
          data.experience.forEach((exp, index) => {
            if (index > 0) addExperience();
            const containers = document.querySelectorAll('.experience-item');
            const container = containers[index];
            if (container) {
              const jobTitleField = container.querySelector('input[name="jobTitle[]"]');
              const companyField = container.querySelector('input[name="company[]"]');
              const locationField = container.querySelector('input[name="jobLocation[]"]');
              const startDateField = container.querySelector('input[name="jobStartDate[]"]');
              const endDateField = container.querySelector('input[name="jobEndDate[]"]');
              const descriptionField = container.querySelector('textarea[name="jobDescription[]"]');
              
              if (jobTitleField && exp.jobTitle) jobTitleField.value = exp.jobTitle;
              if (companyField && exp.company) companyField.value = exp.company;
              if (locationField && exp.location) locationField.value = exp.location;
              if (startDateField && exp.startDate) startDateField.value = exp.startDate;
              if (endDateField && exp.endDate) endDateField.value = exp.endDate;
              if (descriptionField && exp.description) descriptionField.value = exp.description;
            }
          });
        }
        
        // Education
        if (data.education && Array.isArray(data.education)) {
          data.education.forEach((edu, index) => {
            if (index > 0) addEducation();
            const containers = document.querySelectorAll('.education-item');
            const container = containers[index];
            if (container) {
              const degreeField = container.querySelector('input[name="degree[]"]');
              const institutionField = container.querySelector('input[name="institution[]"]');
              const locationField = container.querySelector('input[name="eduLocation[]"]');
              const startDateField = container.querySelector('input[name="eduStartDate[]"]');
              const endDateField = container.querySelector('input[name="eduEndDate[]"]');
              const gradeField = container.querySelector('input[name="grade[]"]');
              
              if (degreeField && edu.degree) degreeField.value = edu.degree;
              if (institutionField && edu.institution) institutionField.value = edu.institution;
              if (locationField && edu.location) locationField.value = edu.location;
              if (startDateField && edu.startDate) startDateField.value = edu.startDate;
              if (endDateField && edu.endDate) endDateField.value = edu.endDate;
              if (gradeField && edu.grade) gradeField.value = edu.grade;
            }
          });
        }
        
        // Projects
        if (data.projects && Array.isArray(data.projects)) {
          // First, un-skip projects section if it's skipped
          const projectsSection = document.getElementById('section-projects');
          if (projectsSection && projectsSection.classList.contains('skipped')) {
            toggleSection('projects');
          }
          
          setTimeout(() => {
            data.projects.forEach((proj, index) => {
              if (index > 0) addProject();
              const containers = document.querySelectorAll('.project-item');
              const container = containers[index];
              if (container) {
                const titleField = container.querySelector('input[name="projectName[]"]');
                const descriptionField = container.querySelector('textarea[name="projectDescription[]"]');
                const techField = container.querySelector('input[name="projectTechnologies[]"]');
                
                if (titleField && proj.title) titleField.value = proj.title;
                if (descriptionField && proj.description) descriptionField.value = proj.description;
                if (techField && proj.technologies && Array.isArray(proj.technologies)) {
                  techField.value = proj.technologies.join(', ');
                }
              }
            });
          }, 200);
        }
        
        // Certifications (convert array of objects to textarea)
        if (data.certifications && Array.isArray(data.certifications) && data.certifications.length > 0) {
          const certText = data.certifications.map(cert => {
            let line = cert.title || '';
            if (cert.issuer) line += ` - ${cert.issuer}`;
            if (cert.date) line += ` (${cert.date})`;
            return line;
          }).join('\n');
          const certField = document.getElementById('certifications');
          if (certField) certField.value = certText;
        }
        
        // Languages
        if (data.languages && Array.isArray(data.languages) && data.languages.length > 0) {
          const langField = document.getElementById('languages');
          if (langField) langField.value = data.languages.join(', ');
        }
        
        // Achievements
        if (data.achievements && Array.isArray(data.achievements) && data.achievements.length > 0) {
          const achievField = document.getElementById('achievements');
          if (achievField) achievField.value = data.achievements.join('\n');
        }
        
        // Hobbies
        if (data.hobbies && Array.isArray(data.hobbies) && data.hobbies.length > 0) {
          const hobbiesField = document.getElementById('hobbies');
          if (hobbiesField) hobbiesField.value = data.hobbies.join(', ');
        }
        
        console.log('âœ… Form auto-filled successfully');
        
      } catch (error) {
        console.error('âŒ Error filling form with imported data:', error);
        alert('Resume imported but some fields could not be auto-filled. Please review and complete the form manually.');
      }
    }

    // Add back button to return to template selection
    function addBackToTemplatesButton() {
      // Check if button already exists
      if (document.getElementById('backToTemplatesBtn')) return;
      
      const stepIndicator = document.getElementById('formStepIndicator');
      const backBtn = document.createElement('button');
      backBtn.id = 'backToTemplatesBtn';
      backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Change Template';
      backBtn.style.cssText = `
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(45,196,44,0.2);
        color: #2ae023;
        border: 2px solid #2ae023;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
      `;
      backBtn.onclick = () => {
        // Return to Step 1
        initializePage();
      };
      backBtn.onmouseenter = () => {
        backBtn.style.background = '#2ae023';
        backBtn.style.color = '#000';
      };
      backBtn.onmouseleave = () => {
        backBtn.style.background = 'rgba(45,196,44,0.2)';
        backBtn.style.color = '#2ae023';
      };
      
      stepIndicator.appendChild(backBtn);
    }

    // ----------  SECTION SKIP / SHOW  ----------
    function toggleSection(section) {
      const el = document.getElementById('section-' + section);
      if (!el) return;
      const link = el.querySelector('.skip-link');
      if (!link) return;

      const willBeSkipped = !el.classList.contains('skipped');
      el.classList.toggle('skipped', willBeSkipped);
      link.textContent = willBeSkipped ? 'Show section' : 'Skip this section';
      localStorage.setItem('skip_section_' + section, willBeSkipped);
    }

    // ----------  FIELD SKIP / SHOW  ----------
    function skipField(field) {
      const group   = document.getElementById('group-' + field);
      const input   = document.getElementById(field);
      if (!group || !input) return;

      const label   = group.querySelector('label');
      const skipSpan = label?.querySelector('.field-skip');
      if (!skipSpan) return;

      const willBeSkipped = !group.classList.contains('skipped');
      group.classList.toggle('skipped', willBeSkipped);
      skipSpan.textContent = willBeSkipped ? 'Show' : 'Skip';

      // ---- restore value when showing again ----
      if (!willBeSkipped) {
        const saved = localStorage.getItem('field_value_' + field);
        if (saved !== null) input.value = saved;
      } else {
        // save current value before hiding
        localStorage.setItem('field_value_' + field, input.value);
        input.value = '';
      }

      localStorage.setItem('skip_field_' + field, willBeSkipped);
    }

    // Add Experience / Education
    let expCount = 1, eduCount = 1;
    function addExperience() {
      expCount++;
      const container = document.getElementById('experienceContainer');
      const div = document.createElement('div');
      div.className = 'experience-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-row">
          <div class="form-group"><label>Job Title</label><input type="text" name="jobTitle[]" placeholder="Software Engineer"></div>
          <div class="form-group"><label>Company</label><input type="text" name="company[]" placeholder="Company Name"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Start Date</label><input type="month" name="startDate[]"></div>
          <div class="form-group"><label>End Date</label><input type="month" name="endDate[]"></div>
        </div>
        <div class="checkbox-container">
          <label>
            <input type="checkbox"> Currently working here
          </label>
        </div>
        <div class="form-group"><label>Description</label><textarea name="jobDescription[]" rows="4" placeholder="Key achievements..."></textarea></div>
      `;
      container.appendChild(div);
    }

    function addEducation() {
      eduCount++;
      const container = document.getElementById('educationContainer');
      const div = document.createElement('div');
      div.className = 'education-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-row">
          <div class="form-group"><label>Degree</label><input type="text" name="degree[]" placeholder="Bachelor of Science"></div>
          <div class="form-group"><label>School</label><input type="text" name="school[]" placeholder="University Name"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Year</label><input type="number" name="gradYear[]" min="1950" max="2030" placeholder="2024"></div>
          <div class="form-group"><label>GPA</label><input type="text" name="gpa[]" placeholder="3.8/4.0"></div>
        </div>
      `;
      container.appendChild(div);
    }

    // Add Reference
    let refCount = 1;
    function addReference() {
      refCount++;
      const container = document.getElementById('referencesContainer');
      const div = document.createElement('div');
      div.className = 'reference-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-row">
          <div class="form-group"><label>Reference Name</label><input type="text" name="refName[]" placeholder="John Smith"></div>
          <div class="form-group"><label>Title/Position</label><input type="text" name="refTitle[]" placeholder="Senior Manager"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Company</label><input type="text" name="refCompany[]" placeholder="Company Name"></div>
          <div class="form-group"><label>Phone</label><input type="tel" name="refPhone[]" placeholder="(555) 123-4567" pattern="[\+]?[\d\s\-\(\)\.]+" title="Please enter a valid phone number"></div>
        </div>
        <div class="form-group"><label>Email</label><input type="email" name="refEmail[]" placeholder="reference@company.com" title="Please enter a valid email address"></div>
      `;
      container.appendChild(div);
    }

    // Add Project
    let projectCount = 1;
    function addProject() {
      projectCount++;
      const container = document.getElementById('projectsContainer');
      const div = document.createElement('div');
      div.className = 'project-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-group">
          <label>Project Name <span class="required">*</span></label>
          <input type="text" name="projectName[]" placeholder="E-commerce Platform" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Technologies Used</label>
            <input type="text" name="projectTech[]" placeholder="React, Node.js, MongoDB">
          </div>
          <div class="form-group">
            <label>Duration/Year</label>
            <input type="text" name="projectDuration[]" placeholder="6 months or 2023">
          </div>
        </div>
        <div class="form-group">
          <label>Project Description</label>
          <textarea name="projectDescription[]" rows="4" placeholder="Describe what the project does, key features, and your role..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>GitHub/Deployment Link (Optional)</label>
            <input type="url" name="projectLink[]" placeholder="https://github.com/username/project">
          </div>
          <div class="form-group">
            <label>Key Achievement/Metrics (Optional)</label>
            <input type="text" name="projectAchievement[]" placeholder="10K+ users, 40% performance improvement">
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    // Add Custom Detail
    let customCount = 1;
    function addCustomDetail() {
      customCount++;
      const container = document.getElementById('customDetailsContainer');
      const div = document.createElement('div');
      div.className = 'custom-detail-item';
      div.innerHTML = `
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
        <div class="form-group"><label>Section Heading</label><input type="text" name="customHeading[]" placeholder="e.g., Publications, Volunteer Work, Awards"></div>
        <div class="form-group"><label>Content</label><textarea name="customContent[]" rows="4" placeholder="Describe the details for this section..."></textarea></div>
      `;
      container.appendChild(div);
    }

    // Fill Sample Data - Comprehensive function to populate all form fields
    function fillSampleData() {
      try {
        if (!confirm('This will fill the form with sample data. Any existing data will be overwritten. Continue?')) {
          return;
        }

        console.log('ðŸ”„ Starting to fill sample data...');

        // Personal Information
        const fullNameEl = document.getElementById('fullName');
        const emailEl = document.getElementById('email');
        const phoneEl = document.getElementById('phone');
        
        if (!fullNameEl || !emailEl || !phoneEl) {
          console.error('âŒ Required form elements not found');
          alert('Error: Form elements not found. Please refresh the page and try again.');
          return;
        }
        
        fullNameEl.value = 'Rahul Mehta';
        emailEl.value = 'rahulmehta.ds@example.com';
        phoneEl.value = '+91 9876543210';
        
        const addressEl = document.getElementById('address');
        const linkedinEl = document.getElementById('linkedin');
        const websiteEl = document.getElementById('website');
        
        if (addressEl) addressEl.value = 'Bengaluru, India';
        if (linkedinEl) linkedinEl.value = 'linkedin.com/in/rahulmehta-ds';
        if (websiteEl) websiteEl.value = 'github.com/rahulmehta-ds';
      
      // Professional Summary
      const summaryEl = document.getElementById('summary');
      if (summaryEl) {
        summaryEl.value = 'Data Scientist with 2+ years of experience in predictive modeling, machine learning, and data analytics. Skilled in analyzing complex datasets, building end-to-end ML models, and communicating insights to business teams. Strong expertise in Python, statistics, A/B testing, and data visualization. Passionate about solving business problems using data-driven approaches.';
      }
      
      // Technical Skills
      const technicalSkillsEl = document.getElementById('technicalSkills');
      if (technicalSkillsEl) {
        technicalSkillsEl.value = 'Python, R, SQL, Regression, Classification, Clustering, Random Forest, XGBoost, Neural Networks, TensorFlow, PyTorch, scikit-learn, Pandas, NumPy, Matplotlib, Seaborn, Tableau, A/B Testing, Statistical Analysis, Hypothesis Testing, Data Mining, Data Visualization, Feature Engineering';
      }
      
      // Soft Skills
      const softSkillsEl = document.getElementById('softSkills');
      if (softSkillsEl) {
        softSkillsEl.value = 'Problem-solving, Communication, Analytical Thinking, Business Acumen, Data-driven Decision Making';
      }
      
      // Certifications
      const certificationsEl = document.getElementById('certifications');
      if (certificationsEl) {
        certificationsEl.value = 'IBM Data Science\nGoogle Data Analytics Professional Certificate\nTensorFlow Developer Certificate';
      }
      
      // Languages
      const languagesEl = document.getElementById('languages');
      if (languagesEl) {
        languagesEl.value = 'English, Hindi, Telugu';
      }
      
      // Projects - Use new structured format
      const projectsSection = document.getElementById('section-projects');
      if (projectsSection && projectsSection.classList.contains('skipped')) {
        toggleSection('projects');
      }
      
      setTimeout(() => {
        const projectsContainer = document.getElementById('projectsContainer');
        if (projectsContainer) {
          projectsContainer.innerHTML = '';
          
          const sampleProjects = [
            {
              name: 'Customer Churn Prediction Model',
              tech: 'Python, scikit-learn, Pandas, NumPy, Matplotlib',
              duration: '3 months',
              description: 'Built an end-to-end ML pipeline achieving 86% accuracy. Performed EDA, feature engineering, and hyperparameter tuning.',
              link: 'https://github.com/rahulmehta-ds/churn-prediction',
              achievement: '86% accuracy, improved customer retention by 18%'
            },
            {
              name: 'Fraud Detection System',
              tech: 'Python, scikit-learn, Clustering, Anomaly Detection',
              duration: '4 months',
              description: 'Implemented anomaly detection using clustering + supervised models. Reduced false positives by 12%.',
              link: 'https://github.com/rahulmehta-ds/fraud-detection',
              achievement: '12% reduction in false positives, improved detection accuracy'
            }
          ];
          
          sampleProjects.forEach((project, index) => {
            if (index > 0) addProject();
            
            setTimeout(() => {
              const allNames = document.querySelectorAll('input[name="projectName[]"]');
              const allTechs = document.querySelectorAll('input[name="projectTech[]"]');
              const allDurations = document.querySelectorAll('input[name="projectDuration[]"]');
              const allDescriptions = document.querySelectorAll('textarea[name="projectDescription[]"]');
              const allLinks = document.querySelectorAll('input[name="projectLink[]"]');
              const allAchievements = document.querySelectorAll('input[name="projectAchievement[]"]');
              
              if (allNames[index]) allNames[index].value = project.name;
              if (allTechs[index]) allTechs[index].value = project.tech;
              if (allDurations[index]) allDurations[index].value = project.duration;
              if (allDescriptions[index]) allDescriptions[index].value = project.description;
              if (allLinks[index]) allLinks[index].value = project.link;
              if (allAchievements[index]) allAchievements[index].value = project.achievement;
            }, 150 * index);
          });
        }
      }, 300);
      
      // Achievements
      const achievementsEl = document.getElementById('achievements');
      if (achievementsEl) {
        achievementsEl.value = 'Improved customer churn prediction by 18% through ML models\nIncreased conversion rate by 6.5% through A/B testing frameworks\nBuilt predictive dashboards analyzing 50M+ rows of data';
      }
      
      // Hobbies
      const hobbiesEl = document.getElementById('hobbies');
      if (hobbiesEl) {
        hobbiesEl.value = 'Contributing to open-source data science projects, Reading research papers on ML, Participating in Kaggle competitions';
      }

      // Clear existing experience and add comprehensive sample
      const expContainer = document.getElementById('experienceContainer');
      expContainer.innerHTML = '';
      
      const experiences = [
        {
          title: 'Data Scientist',
          company: 'TechNova Analytics',
          start: '2023-01',
          end: '',
          current: true,
          description: 'â€¢ Analyzed large datasets (50M+ rows) to identify trends and build predictive dashboards\nâ€¢ Developed machine learning models (classification & regression) improving customer churn prediction by 18%\nâ€¢ Performed feature engineering, model tuning, and evaluation using precision, recall, and ROC-AUC\nâ€¢ Implemented A/B testing frameworks to measure product improvements; increased conversion rate by 6.5%\nâ€¢ Built visualization dashboards using Matplotlib, Seaborn, and Tableau to support decision-making'
        },
        {
          title: 'Junior Data Analyst',
          company: 'DataWings Pvt Ltd',
          start: '2021-08',
          end: '2022-12',
          current: false,
          description: 'â€¢ Conducted exploratory data analysis (EDA) and identified business insights\nâ€¢ Automated data cleaning and transformation pipelines using Python and SQL\nâ€¢ Contributed to clustering models for customer segmentation'
        }
      ];

      experiences.forEach((exp, index) => {
        if (index > 0) addExperience();
        
        setTimeout(() => {
          const allTitles = document.querySelectorAll('input[name="jobTitle[]"]');
          const allCompanies = document.querySelectorAll('input[name="company[]"]');
          const allStarts = document.querySelectorAll('input[name="startDate[]"]');
          const allEnds = document.querySelectorAll('input[name="endDate[]"]');
          const allDescriptions = document.querySelectorAll('textarea[name="jobDescription[]"]');
          
          if (allTitles[index]) allTitles[index].value = exp.title;
          if (allCompanies[index]) allCompanies[index].value = exp.company;
          if (allStarts[index]) allStarts[index].value = exp.start;
          if (allEnds[index] && !exp.current) allEnds[index].value = exp.end;
          if (allDescriptions[index]) allDescriptions[index].value = exp.description;
          
          // Handle "currently working" checkbox
          if (exp.current && allEnds[index]) {
            const checkbox = allEnds[index].parentElement.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = true;
          }
        }, 100 * index);
      });

      // Clear existing education and add comprehensive sample
      const eduContainer = document.getElementById('educationContainer');
      eduContainer.innerHTML = '';
      
      const education = [
        {
          degree: 'M.Sc. in Data Science',
          school: 'Christ University, Bengaluru',
          year: '2021',
          gpa: ''
        },
        {
          degree: 'B.Sc. in Computer Science',
          school: 'Osmania University, Hyderabad',
          year: '2019',
          gpa: ''
        }
      ];

      education.forEach((edu, index) => {
        if (index > 0) addEducation();
        
        setTimeout(() => {
          const allDegrees = document.querySelectorAll('input[name="degree[]"]');
          const allSchools = document.querySelectorAll('input[name="school[]"]');
          const allYears = document.querySelectorAll('input[name="gradYear[]"]');
          const allGPAs = document.querySelectorAll('input[name="gpa[]"]');
          
          if (allDegrees[index]) allDegrees[index].value = edu.degree;
          if (allSchools[index]) allSchools[index].value = edu.school;
          if (allYears[index]) allYears[index].value = edu.year;
          if (allGPAs[index]) allGPAs[index].value = edu.gpa;
        }, 100 * index);
      });

      // Add references (un-skip the section first if it's skipped)
      const refSection = document.getElementById('section-references');
      if (refSection && refSection.classList.contains('skipped')) {
        toggleSection('references');
      }

      setTimeout(() => {
        const refContainer = document.getElementById('referencesContainer');
        refContainer.innerHTML = '';
        
        const references = [
          {
            name: 'Dr. Michael Rodriguez',
            title: 'Engineering Director',
            company: 'TechCorp Solutions',
            phone: '+1 (555) 234-5678',
            email: 'michael.rodriguez@techcorp.com'
          },
          {
            name: 'Sarah Johnson',
            title: 'Senior Product Manager',
            company: 'Digital Innovations Inc.',
            phone: '+1 (555) 345-6789',
            email: 'sarah.johnson@digitalinnovations.com'
          }
        ];

        references.forEach((ref, index) => {
          if (index > 0) addReference();
          
          setTimeout(() => {
            const allNames = document.querySelectorAll('input[name="refName[]"]');
            const allTitles = document.querySelectorAll('input[name="refTitle[]"]');
            const allCompanies = document.querySelectorAll('input[name="refCompany[]"]');
            const allPhones = document.querySelectorAll('input[name="refPhone[]"]');
            const allEmails = document.querySelectorAll('input[name="refEmail[]"]');
            
            if (allNames[index]) allNames[index].value = ref.name;
            if (allTitles[index]) allTitles[index].value = ref.title;
            if (allCompanies[index]) allCompanies[index].value = ref.company;
            if (allPhones[index]) allPhones[index].value = ref.phone;
            if (allEmails[index]) allEmails[index].value = ref.email;
          }, 100 * index);
        });
      }, 500);

      // Add custom details (un-skip the section first if it's skipped)
      const customSection = document.getElementById('section-custom');
      if (customSection && customSection.classList.contains('skipped')) {
        toggleSection('custom');
      }

      setTimeout(() => {
        const customContainer = document.getElementById('customDetailsContainer');
        customContainer.innerHTML = '';
        
        const customDetails = [
          {
            heading: 'Publications & Speaking',
            content: '"Building Scalable Microservices" - TechBlog Monthly, March 2023\n"The Future of Cloud Architecture" - CloudCon Conference, June 2023\nGuest lecturer at UC Berkeley on Modern Web Development (2022-Present)'
          },
          {
            heading: 'Volunteer Work',
            content: 'Code for Good - Teaching coding to underprivileged youth (2020-Present)\nTech Mentorship Program - Mentoring women in tech transitioning to software engineering\nOpen Source Community - Regular contributor and maintainer of popular JavaScript libraries'
          }
        ];

        customDetails.forEach((detail, index) => {
          if (index > 0) addCustomDetail();
          
          setTimeout(() => {
            const allHeadings = document.querySelectorAll('input[name="customHeading[]"]');
            const allContents = document.querySelectorAll('textarea[name="customContent[]"]');
            
            if (allHeadings[index]) allHeadings[index].value = detail.heading;
            if (allContents[index]) allContents[index].value = detail.content;
          }, 100 * index);
        });
      }, 700);

      // Show success message
      setTimeout(() => {
        console.log('âœ… Sample data filled successfully');
        alert('âœ… Sample data has been loaded successfully!\n\nYou can now preview or generate your resume with any template to see how it looks with comprehensive data.');
        
        // Scroll to top of form
        const mainLayout = document.querySelector('.main-layout');
        if (mainLayout) {
          mainLayout.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 2000);
      
      } catch (error) {
        console.error('âŒ Error filling sample data:', error);
        alert('âŒ Error filling sample data: ' + error.message + '\n\nPlease check the browser console for details.');
      }
    }

    // Generate Resume with backend integration and animated loading page
    // Generate Resume with in-page animated loading overlay (no popup!)
    async function generateResume() {
      // Validate required fields
      let valid = true;
      let errors = [];
      
      const fullName = document.getElementById('fullName');
      if (!fullName.value.trim()) {
        fullName.style.borderColor = '#e53e3e';
        errors.push('Full name is required');
        valid = false;
      } else {
        fullName.style.borderColor = 'rgba(226,232,240,.25)';
      }
      
      const email = document.getElementById('email');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email.value.trim()) {
        email.style.borderColor = '#e53e3e';
        errors.push('Email is required');
        valid = false;
      } else if (!emailRegex.test(email.value.trim())) {
        email.style.borderColor = '#e53e3e';
        errors.push('Please enter a valid email address');
        valid = false;
      } else {
        email.style.borderColor = 'rgba(226,232,240,.25)';
      }
      
      const phone = document.getElementById('phone');
      const phoneRegex = /^[\+]?[\d\s\-\(\)\.]+$/;
      if (!phone.value.trim()) {
        phone.style.borderColor = '#e53e3e';
        errors.push('Phone number is required');
        valid = false;
      } else if (!phoneRegex.test(phone.value.trim())) {
        phone.style.borderColor = '#e53e3e';
        errors.push('Please enter a valid phone number');
        valid = false;
      } else {
        phone.style.borderColor = 'rgba(226,232,240,.25)';
      }
      
      if (!valid) {
        alert('Please fix the following errors:\nâ€¢ ' + errors.join('\nâ€¢ '));
        return;
      }

      if (!selectedTemplate) {
        selectedTemplate = localStorage.getItem('selectedTemplate');
      }

      if (!selectedTemplate) {
        alert('Please select a template first. Redirecting...');
        document.querySelector('.main-layout').style.display = 'none';
        document.querySelector('.bottom-actions').style.display = 'none';
        document.getElementById('formStepIndicator').style.display = 'none';
        document.getElementById('templateSelection').style.display = 'block';
        return;
      }

      const data = collectFormData();
      data.template = selectedTemplate;
      localStorage.setItem('resumeData', JSON.stringify(data));
      
      console.log('ðŸš€ Starting resume generation with in-page animation:', data);
      console.log('Backend URL:', BACKEND_URL);
      
      // Show beautiful loading overlay in same window (no popup!)
      const overlay = document.createElement('div');
      overlay.id = 'generationOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:100000;background:linear-gradient(135deg,#000501 0%,#2cc42c 100%);display:flex;align-items:center;justify-content:center;color:white;font-family:Inter,system-ui,sans-serif;';
      
      const userName = data.personalInfo?.fullName || 'resume';
      const templateName = data.template;
      
      overlay.innerHTML = `
        <div style="text-align:center;padding:40px;max-width:600px;">
          <div class="logo-container" style="width:250px;height:250px;margin:0 auto 40px;position:relative;">
            <div class="logo" style="width:100%;height:100%;background:rgba(0,0,0,0.7);border-radius:20px;padding:30px;backdrop-filter:blur(10px);box-shadow:0 20px 60px rgba(0,0,0,0.5);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;">
              <img src="logohiero.png" alt="Hiero Logo" class="logo-img" style="width:100%;height:100%;object-fit:contain;filter:drop-shadow(0px 4px 20px rgba(42,224,35,0.5));position:relative;z-index:2;">
            </div>
          </div>
          <h1 style="font-size:36px;margin-bottom:20px;font-weight:700;">Generating Your Resume</h1>
          <div id="overlayStatus" style="font-size:20px;color:#2ae023;margin-bottom:12px;font-weight:500;">Preparing ${templateName} template...</div>
          <div id="overlaySubstatus" style="font-size:16px;opacity:0.8;margin-bottom:35px;">This will only take a moment</div>
          <div style="width:100%;height:10px;background:rgba(255,255,255,0.15);border-radius:12px;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);">
            <div id="overlayProgressBar" style="height:100%;background:linear-gradient(90deg,#2ae023,#1a8b17);width:0%;transition:width 0.4s ease;box-shadow:0 0 20px rgba(42,224,35,0.6);"></div>
          </div>
          <div style="margin-top:20px;font-size:14px;opacity:0.6;">
            <i class="fas fa-spinner fa-spin"></i> Processing...
          </div>
        </div>
        <style>
          .logo::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(180deg, transparent 0%, rgba(42, 224, 35, 0.2) 100%);
            animation: fillLogo 3s ease-in-out infinite;
            z-index: 1;
            border-radius: 20px;
          }
          @keyframes fillLogo {
            0%   { height: 0%; }
            50%  { height: 100%; }
            100% { height: 0%; }
          }
        </style>
      `;
      
      document.body.appendChild(overlay);
      
      try {
        // Update progress stages
        const statusEl = document.getElementById('overlayStatus');
        const substatusEl = document.getElementById('overlaySubstatus');
        const progressBar = document.getElementById('overlayProgressBar');
        
        statusEl.textContent = 'Contacting server...';
        substatusEl.textContent = `Sending ${templateName} template request`;
        progressBar.style.width = '20%';
        
        await new Promise(resolve => setTimeout(resolve, 300)); // Brief delay for UX
        
        // Add timeout for ngrok (increased to 120 seconds)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
          console.error('â±ï¸ Request timeout after 120 seconds');
          statusEl.textContent = 'âŒ Request Timeout';
          statusEl.style.color = '#ff6b6b';
          substatusEl.textContent = 'The server took too long to respond. Please try again or check your connection.';
          progressBar.style.background = 'linear-gradient(90deg, #ff6b6b, #c92a2a)';
        }, 120000); // 120 seconds for ngrok
        
        const downloadUrl = BACKEND_URL + '/download-resume';
        console.log('ðŸ“¡ Generating resume at:', downloadUrl);
        console.log('ðŸ“¦ Request data:', { 
          template: data.template, 
          name: data.personalInfo?.fullName,
          dataSize: JSON.stringify(data).length 
        });
        
        // Test backend connectivity first
        try {
          const healthCheck = await fetch(BACKEND_URL + '/health', { 
            method: 'GET',
            mode: 'cors',
            cache: 'no-store'
          });
          if (healthCheck.ok) {
            console.log('âœ… Backend health check passed before download');
          } else {
            console.warn('âš ï¸ Backend health check returned:', healthCheck.status);
          }
        } catch (healthError) {
          console.error('âŒ Backend health check failed:', healthError.message);
          console.error('   This might indicate the backend is not accessible');
          throw new Error(`Backend server not accessible at ${BACKEND_URL}. Please check if the server is running.`);
        }
        
        const response = await fetch(downloadUrl, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/pdf'
          },
          body: JSON.stringify(data),
          signal: controller.signal,
          mode: 'cors',
          credentials: 'omit'
        });
        
        clearTimeout(timeoutId);
        
        progressBar.style.width = '50%';
        statusEl.textContent = 'Server processing...';
        substatusEl.textContent = 'Creating your PDF document';
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Server error:', errorText);
          throw new Error('Server error: ' + response.statusText);
        }
        
        // Check if response is actually PDF
        const contentType = response.headers.get('content-type');
        console.log('ðŸ“„ Response Content-Type:', contentType);
        
        if (!contentType || !contentType.includes('application/pdf')) {
          const text = await response.text();
          console.error('âŒ Response is not PDF! Content:', text.substring(0, 200));
          throw new Error('Server returned non-PDF response. Check console for details.');
        }
        
        const blob = await response.blob();
        console.log('âœ… PDF blob received, size:', blob.size, 'bytes');
        
        // Verify blob is actually PDF
        if (blob.size === 0) {
          throw new Error('Received empty PDF file');
        }
        
        // Check if blob type is correct
        if (!blob.type || !blob.type.includes('pdf')) {
          console.warn('âš ï¸ Blob type is not PDF:', blob.type);
          // Try to read first bytes to verify
          const firstBytes = await blob.slice(0, 4).text();
          console.log('First 4 bytes:', firstBytes);
          if (!firstBytes.includes('%PDF')) {
            throw new Error('File is not a valid PDF. Received: ' + blob.type);
          }
        }
        
        progressBar.style.width = '85%';
        statusEl.textContent = 'PDF ready!';
        substatusEl.textContent = 'Preparing download...';
        
        // Download the file with proper error handling
        try {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${userName.replace(/[^a-zA-Z0-9]/g, '_')}_${templateName}_resume.pdf`;
          a.style.display = 'none';
          document.body.appendChild(a);
          
          // Trigger download
          a.click();
          
          // Clean up after a short delay
          setTimeout(() => {
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          }, 100);
        } catch (downloadError) {
          console.error('âŒ Download error:', downloadError);
          throw new Error('Failed to trigger download: ' + downloadError.message);
        }
        
        progressBar.style.width = '100%';
        statusEl.textContent = 'âœ… Download Complete!';
        statusEl.style.color = '#2ae023';
        substatusEl.textContent = 'Check your downloads folder';
        
        // Success animation then close overlay
        setTimeout(() => {
          overlay.style.opacity = '0';
          overlay.style.transition = 'opacity 0.5s ease';
          setTimeout(() => {
            overlay.remove();
            alert('âœ… Resume downloaded successfully!\n\nFile: ' + a.download);
          }, 500);
        }, 1500);
        
      } catch (error) {
        console.error('âŒ Generation error:', error);
        console.error('âŒ Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack,
          backendUrl: BACKEND_URL,
          downloadUrl: BACKEND_URL + '/download-resume'
        });
        
        const statusEl = document.getElementById('overlayStatus');
        const substatusEl = document.getElementById('overlaySubstatus');
        const progressBar = document.getElementById('overlayProgressBar');
        
        statusEl.textContent = 'âŒ Generation Failed';
        statusEl.style.color = '#ff6b6b';
        progressBar.style.background = 'linear-gradient(90deg, #ff6b6b, #c92a2a)';
        
        if (error.name === 'AbortError') {
          substatusEl.textContent = 'âš ï¸ Request timed out - server took too long. This may be due to slow network or ngrok connection.';
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('ERR_CONNECTION_REFUSED')) {
          substatusEl.textContent = `âš ï¸ Cannot connect to backend at ${BACKEND_URL}. Check console for details.`;
          console.error('ðŸ” Connection troubleshooting:');
          console.error('   1. Is backend server running? Check: curl ' + BACKEND_URL + '/health');
          console.error('   2. Is CORS configured correctly?');
          console.error('   3. Is firewall blocking port 5003?');
          console.error('   4. If on another device, is BACKEND_URL correct?');
        } else if (error.message.includes('not accessible')) {
          substatusEl.textContent = error.message;
        } else {
          substatusEl.textContent = error.message || 'Unknown error occurred';
        }
        
        setTimeout(() => {
          overlay.remove();
          const errorMsg = error.name === 'AbortError' 
            ? 'Request timed out. The server took too long to respond. This may be due to:\nâ€¢ Slow network connection\nâ€¢ ngrok tunnel issues\nâ€¢ Server overload\n\nPlease try again or check your connection.'
            : `Failed to generate resume:\n\n${error.message}\n\nPlease ensure backend server is running on port 5003.`;
          alert('âŒ ' + errorMsg);
        }, 3000);
      }
    }

    function collectFormData() {
      const data = { personalInfo: {}, experience: [], education: [], references: [], customDetails: [] };

      // Personal
      data.personalInfo.fullName = document.getElementById('fullName').value;
      data.personalInfo.email = document.getElementById('email').value;
      data.personalInfo.phone = document.getElementById('phone').value;

      // Optional fields (only if not skipped and not empty)
      const optional = ['address','linkedin','website','summary','technicalSkills','softSkills','certifications','languages','achievements','hobbies'];
      optional.forEach(field => {
        const group = document.getElementById('group-' + field) || document.getElementById('section-' + field);
        const input = document.getElementById(field);
        if (group && !group.classList.contains('skipped') && input && input.value.trim()) {
          data[field] = input.value.trim();
        }
      });

      // Projects (structured data)
      const projectsSection = document.getElementById('section-projects');
      if (projectsSection && !projectsSection.classList.contains('skipped')) {
        data.projects = [];
        document.querySelectorAll('input[name="projectName[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            const project = {
              name: el.value.trim(),
              technologies: document.querySelectorAll('input[name="projectTech[]"]')[i]?.value || '',
              duration: document.querySelectorAll('input[name="projectDuration[]"]')[i]?.value || '',
              description: document.querySelectorAll('textarea[name="projectDescription[]"]')[i]?.value || '',
              link: document.querySelectorAll('input[name="projectLink[]"]')[i]?.value || '',
              achievement: document.querySelectorAll('input[name="projectAchievement[]"]')[i]?.value || ''
            };
            data.projects.push(project);
          }
        });
        // If no structured projects, fall back to old textarea format
        if (data.projects.length === 0) {
          const oldProjectsInput = document.getElementById('projects');
          if (oldProjectsInput && oldProjectsInput.value.trim()) {
            data.projects = oldProjectsInput.value.trim();
          }
        }
      } else {
        // Fallback to old textarea if section is skipped
        const oldProjectsInput = document.getElementById('projects');
        if (oldProjectsInput && oldProjectsInput.value.trim()) {
          data.projects = oldProjectsInput.value.trim();
        }
      }

      // Experience & Education
      document.querySelectorAll('input[name="jobTitle[]"]').forEach((el, i) => {
        if (el.value.trim()) {
          data.experience.push({
            jobTitle: el.value,
            company: document.querySelectorAll('input[name="company[]"]')[i].value,
            startDate: document.querySelectorAll('input[name="startDate[]"]')[i].value,
            endDate: document.querySelectorAll('input[name="endDate[]"]')[i].value,
            description: document.querySelectorAll('textarea[name="jobDescription[]"]')[i].value
          });
        }
      });

      document.querySelectorAll('input[name="degree[]"]').forEach((el, i) => {
        if (el.value.trim()) {
          data.education.push({
            degree: el.value,
            school: document.querySelectorAll('input[name="school[]"]')[i].value,
            gradYear: document.querySelectorAll('input[name="gradYear[]"]')[i].value,
            gpa: document.querySelectorAll('input[name="gpa[]"]')[i].value
          });
        }
      });

      // References (only if section is not skipped)
      const refSection = document.getElementById('section-references');
      if (refSection && !refSection.classList.contains('skipped')) {
        document.querySelectorAll('input[name="refName[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            data.references.push({
              name: el.value,
              title: document.querySelectorAll('input[name="refTitle[]"]')[i].value,
              company: document.querySelectorAll('input[name="refCompany[]"]')[i].value,
              phone: document.querySelectorAll('input[name="refPhone[]"]')[i].value,
              email: document.querySelectorAll('input[name="refEmail[]"]')[i].value
            });
          }
        });
      }

      // Custom Details (only if section is not skipped)
      const customSection = document.getElementById('section-custom');
      if (customSection && !customSection.classList.contains('skipped')) {
        document.querySelectorAll('input[name="customHeading[]"]').forEach((el, i) => {
          if (el.value.trim()) {
            data.customDetails.push({
              heading: el.value,
              content: document.querySelectorAll('textarea[name="customContent[]"]')[i].value
            });
          }
        });
      }

      return data;
    }

    function clearForm() {
      if(confirm('This will clear all form data and return to template selection. Continue?')) {
        localStorage.clear();
        location.reload();
      }
    }

    function editResume() {
      document.getElementById('resultsSection').style.display = 'none';
      document.querySelector('.main-layout').style.display = 'grid';
      document.querySelector('.bottom-actions').style.display = 'flex';
    }

    // Download and Preview with backend integration
    async function downloadResume() {
      const btn = event.target;
      const originalText = btn.innerHTML;
      
      // Show more informative loading message
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF... (this may take 5-10 seconds)';
      btn.disabled = true;

      try {
        const data = JSON.parse(localStorage.getItem('resumeData') || '{}');
        
        // Ensure template is included
        if (!data.template) {
          data.template = selectedTemplate || localStorage.getItem('selectedTemplate') || 'classic';
        }
        
        console.log('ðŸ“¡ POST', `${BACKEND_URL}/download-resume`);
        const response = await fetch(`${BACKEND_URL}/download-resume`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/pdf'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ Server error:', errorText);
          throw new Error(`Download failed: ${response.status} ${response.statusText}`);
        }

        // Check content type
        const contentType = response.headers.get('content-type');
        console.log('ðŸ“„ Response Content-Type:', contentType);
        
        if (!contentType || !contentType.includes('application/pdf')) {
          const text = await response.text();
          console.error('âŒ Response is not PDF!', text.substring(0, 200));
          throw new Error('Server returned non-PDF response');
        }

        const blob = await response.blob();
        console.log('âœ… PDF blob received, size:', blob.size, 'bytes, type:', blob.type);
        
        if (blob.size === 0) {
          throw new Error('Received empty PDF file');
        }
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${data.personalInfo?.fullName || 'resume'}_${data.template}_resume.pdf`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        }, 100);

      } catch (error) {
        console.error('Download error full:', error);
        alert(`Failed to download resume: ${error.message}. Please try again.`);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    async function previewResume() {
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Preview...';
      btn.disabled = true;

      try {
        const data = JSON.parse(localStorage.getItem('resumeData') || '{}');
        
        // Ensure template is included
        if (!data.template) {
          data.template = selectedTemplate || localStorage.getItem('selectedTemplate') || 'classic';
        }
        
        console.log('Previewing resume with template:', data.template);
        
        const response = await fetch(`${BACKEND_URL}/preview-resume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Preview failed' }));
          throw new Error(errorData.error || 'Preview failed');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        window.open(url, '_blank');
        
        // Clean up after a delay
        setTimeout(() => window.URL.revokeObjectURL(url), 1000);

      } catch (error) {
        console.error('Preview error:', error);
        alert(`Failed to preview resume: ${error.message}. Please try again.`);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>