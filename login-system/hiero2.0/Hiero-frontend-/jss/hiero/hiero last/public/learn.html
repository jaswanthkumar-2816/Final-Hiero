<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Learn Your Skill</title>
<script src="learn-redirect.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --soft-teal: #030e04;
  --lavender: #011104;
  --warm-beige: #09c006;
  --soft-green: #08c108;
  --gold-accent: #169f04;
  --bg-light: #060706;
  --card-bg: rgb(3, 3, 3);
  --text-dark: #333333;
  --shadow-glow: 0 0 15px rgb(17, 173, 17), 0 0 10px rgba(212, 160, 23, 0.3);
  --border-radius: 15px;
  --padding: 20px;
}
body {
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, var(--soft-teal) 0%, var(--lavender) 50%, var(--warm-beige) 100%);
  font-family: 'Open Sans', sans-serif;
  color: var(--text-dark);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-x: hidden;
  position: relative;
  animation: gradientFlow 20s ease infinite;
}
@keyframes gradientFlow {
  0% { background-position: 0% 0%; }
  50% { background-position: 50% 50%; }
  100% { background-position: 0% 0%; }
}
.hero {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  padding: 60px 30px;
  min-height: 100vh;
  position: relative;
  z-index: 1;
}
.logo-fixed {
  position: absolute;
  top: 25px;
  right: 32px;
  display: flex;
  align-items: center;
  z-index: 100;
  background: rgba(8, 164, 8, 0.805);
  border-radius: 12px;
  padding: 6px 16px 6px 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.959), var(--shadow-glow);
}
.logo-fixed img {
  height: 38px;
  width: 38px;
  min-width: 38px;
  min-height: 38px;
  object-fit: contain;
  filter: drop-shadow(var(--shadow-glow));
}
.logo-fixed span {
  font-weight: 700;
  letter-spacing: 1.5px;
  font-size: 1.2rem;
  margin-left: 6px;
  color: white;
}
h2 {
  font-family: 'Lora', serif;
  font-size: 2.2rem;
  color: var(--gold-accent);
  margin-bottom: 20px;
  animation: slideUp 2s ease-out;
  text-align: center;
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.main-container {
  max-width: 1000px;
  width: 100%;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 30px;
}
.card {
  background: var(--card-bg);
  border-radius: var(--border-radius);
  border: 1px solid rgba(241, 246, 241, 0.955);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), var(--shadow-glow);
  padding: var(--padding);
  display: flex;
  flex-direction: column;
  gap: 15px;
  min-height: 200px;
  animation: liftUp 2.5s ease-out infinite;
}
@keyframes liftUp {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}
.section-title {
  color: var(--soft-green);
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 15px;
  text-align: center;
}
.language-switcher {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
}
.language-btn {
  padding: 10px 20px;
  border: 2px solid var(--soft-green);
  background: transparent;
  color: var(--soft-green);
  border-radius: 25px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
  font-size: 1rem;
}
.language-btn:hover {
  background: var(--soft-green);
  color: var(--bg-light);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(8, 193, 8, 0.3);
}
.language-btn.active {
  background: var(--soft-green);
  color: var(--bg-light);
  box-shadow: 0 0 15px rgba(8, 193, 8, 0.4);
}
.video-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  min-height: 200px;
  opacity: 0;
  transition: opacity 0.5s ease-in-out;
  position: relative;
  z-index: 1;
}
.video-grid.visible {
  opacity: 1 !important;
  display: grid !important; /* Ensure grid is displayed */
  visibility: visible !important;
}

.video-embed-wrapper {
  position: relative;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  height: 0;
  overflow: hidden;
  border-radius: 8px;
  background: #000;
}

.video-embed-wrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}
.video-item {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid rgba(8, 193, 8, 0.2);
  transition: all 0.3s ease;
  animation: fadeIn 0.5s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.video-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 20px rgba(8, 193, 8, 0.3);
  border-color: var(--soft-green);
}
.video-item iframe {
  width: 100%;
  height: 150px;
  border: none;
  border-radius: 10px 10px 0 0;
}
.video-info {
  padding: 12px;
  text-align: center;
}
.video-title {
  color: var(--text-dark);
  font-size: 0.9rem;
  margin: 0 0 5px 0;
  font-weight: 500;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  line-clamp: 2;
  overflow: hidden;
  text-overflow: ellipsis;
}
.video-duration {
  color: var(--gold-accent);
  font-size: 0.8rem;
  font-weight: 600;
}
.video-item .btn {
  background: var(--soft-green);
  color: var(--bg-light);
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 10px;
}
.video-item .btn:hover {
  background: var(--gold-accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(22, 159, 4, 0.4);
}
.problems-section {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
.difficulty-header {
  font-size: 1.2rem;
  color: var(--gold-accent);
  font-weight: 600;
  margin: 10px 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
}
.difficulty-header::before {
  content: '‚ñ∂';
  transition: transform 0.3s ease;
}
.difficulty-header.collapsed::before {
  transform: rotate(90deg);
}
.problem-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 0;
  padding: 0;
  list-style: none;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
.problem-list.visible {
  max-height: 500px;
}
.problem-chip {
  background: rgba(23, 209, 6, 0.8);
  border-radius: var(--border-radius);
  color: var(--text-dark);
  font-size: 1rem;
  padding: 8px 16px;
  border: 1px solid var(--soft-green);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  cursor: pointer;
  transition: all 0.3s ease;
}
.problem-chip:hover {
  background: var(--soft-green);
  color: var(--bg-light);
  box-shadow: 0 4px 20px rgba(3, 215, 3, 0.6);
  transform: translateY(-2px);
}
.chatbot-section {
  display: flex;
  flex-direction: column;
  gap: 10px;
  height: 300px;
}
.chat-container {
  flex: 1;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  padding: 10px;
  overflow-y: auto;
  border: 1px solid rgba(8, 193, 8, 0.2);
}
.chat-message {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 8px;
  max-width: 80%;
  font-size: 0.9rem;
}
.chat-user {
  background: var(--soft-green);
  color: var(--bg-light);
  margin-left: auto;
  text-align: right;
}
.chat-bot {
  background: rgba(22, 159, 4, 0.2);
  color: var(--text-dark);
  margin-right: auto;
}
.chat-input-container {
  display: flex;
  gap: 10px;
}
.chat-input {
  flex: 1;
  padding: 10px;
  border: 1px solid var(--soft-green);
  border-radius: 8px;
  background: var(--bg-light);
  color: var(--text-dark);
  font-size: 0.9rem;
}
.chat-send-btn {
  background: var(--soft-green);
  color: var(--bg-light);
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}
.chat-send-btn:hover {
  background: var(--gold-accent);
  transform: translateY(-2px);
}
.loading-spinner {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: none;
  width: 40px;
  height: 40px;
  border: 4px solid var(--soft-green);
  border-top: 4px solid var(--gold-accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  z-index: 10;
}
.loading-spinner.active {
  display: block;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.back-btn {
  background: var(--soft-green);
  color: var(--bg-light);
  border: none;
  border-radius: var(--border-radius);
  padding: 12px 25px;
  font-size: 1.1rem;
  font-weight: 600;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1), var(--shadow-glow);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 20px;
}
.back-btn:hover {
  background: var(--gold-accent);
  color: var(--bg-light);
  box-shadow: 0 4px 20px rgba(212, 160, 23, 0.6);
  transform: translateY(-2px);
}
.error-message {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #dc3545;
  color: white;
  padding: 15px;
  border-radius: 8px;
  z-index: 1000;
  box-shadow: var(--shadow-glow);
  display: flex;
  gap: 10px;
  align-items: center;
}
.error-message button {
  background: transparent;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 1.2rem;
}
@media (max-width: 900px) {
  .main-container {
    padding: 0 15px;
  }
  .video-grid {
    grid-template-columns: 1fr;
  }
  .language-switcher {
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  }
  .chat-container {
    height: 200px;
  }
}
@media (max-width: 600px) {
  .logo-fixed {
    top: 50px;
    right: 10px;
    padding: 4px 10px 4px 4px;
  }
  .logo-fixed img {
    height: 24px !important;
    width: 24px !important;
    min-width: 24px !important;
    min-height: 24px !important;
  }
  .logo-fixed span {
    font-size: 0.9rem !important;
  }
  .card {
    min-height: 150px;
  }
  h2 {
    font-size: 1.8rem;
  }
  .video-item iframe {
    height: 120px;
  }
  .language-btn {
    font-size: 0.9rem;
    padding: 8px 16px;
  }
  .problem-chip {
    font-size: 0.9rem;
    padding: 6px 12px;
  }
}
</style>
</head>
<body>
<div class="logo-fixed">
  <img src="logohiero copy.png" alt="Hiero Logo" style="height: 38px; width: 38px; min-width: 38px; min-height: 38px; object-fit: contain; filter: drop-shadow(var(--shadow-glow));">
  <span style="font-weight: 700; letter-spacing: 1.5px; font-size: 1.2rem; margin-left: 6px;">HIERO</span>
</div>
<div class="hero">
  <h2 id="learn-title">Learn Your Skill</h2>
  <div class="main-container">
    <div class="card">
      <section aria-labelledby="video-title" style="position: relative;">
        <h3 class="section-title" id="video-title">üì∫ Video Tutorials</h3>
        <div class="language-switcher" id="language-switcher" role="tablist"></div>
        <div class="loading-spinner" id="loading-spinner"></div>
        <div class="video-grid" id="video-container"></div>
      </section>
    </div>
    <div class="card">
      <section class="problems-section" aria-labelledby="problems-title">
        <h3 class="section-title" id="problems-title">üß† Practice Problems</h3>
        <div id="easy-problems">
          <h4 class="difficulty-header" data-difficulty="easy">Easy</h4>
          <ul class="problem-list" id="easy-problem-list"></ul>
        </div>
        <div id="medium-problems">
          <h4 class="difficulty-header" data-difficulty="medium">Medium</h4>
          <ul class="problem-list" id="medium-problem-list"></ul>
        </div>
        <div id="hard-problems">
          <h4 class="difficulty-header" data-difficulty="hard">Hard</h4>
          <ul class="problem-list" id="hard-problem-list"></ul>
        </div>
      </section>
    </div>
    <div class="card">
      <section class="chatbot-section" aria-labelledby="chatbot-title">
        <h3 class="section-title" id="chatbot-title">üí¨ Ask for Help</h3>
        <div class="chat-container" id="chat-container" aria-live="polite"></div>
        <div class="chat-input-container">
          <input type="text" class="chat-input" id="chat-input" placeholder="Ask a question about this skill..." aria-label="Chat input">
          <button class="chat-send-btn" id="chat-send-btn" aria-label="Send chat message">Send</button>
        </div>
      </section>
    </div>
  </div>
  <button class="back-btn" onclick="window.location.href='result.html'" aria-label="Back to analysis results">üîô Back to Results</button>
</div>
<script>
function sanitize(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    skill: params.get('skill') || '',
    language: params.get('language')?.toLowerCase() || 'english'
  };
}

function setupLanguageSwitcher(skill, currentLanguage) {
  const languages = ['english', 'hindi', 'telugu', 'tamil', 'kannada'];
  const switcher = document.getElementById('language-switcher');
  switcher.innerHTML = '';
  languages.forEach(lang => {
    const btn = document.createElement('button');
    btn.className = `language-btn ${lang === currentLanguage ? 'active' : ''}`;
    btn.setAttribute('role', 'tab');
    btn.setAttribute('aria-selected', lang === currentLanguage);
    btn.setAttribute('aria-label', `Switch to ${lang} tutorials`);
    btn.textContent = lang.charAt(0).toUpperCase() + lang.slice(1);
    btn.onclick = () => {
      if (skill) {
        window.history.pushState({}, '', `learn.html?skill=${encodeURIComponent(skill)}&language=${encodeURIComponent(lang)}`);
        loadContent(skill, lang);
      } else {
        showError('No skill selected for learning.');
      }
    };
    switcher.appendChild(btn);
  });
}

function showProblemDetails(title, description, hint, difficulty = 'unknown') {
  const problemData = { title, description, hint, difficulty };
  try {
    localStorage.setItem('currentProblem', JSON.stringify(problemData));
    window.location.href = 'solve.html';
  } catch (error) {
    console.error('Error storing problem data:', error);
    const params = new URLSearchParams({ title, description, hint, difficulty });
    window.location.href = `solve.html?${params.toString()}`;
  }
}

function displayVideos({ videos, skill, language }) {
  const videoContainer = document.getElementById('video-container');
  if (!videoContainer) {
    console.error('‚ùå video-container element not found!');
    return;
  }
  
  console.log('üé• displayVideos called:', { videos, skill, language, videoCount: videos?.length });
  
  // Clear container and ensure it's visible
  videoContainer.innerHTML = '';
  videoContainer.style.display = 'grid'; // Use grid, not block
  videoContainer.classList.remove('visible'); // Remove visible class initially
  
  if (!videos || videos.length === 0) {
    console.warn('‚ö†Ô∏è No videos found for', skill, language);
    videoContainer.innerHTML = `<p style="text-align: center; padding: 20px; color: #fff; grid-column: 1 / -1;">No videos available for ${sanitize(skill)} in ${sanitize(language)}.</p>`;
    videoContainer.classList.add('visible');
    return;
  }
  
  videos.forEach((video, index) => {
    console.log(`üìπ Video ${index + 1}:`, { title: video.title, url: video.url });
    
    // Convert embed URL to watch URL for the button
    let watchUrl = video.url;
    if (video.url && video.url.includes('youtube.com/embed/')) {
      const videoId = video.url.split('youtube.com/embed/')[1]?.split('?')[0];
      watchUrl = videoId ? `https://www.youtube.com/watch?v=${videoId}` : video.url;
    } else if (video.watchUrl) {
      watchUrl = video.watchUrl;
    }
    
    const card = document.createElement('div');
    card.className = 'video-item';
    card.innerHTML = `
      <div class="video-info">
        <h3 class="video-title">${sanitize(video.title)}</h3>
        <div class="video-embed-wrapper">
          <iframe 
            src="${sanitize(video.url)}" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen 
            loading="lazy" 
            title="${sanitize(video.title)}"
            onerror="console.error('‚ùå Iframe load error for:', '${sanitize(video.title)}')"
            onload="console.log('‚úÖ Iframe loaded:', '${sanitize(video.title)}')"
          ></iframe>
        </div>
        <p class="video-duration">‚è± ${sanitize(video.duration)}</p>
        <button class="btn" onclick="window.open('${sanitize(watchUrl)}', '_blank')">Watch on YouTube</button>
      </div>
    `;
    videoContainer.appendChild(card);
  });
  
  // Add visible class to trigger fade-in via CSS
  requestAnimationFrame(() => {
    videoContainer.classList.add('visible');
    // Force visibility as a safety measure
    videoContainer.style.display = 'grid';
    videoContainer.style.opacity = '1';
    videoContainer.style.visibility = 'visible';
  });
  
  // Double-check after a short delay
  setTimeout(() => {
    const computed = window.getComputedStyle(videoContainer);
    console.log('‚úÖ Container final state:', { 
      display: computed.display, 
      opacity: computed.opacity,
      visibility: computed.visibility,
      hasVisibleClass: videoContainer.classList.contains('visible'),
      childCount: videoContainer.children.length
    });
    
    // If still not visible, force it
    if (computed.opacity === '0' || computed.visibility === 'hidden') {
      console.warn('‚ö†Ô∏è Container not visible, forcing visibility');
      videoContainer.style.display = 'grid';
      videoContainer.style.opacity = '1';
      videoContainer.style.visibility = 'visible';
    }
  }, 100);
  
  console.log('‚úÖ Videos displayed successfully:', videos.length, 'videos');
}

function setupProblemsSection(problems, skill) {
  const difficulties = ['easy', 'medium', 'hard'];
  difficulties.forEach(difficulty => {
    const problemList = document.getElementById(`${difficulty}-problem-list`);
    problemList.innerHTML = '';
    const problemData = problems[difficulty] || [];
    if (problemData.length === 0) {
      const li = document.createElement('li');
      li.textContent = `No ${difficulty} problems available.`;
      problemList.appendChild(li);
    } else {
      problemData.forEach(prob => {
        const li = document.createElement('li');
        li.className = 'problem-chip';
        li.setAttribute('role', 'button');
        li.setAttribute('aria-label', `View problem: ${prob.title}`);
        li.tabIndex = 0;
        li.textContent = sanitize(prob.title);
        li.onclick = () => showProblemDetails(sanitize(prob.title), sanitize(prob.description), sanitize(prob.hint), difficulty);
        li.onkeydown = (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showProblemDetails(sanitize(prob.title), sanitize(prob.description), sanitize(prob.hint), difficulty);
          }
        };
        problemList.appendChild(li);
      });
    }
    const header = document.querySelector(`[data-difficulty="${difficulty}"]`);
    header.classList.add('collapsed');
    header.onclick = () => {
      header.classList.toggle('collapsed');
      problemList.classList.toggle('visible');
    };
  });
}

async function sendChatMessage(message, skill) {
  const chatContainer = document.getElementById('chat-container');
  const userMessage = document.createElement('div');
  userMessage.className = 'chat-message chat-user';
  userMessage.textContent = sanitize(message);
  chatContainer.appendChild(userMessage);
  chatContainer.scrollTop = chatContainer.scrollHeight;

  const spinner = document.createElement('div');
  spinner.className = 'loading-spinner active';
  chatContainer.appendChild(spinner);

  try {
    const response = await fetch('/api/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question: message, skill })
    });
    const result = await response.json();
    spinner.remove();
    const botMessage = document.createElement('div');
    botMessage.className = 'chat-message chat-bot';
    botMessage.textContent = sanitize(result.answer || 'Sorry, I couldn‚Äôt process your question. Try again.');
    chatContainer.appendChild(botMessage);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  } catch (error) {
    spinner.remove();
    showError('Failed to get chatbot response. Please try again.');
  }
}

function showError(message) {
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error-message';
  errorDiv.innerHTML = `
    ${sanitize(message)}
    <button aria-label="Dismiss error">√ó</button>
  `;
  document.body.appendChild(errorDiv);
  errorDiv.querySelector('button').addEventListener('click', () => errorDiv.remove());
  setTimeout(() => errorDiv.remove(), 5000);
}

function generateFallbackProblems(skill) {
  const skillProblems = {
    'Python': {
      easy: [
        { id: 1, title: 'Hello World', description: 'Write a simple program to print "Hello World"', hint: 'Use the print() function' },
        { id: 2, title: 'Variables', description: 'Create variables for name, age, and city, then print them', hint: 'Use the assignment operator (=)' },
        { id: 3, title: 'Basic Math', description: 'Calculate the sum, product, and difference of two numbers', hint: 'Use +, *, and - operators' }
      ],
      medium: [
        { id: 4, title: 'FizzBuzz', description: 'Write a program that prints numbers 1-100, but for multiples of 3 print "Fizz", for 5 print "Buzz", for both print "FizzBuzz"', hint: 'Use loops and if-else statements' },
        { id: 5, title: 'List Operations', description: 'Create a list, add 5 numbers, find the max and min values', hint: 'Use list methods like append(), max(), and min()' },
        { id: 6, title: 'Dictionary', description: 'Create a dictionary storing student names and scores, then find the student with the highest score', hint: 'Use dictionary comprehension or loops' }
      ],
      hard: [
        { id: 7, title: 'Web Scraper', description: 'Write a program to scrape data from a website using BeautifulSoup', hint: 'Import requests and BeautifulSoup libraries' },
        { id: 8, title: 'Data Analysis', description: 'Read a CSV file and perform statistical analysis (mean, median, std dev)', hint: 'Use pandas and numpy libraries' },
        { id: 9, title: 'API Integration', description: 'Build a program that fetches data from a public API and processes it', hint: 'Use requests library to call APIs' }
      ]
    },
    'JavaScript': {
      easy: [
        { id: 1, title: 'Console Log', description: 'Write a JavaScript program to print values to the console', hint: 'Use console.log()' },
        { id: 2, title: 'Variables & Types', description: 'Create variables of different types (string, number, boolean) and log them', hint: 'Use let, const, or var' },
        { id: 3, title: 'String Operations', description: 'Concatenate strings and perform basic string operations', hint: 'Use + operator or template literals' }
      ],
      medium: [
        { id: 4, title: 'Array Methods', description: 'Use array methods like map(), filter(), and reduce()', hint: 'Array methods are powerful for data transformation' },
        { id: 5, title: 'Object Manipulation', description: 'Create objects and manipulate their properties dynamically', hint: 'Use bracket notation for dynamic keys' },
        { id: 6, title: 'DOM Manipulation', description: 'Select HTML elements and modify their content and styles', hint: 'Use document.querySelector() and .style property' }
      ],
      hard: [
        { id: 7, title: 'Async/Await', description: 'Write asynchronous code using async/await pattern', hint: 'Handle promises correctly' },
        { id: 8, title: 'REST API Client', description: 'Build a JavaScript client that calls REST APIs and handles responses', hint: 'Use fetch() API' },
        { id: 9, title: 'React Component', description: 'Build a functional React component with hooks', hint: 'Use useState and useEffect' }
      ]
    },
    'React': {
      easy: [
        { id: 1, title: 'Functional Component', description: 'Create a simple functional React component that displays text', hint: 'Return JSX from the function' },
        { id: 2, title: 'JSX Basics', description: 'Learn JSX syntax and render HTML-like code in JavaScript', hint: 'JSX looks like HTML but is JavaScript' },
        { id: 3, title: 'Props', description: 'Pass props to a component and display them', hint: 'Props are passed as function parameters' }
      ],
      medium: [
        { id: 4, title: 'useState Hook', description: 'Use the useState hook to manage component state', hint: 'Import useState from React' },
        { id: 5, title: 'useEffect Hook', description: 'Use useEffect to handle side effects in functional components', hint: 'useEffect runs after render' },
        { id: 6, title: 'Event Handling', description: 'Handle click events and form submissions in React', hint: 'Use camelCase for event names (onClick, onSubmit)' }
      ],
      hard: [
        { id: 7, title: 'Redux Integration', description: 'Integrate Redux for state management in a React application', hint: 'Use Redux actions and reducers' },
        { id: 8, title: 'Custom Hooks', description: 'Create custom hooks to reuse stateful logic across components', hint: 'Custom hooks start with "use"' },
        { id: 9, title: 'Performance Optimization', description: 'Optimize React component performance using memoization and code splitting', hint: 'Use React.memo and lazy loading' }
      ]
    }
  };

  const skillKey = Object.keys(skillProblems).find(key => 
    skill.toLowerCase().includes(key.toLowerCase()) || key.toLowerCase().includes(skill.toLowerCase())
  );

  if (skillKey) {
    return skillProblems[skillKey];
  }

  // Generic fallback for any skill
  return {
    easy: [
      { id: 1, title: `Learn ${skill} Basics`, description: `Understand the fundamental concepts of ${skill}`, hint: 'Start with the official documentation' },
      { id: 2, title: `${skill} Setup`, description: `Set up your environment to work with ${skill}`, hint: 'Follow installation guides' },
      { id: 3, title: `Hello ${skill}`, description: `Create your first program using ${skill}`, hint: 'Try simple examples first' }
    ],
    medium: [
      { id: 4, title: `${skill} Intermediate`, description: `Work on intermediate level problems with ${skill}`, hint: 'Build mini projects' },
      { id: 5, title: `${skill} Best Practices`, description: `Learn best practices for writing ${skill} code`, hint: 'Follow style guides' },
      { id: 6, title: `${skill} Performance`, description: `Understand performance considerations in ${skill}`, hint: 'Profile your code' }
    ],
    hard: [
      { id: 7, title: `Advanced ${skill}`, description: `Master advanced concepts in ${skill}`, hint: 'Read source code of popular libraries' },
      { id: 8, title: `${skill} Architecture`, description: `Design scalable systems using ${skill}`, hint: 'Study design patterns' },
      { id: 9, title: `${skill} Optimization`, description: `Optimize code and performance at scale`, hint: 'Benchmark and profile' }
    ]
  };
}

function generateFallbackVideos(skill) {
  const skillVideos = {
    'Python': {
      english: [
        { title: 'Python Basics - Getting Started', url: 'https://www.youtube.com/embed/kqtZrmDKwks', duration: '4:26', watchUrl: 'https://www.youtube.com/watch?v=kqtZrmDKwks' },
        { title: 'Python Tutorial for Beginners', url: 'https://www.youtube.com/embed/YYXdsTiUghM', duration: '3:27', watchUrl: 'https://www.youtube.com/watch?v=YYXdsTiUghM' },
        { title: 'Learn Python - Full Course', url: 'https://www.youtube.com/embed/_uQrJ0TkuMc', duration: '3:26', watchUrl: 'https://www.youtube.com/watch?v=_uQrJ0TkuMc' }
      ]
    },
    'JavaScript': {
      english: [
        { title: 'JavaScript Basics - Fundamentals', url: 'https://www.youtube.com/embed/DHvZLI7Db8E', duration: '1:27', watchUrl: 'https://www.youtube.com/watch?v=DHvZLI7Db8E' },
        { title: 'JavaScript Full Course for Beginners', url: 'https://www.youtube.com/embed/PkZNo7MFNFg', duration: '4:17', watchUrl: 'https://www.youtube.com/watch?v=PkZNo7MFNFg' },
        { title: 'JS ES6 Features Tutorial', url: 'https://www.youtube.com/embed/IQofiPqLJ_E', duration: '1:05', watchUrl: 'https://www.youtube.com/watch?v=IQofiPqLJ_E' }
      ]
    },
    'React': {
      english: [
        { title: 'React Tutorial for Beginners', url: 'https://www.youtube.com/embed/SqcY0GlETPk', duration: '1:57', watchUrl: 'https://www.youtube.com/watch?v=SqcY0GlETPk' },
        { title: 'React Hooks in 100 Seconds', url: 'https://www.youtube.com/embed/TNhaISOUy6Q', duration: '2:20', watchUrl: 'https://www.youtube.com/watch?v=TNhaISOUy6Q' },
        { title: 'React Course - Beginner Friendly', url: 'https://www.youtube.com/embed/Ke90Tje7VS0', duration: '1:43', watchUrl: 'https://www.youtube.com/watch?v=Ke90Tje7VS0' }
      ]
    }
  };

  const skillKey = Object.keys(skillVideos).find(key => 
    skill.toLowerCase().includes(key.toLowerCase()) || key.toLowerCase().includes(skill.toLowerCase())
  );

  if (skillKey) {
    return skillVideos[skillKey];
  }

  // Generic fallback for any skill
  return {
    english: [
      { title: `What is ${skill}?`, url: `https://www.youtube.com/embed/dQw4w9WgXcQ`, duration: '3:33', watchUrl: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ' },
      { title: `${skill} Tutorial`, url: `https://www.youtube.com/embed/dQw4w9WgXcQ`, duration: '5:00', watchUrl: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ' },
      { title: `Learn ${skill} in 10 Minutes`, url: `https://www.youtube.com/embed/dQw4w9WgXcQ`, duration: '10:00', watchUrl: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ' }
    ]
  };
}

async function fetchContentFromBackend(skill) {
  try {
    console.log('üîç fetchContentFromBackend called for skill:', skill);
    
    // Try localStorage first (from /api/analyze)
    const stored = localStorage.getItem('analysisResult');
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        console.log('üì¶ Checking localStorage for skill data:', skill);
        
        if (parsed.data?.videos?.[skill] && parsed.data?.problems?.[skill]) {
          console.log('‚úÖ Found data in localStorage for skill:', skill);
          return {
            videos: parsed.data.videos[skill],
            problems: parsed.data.problems[skill]
          };
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è Could not parse localStorage data:', e);
      }
    }
    
    // Fallback to /api/get-videos
    console.log('üì° Fetching from /api/get-videos for skill:', skill);
    
    // Add timeout for video fetch (30 seconds)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      controller.abort();
      console.warn('‚è±Ô∏è Video fetch timeout after 30 seconds');
    }, 30000);
    
    const response = await fetch('https://hiero-analysis-part.onrender.com/api/get-videos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ skill }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    console.log('üì• Response status:', response.status, response.statusText);
    console.log('üì• Response headers:', response.headers.get('content-type'));
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå Response not OK:', errorText);
      throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
    }
    
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const text = await response.text();
      console.error('‚ùå Response is not JSON:', text.substring(0, 200));
      throw new Error('Server returned non-JSON response');
    }
    
    const result = await response.json();
    console.log('‚úÖ Parsed response:', { success: result.success, hasData: !!result.data, hasVideos: !!result.data?.videos });
    
    if (result.success && result.data) {
      return result.data;
    }
    throw new Error(result.error || 'Failed to fetch content');
  } catch (error) {
    console.error('‚ùå Error fetching content:', error.message);
    
    // Check if it's a timeout
    if (error.name === 'AbortError') {
      console.warn('‚è±Ô∏è Video fetch timed out - showing fallback problems and videos');
    }
    
    // Generate fallback content based on skill
    const fallbackVideos = generateFallbackVideos(skill);
    const fallbackProblems = generateFallbackProblems(skill);
    
    console.log('üìö Using fallback content for skill:', skill);
    console.log('   Videos available:', Object.keys(fallbackVideos).length, 'language(s)');
    console.log('   Problems available:', Object.keys(fallbackProblems).length, 'difficulty levels');
    
    return {
      videos: fallbackVideos,
      problems: fallbackProblems
    };
  }
}

async function loadContent(skill, language) {
  try {
    const loadingSpinner = document.getElementById('loading-spinner');
    const videoContainer = document.getElementById('video-container');
    
    // Show loading, hide videos initially
    if (loadingSpinner) {
      loadingSpinner.classList.add('active');
      loadingSpinner.style.display = 'block';
    }
    if (videoContainer) {
      videoContainer.style.display = 'none';
      videoContainer.classList.remove('visible');
    }
    
    console.log('üîÑ Loading content for:', { skill, language });
    const { videos, problems } = await fetchContentFromBackend(skill);
    console.log('üì¶ Received data:', { 
      hasVideos: !!videos, 
      hasProblems: !!problems,
      videoLanguages: videos ? Object.keys(videos) : [],
      selectedLanguage: language,
      videosForLanguage: videos?.[language]?.length || videos?.english?.length || 0
    });
    
    // Hide loading spinner
    if (loadingSpinner) {
      loadingSpinner.classList.remove('active');
      loadingSpinner.style.display = 'none';
    }
    
    // Show video container
    if (videoContainer) {
      videoContainer.style.display = 'grid';
    }

    document.title = `Learn ${skill} in ${language} - HIERO`;
    const titleEl = document.getElementById('learn-title');
    if (titleEl) titleEl.textContent = `Learn ${skill} in ${language}`;
    
    setupLanguageSwitcher(skill, language);
    
    // Handle video data structure - could be nested or flat
    let videosForLanguage = [];
    if (videos) {
      if (videos[language] && Array.isArray(videos[language])) {
        videosForLanguage = videos[language];
      } else if (videos.english && Array.isArray(videos.english)) {
        videosForLanguage = videos.english;
      } else if (Array.isArray(videos)) {
        videosForLanguage = videos;
      } else if (typeof videos === 'object') {
        // Try to find any array in the videos object
        const langKeys = Object.keys(videos);
        for (const key of langKeys) {
          if (Array.isArray(videos[key]) && videos[key].length > 0) {
            videosForLanguage = videos[key];
            break;
          }
        }
      }
    }
    
    console.log('üé¨ Displaying videos:', videosForLanguage.length, 'videos for', language);
    console.log('üìä Videos structure:', { 
      hasVideos: !!videos, 
      videoKeys: videos ? Object.keys(videos) : [],
      videosForLanguageLength: videosForLanguage.length,
      firstVideo: videosForLanguage[0]
    });
    
    if (videosForLanguage && videosForLanguage.length > 0) {
      displayVideos({ videos: videosForLanguage, skill, language });
    } else {
      console.warn('‚ö†Ô∏è No videos found, showing fallback message');
      if (videoContainer) {
        videoContainer.innerHTML = `<p style="text-align: center; padding: 20px; color: #fff; grid-column: 1 / -1;">No videos available for ${skill} in ${language}. Please try selecting a different language or skill.</p>`;
        videoContainer.style.display = 'grid';
        videoContainer.classList.add('visible');
      }
    }
    
    setupProblemsSection(problems, skill);
  } catch (error) {
    console.error('‚ùå Error in loadContent:', error);
    const loadingSpinner = document.getElementById('loading-spinner');
    const videoContainer = document.getElementById('video-container');
    
    if (loadingSpinner) {
      loadingSpinner.classList.remove('active');
      loadingSpinner.style.display = 'none';
    }
    if (videoContainer) {
      videoContainer.style.display = 'block';
    }
    
    showError(`Failed to load ${skill} content. Please try again. Error: ${error.message}`);
  }
}

window.addEventListener('DOMContentLoaded', () => {
  const { skill, language } = getQueryParams();
  const validLanguages = ['english', 'hindi', 'telugu', 'tamil', 'kannada'];
  if (!skill || !validLanguages.includes(language)) {
    document.getElementById('learn-title').textContent = 'Invalid Skill or Language';
    showError('Please select a valid skill and language from the analysis results.');
    document.getElementById('language-switcher').style.display = 'none';
    document.getElementById('video-container').style.display = 'none';
    document.querySelector('.problems-section').style.display = 'none';
    document.querySelector('.chatbot-section').style.display = 'none';
    return;
  }

  loadContent(skill, language);

  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  chatSendBtn.addEventListener('click', () => {
    const message = chatInput.value.trim();
    if (message) {
      sendChatMessage(message, skill);
      chatInput.value = '';
    }
  });
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && chatInput.value.trim()) {
      sendChatMessage(chatInput.value.trim(), skill);
      chatInput.value = '';
    }
  });

  window.addEventListener('popstate', () => {
    const { skill, language } = getQueryParams();
    if (skill && validLanguages.includes(language)) {
      loadContent(skill, language);
    }
  });
});
</script>
</body>
</html>